<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Android å¤šçº¿ç¨‹ç¼–ç¨‹ï¼šIntentService & HandlerThread]]></title>
    <url>%2F2018%2F11%2F11%2FAndroid-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%EF%BC%9AIntentService-HandlerThread%2F</url>
    <content type="text"><![CDATA[å› ä¸º Android æ˜¯ä½¿ç”¨ Java å¼€å‘çš„ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬è°ˆåŠ Android ä¸­çš„å¤šçº¿ç¨‹ï¼Œå¿…ç„¶ç»•ä¸è¿‡ Java ä¸­çš„å¤šçº¿ç¨‹ç¼–ç¨‹ã€‚ä½†åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šè¿‡å¤šåœ°åˆ†æž Java ä¸­çš„å¤šçº¿ç¨‹ç¼–ç¨‹çš„çŸ¥è¯†ã€‚æˆ‘ä»¬ä¼šåœ¨ä»¥åŽåˆ†æž Java å¹¶å‘ç¼–ç¨‹çš„æ—¶å€™åˆ†æž Java ä¸­çš„å¤šçº¿ç¨‹ã€çº¿ç¨‹æ± å’Œå¹¶å‘ API çš„ç”¨æ³•ã€‚ æˆ‘ä»¬å…ˆæ¥æ€»ç»“ä¸€ä¸‹ Android å¤šçº¿ç¨‹ç¼–ç¨‹çš„æ¼”å˜è¿‡ç¨‹ï¼šé¦–å…ˆæ˜¯ Java çš„ Threadã€‚å› ä¸ºæœ¬èº«åœ¨åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å’Œé”€æ¯ä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ä¼šæœ‰ä¸€å®šçš„å¼€é”€ï¼Œå½“æˆ‘ä»¬ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ç›¸æ¯”äºŽè¿™ä¸ªå¼€é”€å¾ˆå°çš„æ—¶å€™ï¼Œå•ç‹¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å°±æ˜¾å¾—ä¸åˆ’ç®—ã€‚æ‰€ä»¥ï¼Œå½“ç¨‹åºä¸­å­˜åœ¨å¤§é‡çš„ã€å°çš„ä»»åŠ¡çš„æ—¶å€™ï¼Œå»ºè®®ä½¿ç”¨çº¿ç¨‹æ± æ¥è¿›è¡Œç®¡ç†ã€‚ä½†æˆ‘ä»¬ä¸€èˆ¬ä¹Ÿå¾ˆå°‘ä¸»åŠ¨åŽ»åˆ›å»ºçº¿ç¨‹æ± ï¼Œè¿™æ˜¯å› ä¸ºâ€”â€”ä¹Ÿè®¸æ˜¯è€ƒè™‘åˆ°å¼€å‘è€…è‡ªå·±åŽ»ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± æ¯”è¾ƒå¤æ‚â€”â€” Android ä¸­å·²ç»ä¸ºæˆ‘ä»¬è®¾è®¡äº† AsyncTaskã€‚AsyncTask å†…éƒ¨å°è£…äº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥æ‰§è¡Œè€—æ—¶æ¯”è¾ƒçŸ­çš„ä»»åŠ¡ã€‚ä½† AsyncTask ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼š1).å¦‚æžœä½ çš„ç¨‹åºä¸­å­˜åœ¨å¾ˆå¤šçš„ä¸åŒçš„ä»»åŠ¡çš„æ—¶å€™ï¼Œä½ å¯èƒ½è¦ä¸ºæ¯ä¸ªä»»åŠ¡å®šä¹‰ä¸€ä¸ª AsyncTask çš„å­ç±»ã€‚2).ä»Žå¼‚æ­¥çº¿ç¨‹åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹çš„æ–¹å¼ä¸å¦‚ RxJava ç®€æ´ã€‚æ‰€ä»¥ï¼Œåœ¨å®žé™…å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘é€šå¸¸ä½¿ç”¨ RxJava æ¥å®žçŽ°å¼‚æ­¥çš„ç¼–ç¨‹ã€‚å°¤å…¶æ˜¯å±€éƒ¨çš„ä¼˜åŒ–ã€ä¸å€¼å¾—ä¸“é—¨å®šä¹‰ä¸€ä¸ª AsyncTask ç±»çš„æ—¶å€™ï¼ŒRxJava ç”¨èµ·æ¥æ›´åŠ èˆ’æœã€‚ ä¸Šé¢çš„å¤šçº¿ç¨‹åˆ›å»ºçš„åªæ˜¯æ™®é€šçš„çº¿ç¨‹ï¼Œå¯¹ç³»ç»Ÿæ¥è¯´ï¼Œä¼˜å…ˆçº§æ¯”è¾ƒä½Žã€‚åœ¨ Android ä¸­è¿˜æä¾›äº† IntentService æ¥æ‰§è¡Œä¼˜å…ˆçº§ç›¸å¯¹è¾ƒé«˜çš„ä»»åŠ¡ã€‚å¯åŠ¨ä¸€ä¸ª IntentService ä»»åŠ¡çš„æ—¶å€™ä¼šå°†ä»»åŠ¡æ·»åŠ åˆ°å…¶å†…éƒ¨çš„ã€å¼‚æ­¥çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚æ­¤å¤–ï¼ŒIntentService åˆç»§æ‰¿è‡ª Serviceï¼Œæ‰€ä»¥è¿™è®©å®ƒå…·æœ‰å¼‚æ­¥å’Œè¾ƒé«˜çš„ä¼˜å…ˆçº§ä¸¤ä¸ªä¼˜åŠ¿ã€‚ åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»åˆ†æžè¿‡ AsyncTaskã€RxJava ä»¥åŠç”¨æ¥å®žçŽ°çº¿ç¨‹åˆ‡æ¢çš„ Handler. è¿™é‡Œå¥‰ä¸Šè¿™äº›æ–‡ç« çš„é“¾æŽ¥ï¼š ã€ŠAndroid AsyncTask æºç åˆ†æžã€‹ ã€ŠRxJava2 ç³»åˆ— (1)ï¼šä¸€ç¯‡çš„æ¯”è¾ƒå…¨é¢çš„ RxJava2 æ–¹æ³•æ€»ç»“ã€‹ ã€ŠRxJava2 ç³»åˆ— (2)ï¼šèƒŒåŽ‹å’ŒFlowableã€‹ ã€ŠRxJava2 ç³»åˆ— (3)ï¼šä½¿ç”¨ Subjectã€‹ ã€ŠAndroid æ¶ˆæ¯æœºåˆ¶ï¼šHandlerã€MessageQueue å’Œ Looperã€‹ ä½ å¯ä»¥é€šè¿‡ä»¥ä¸Šçš„æ–‡ç« æ¥äº†è§£è¿™éƒ¨åˆ†çš„å†…å®¹ã€‚åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æ¥æ¢³ç†ä¸‹å¦å¤–ä¸¤ä¸ªå¤šçº¿ç¨‹ç›¸å…³çš„ APIï¼ŒHandlerThread å’Œ IntentServiceã€‚ 1ã€å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ï¼šHandlerThreadå¦‚æžœä½ ä¹‹å‰è¿˜æ²¡æœ‰äº†è§£è¿‡ Handler çš„å®žçŽ°çš„è¯ï¼Œé‚£ä¹ˆæœ€å¥½é€šè¿‡æˆ‘ä»¬ä¸Šé¢çš„é‚£ç¯‡æ–‡ç«  ã€ŠAndroid æ¶ˆæ¯æœºåˆ¶ï¼šHandlerã€MessageQueue å’Œ Looperã€‹ äº†è§£ä¸€ä¸‹ã€‚å› ä¸º HandlerThread å°±æ˜¯é€šè¿‡å°è£…ä¸€ä¸ª Looper æ¥å®žçŽ°çš„ã€‚ 1.1 HandlerThread çš„ä½¿ç”¨HandlerThread ç»§æ‰¿è‡ªçº¿ç¨‹ç±» Threadï¼Œå†…éƒ¨åˆç»´æŠ¤äº†ä¸€ä¸ª Looperï¼ŒLooper å†…åˆç»´æŠ¤äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ HandlerThread æ¥åˆ›å»ºä¸€ä¸ªå¼‚æ­¥çš„çº¿ç¨‹ï¼Œç„¶åŽä¸æ–­å‘è¯¥çº¿ç¨‹å‘é€ä»»åŠ¡ã€‚è¿™äº›ä»»åŠ¡ä¼šè¢«å°è£…æˆæ¶ˆæ¯æ”¾è¿› HandlerThread çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¢«æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ HandlerThread æ¥åˆ›å»ºå¼‚æ­¥çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ åœ¨ä½¿ç”¨ HandlerThread çš„æ—¶å€™æœ‰ä¸¤ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š å› ä¸º HandlerThread å†…éƒ¨çš„ Looper çš„åˆå§‹åŒ–å’Œå¼€å¯å¾ªçŽ¯çš„è¿‡ç¨‹éƒ½åœ¨ run() æ–¹æ³•ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨ HandlerThread ä¹‹å‰ï¼Œä½ å¿…é¡»è°ƒç”¨å®ƒçš„ start() æ–¹æ³•ã€‚ å› ä¸º HandlerThread çš„ run() æ–¹æ³•ä½¿ç”¨ Looper å¼€å¯ä¸€ä¸ªäº†æ— é™å¾ªçŽ¯ï¼Œæ‰€ä»¥ï¼Œå½“ä¸å†ä½¿ç”¨å®ƒçš„æ—¶å€™ï¼Œåº”è¯¥è°ƒç”¨å®ƒçš„ quitSafely() æˆ– quit() æ–¹æ³•æ¥ç»“æŸè¯¥å¾ªçŽ¯ã€‚ åœ¨ä½¿ç”¨ HandlerThread çš„æ—¶å€™åªéœ€è¦åˆ›å»ºä¸€ä¸ªå®ƒçš„å®žä¾‹ï¼Œç„¶åŽä½¿ç”¨å®ƒçš„ Looper æ¥åˆ›å»º Handler å®žä¾‹ï¼Œå¹¶é€šè¿‡è¯¥ Handler å‘é€æ¶ˆæ¯æ¥å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ç¤ºä¾‹ï¼š myHandlerThread = new HandlerThread(&quot;MyHandlerThread&quot;); myHandlerThread.start(); handler = new Handler( myHandlerThread.getLooper() ){ @Override public void handleMessage(Message msg) { // ... do something } }; handler.sendEmptyMessage(1); è¿™é‡Œæˆ‘ä»¬åˆ›å»ºäº† HandlerThread å®žä¾‹ä¹‹åŽç”¨å®ƒæ¥åˆ›å»º Handler ç„¶åŽé€šè¿‡ Handler æŠŠä»»åŠ¡åŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿›è¡Œæ‰§è¡Œã€‚ æ˜¾ç„¶ï¼Œä½¿ç”¨ HandlerThread å¯ä»¥å¾ˆè½»æ¾åœ°å®žçŽ°ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚ä½ åªéœ€è¦åœ¨åˆ›å»ºäº† Handler ä¹‹åŽå‘å®ƒå‘é€æ¶ˆæ¯ï¼Œç„¶åŽæ‰€æœ‰çš„ä»»åŠ¡å°†è¢«åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚å½“ç„¶ï¼Œå®ƒä¹Ÿæœ‰ç¼ºç‚¹ã€‚å› ä¸ºæ‰€æœ‰çš„ä»»åŠ¡å°†ä¼šè¢«æŒ‰é¡ºåºæ‰§è¡Œï¼Œæ‰€ä»¥ä¸€æ—¦é˜Ÿåˆ—ä¸­æœ‰æŸä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´åŽç»­çš„ä»»åŠ¡éƒ½ä¼šè¢«å»¶è¿Ÿå¤„ç†ã€‚ 1.2 HandlerThread æºç è§£æžä¸‹é¢æ˜¯è¯¥ API çš„æºç ï¼Œå®žçŽ°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æŽ¥é€šè¿‡æ³¨é‡Šæ¥å¯¹ä¸»è¦éƒ¨åˆ†è¿›è¡Œè¯´æ˜Žï¼š public class HandlerThread extends Thread { int mPriority; int mTid = -1; Looper mLooper; private @Nullable Handler mHandler; public HandlerThread(String name) { super(name); mPriority = Process.THREAD_PRIORITY_DEFAULT; } protected void onLooperPrepared() { } // åœ¨è¿™ä¸ªæ–¹æ³•å¼€å¯äº† Looper å¾ªçŽ¯ï¼Œå› ä¸ºæ˜¯ä¸€ä¸ªæ— é™å¾ªçŽ¯ï¼Œæ‰€ä»¥ä¸é€‚ç”¨çš„æ—¶å€™åº”è¯¥å°†å…¶åœæ­¢ @Override public void run() { mTid = Process.myTid(); Looper.prepare(); synchronized (this) { mLooper = Looper.myLooper(); notifyAll(); } Process.setThreadPriority(mPriority); onLooperPrepared(); Looper.loop(); mTid = -1; } // èŽ·å–è¯¥ HandlerThread å¯¹åº”çš„ Looper public Looper getLooper() { if (!isAlive()) { return null; } synchronized (this) { while (isAlive() &amp;&amp; mLooper == null) { try { wait(); } catch (InterruptedException e) { } } } return mLooper; } public boolean quit() { Looper looper = getLooper(); if (looper != null) { looper.quit(); return true; } return false; } public boolean quitSafely() { Looper looper = getLooper(); if (looper != null) { looper.quitSafely(); return true; } return false; } // ... æ— å…³ä»£ç  } ä¸Šé¢çš„ä»£ç æ¯”è¾ƒç®€å•æ˜Žäº†ï¼Œåœ¨ run() æ–¹æ³•ä¸­åˆå§‹åŒ– Looper å¹¶æ‰§è¡Œã€‚å¦‚æžœ Looper è¿˜æ²¡æœ‰è¢«åˆ›å»ºï¼Œé‚£ä¹ˆå½“è°ƒç”¨ getLooper() æ–¹æ³•èŽ·å– Looper çš„æ—¶å€™ä¼šè®©çº¿ç¨‹é˜»å¡žã€‚å½“ Looper åˆ›å»ºå®Œæ¯•ä¹‹åŽä¼šå”¤é†’æ‰€æœ‰é˜»å¡žçš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚å¦å¤–ï¼Œå°±æ˜¯ä¸¤ä¸ªåœæ­¢ Looper çš„æ–¹æ³•ã€‚å®ƒä»¬åŸºæœ¬ä¸Šå°±æ˜¯å¯¹ Looper è¿›è¡Œäº†ä¸€å±‚å°è£…ã€‚ 2ã€IntentService2.1 ä½¿ç”¨ IntentServiceIntentService ç»§æ‰¿è‡ª Serivceï¼Œå› æ­¤å®ƒæ¯”æ™®é€šçš„å¤šçº¿ç¨‹ä»»åŠ¡ä¼˜å…ˆçº§è¦é«˜ã€‚è¿™ä½¿å¾—å®ƒç›¸æ¯”äºŽæ™®é€šçš„å¼‚æ­¥ä»»åŠ¡ä¸å®¹æ˜“è¢«ç³»ç»Ÿ kill æŽ‰ã€‚å®ƒå†…éƒ¨ä¹Ÿæ˜¯é€šè¿‡ä¸€ä¸ª Looper æ¥å®žçŽ°çš„ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ä¸€ç§æ¶ˆæ¯é˜Ÿåˆ—ã€‚åœ¨ç ”ç©¶å®ƒçš„æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å®ƒçš„ä½¿ç”¨ã€‚ IntentService çš„ä½¿ç”¨æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåªéœ€è¦ï¼š1).ç»§æ‰¿å®ƒå¹¶å®žçŽ°å…¶ä¸­çš„ onHandleIntent() æ–¹æ³•ï¼›2). å°† IntentService æ³¨å†Œåˆ° manifest ä¸­ï¼›3). åƒå¼€å¯ä¸€ä¸ªæ™®é€šçš„æœåŠ¡é‚£æ ·å¼€å¯ä¸€ä¸ª IntentService å³å¯ã€‚ä¸‹é¢æ˜¯è¯¥ç±»çš„ä¸€ä¸ªä½¿ç”¨ç¤ºä¾‹ï¼š public class FileRecognizeTask extends IntentService { public static void start(Context context) { Intent intent = new Intent(context, FileRecognizeTask.class); context.startService(intent); } public FileRecognizeTask() { super(&quot;FileRecognizeTask&quot;); } @Override protected void onHandleIntent(@androidx.annotation.Nullable @Nullable Intent intent) { // ä½ çš„éœ€è¦å¼‚æ­¥æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘ } } OKï¼Œä»‹ç»å®Œäº† IntentService çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬å†æ¥åˆ†æžä¸€ä¸‹å®ƒçš„æºç ã€‚ 2.2 IntentService æºç åˆ†æžå®žçŽ° IntentService çš„æ—¶å€™ä½¿ç”¨åˆ°äº†æˆ‘ä»¬ä¸Šé¢åˆ†æžè¿‡çš„ HandlerThread. é¦–å…ˆï¼Œåœ¨ onCreate() å›žè°ƒæ–¹æ³•ä¸­åˆ›å»ºäº†ä¸€ä¸ª HandlerThreadï¼Œç„¶åŽä½¿ç”¨å®ƒçš„ Looper åˆ›å»ºäº†ä¸€ä¸ª ServiceHandlerï¼š HandlerThread thread = new HandlerThread(&quot;IntentService[&quot; + mName + &quot;]&quot;); thread.start(); mServiceLooper = thread.getLooper(); mServiceHandler = new ServiceHandler(mServiceLooper); ServiceHandler æ˜¯ IntentSerice çš„å†…éƒ¨ç±»ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š private final class ServiceHandler extends Handler { public ServiceHandler(Looper looper) { super(looper); } @Override public void handleMessage(Message msg) { onHandleIntent((Intent)msg.obj); stopSelf(msg.arg1); } } ServiceHandler ç”¨æ¥æ‰§è¡Œè¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚å®ƒä¼šå›žè°ƒ IntentService ä¸­çš„ onHandleIntent() æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å®žçŽ°ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³•ã€‚å½“æ¶ˆæ¯æ‰§è¡Œå®Œæ¯•ä¹‹åŽï¼Œä¼šè°ƒç”¨ Service çš„ stopSelf(int) æ–¹æ³•æ¥å°è¯•åœæ­¢æœåŠ¡ã€‚æ³¨æ„è¿™é‡Œè°ƒç”¨çš„æ˜¯ stopSelf(int) è€Œä¸æ˜¯ stopSelf()ã€‚å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«æ˜¯ï¼Œå½“è¿˜å­˜åœ¨æ²¡æœ‰å®Œæˆçš„ä»»åŠ¡çš„æ—¶å€™ stopSelf(int) ä¸ä¼šç«‹å³åœæ­¢æœåŠ¡ï¼Œè€Œ stopSelf() æ–¹æ³•ä¼šç«‹å³åœæ­¢æœåŠ¡ã€‚ IntentSerivce çš„ onCreate() æ–¹æ³•ä¼šåœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œæ¥åˆ›å»ºæœåŠ¡ã€‚è€Œ onStartCommond() æ–¹æ³•ä¼šåœ¨æ¯æ¬¡å¯åŠ¨çš„æ—¶å€™è¢«è°ƒç”¨ã€‚ä¸‹é¢æ˜¯è¯¥æ–¹æ³•çš„å®šä¹‰ã€‚ @Override public void onStart(@Nullable Intent intent, int startId) { Message msg = mServiceHandler.obtainMessage(); msg.arg1 = startId; msg.obj = intent; mServiceHandler.sendMessage(msg); } @Override public int onStartCommand(@Nullable Intent intent, int flags, int startId) { onStart(intent, startId); return mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY; } onStartCommand() å†…éƒ¨è°ƒç”¨äº† onStart() æ¥å¤„ç†è¯·æ±‚ã€‚åœ¨ onStart() æ–¹æ³•ä¸­ä¼šé€šè¿‡ mServiceHandler åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯ï¼Œå¹¶å°†è¯¥æ¶ˆæ¯å‘é€ç»™ mServiceHandler. è¯¥æ¶ˆæ¯ä¼šåœ¨è¢« mServiceHandler æ”¾è¿›æ¶ˆæ¯é˜Ÿåˆ—ä¸­æŽ’é˜Ÿï¼Œå¹¶åœ¨åˆé€‚çš„æ—¶æœºè¢«æ‰§è¡Œã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ä¸€ä¸‹ IntentService çš„å·¥ä½œè¿‡ç¨‹ï¼šé¦–å…ˆï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡å¯åŠ¨ IntentService çš„æ—¶å€™ä¼šåˆå§‹åŒ–ä¸€ä¸ª Looper å’Œ Handlerï¼›ç„¶åŽè°ƒç”¨å®ƒçš„ onStartCommond() æ–¹æ³•ï¼ŒæŠŠè¯·æ±‚åŒ…è£…æˆæ¶ˆæ¯ä¹‹åŽå‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œï¼›å½“æ¶ˆæ¯è¢« Handler å¤„ç†çš„æ—¶å€™ä¼šå›žè°ƒ IntentService çš„ onHandleIntent() æ–¹æ³•æ¥æ‰§è¡Œã€‚æ­¤æ—¶ï¼Œå¦‚æžœåˆæœ‰ä¸€ä¸ªä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œé‚£ä¹ˆ IntentService çš„ onStartCommond() æ–¹æ³•ä¼šå†æ¬¡è¢«æ‰§è¡Œå¹¶æŠŠè¯·æ±‚å°è£…ä¹‹åŽæ”¾å…¥é˜Ÿåˆ—ä¸­ã€‚å½“é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰çš„æ¶ˆæ¯éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶ä¸”æ²¡æœ‰æ–°åŠ å…¥çš„è¯·æ±‚ï¼Œé‚£ä¹ˆæ­¤æ—¶æœåŠ¡å°±ä¼šè‡ªåŠ¨åœæ­¢ï¼Œå¦åˆ™æœåŠ¡è¿˜ä¼šç»§ç»­åœ¨åŽå°æ‰§è¡Œã€‚ è¿™é‡Œï¼ŒåŒæ ·ä¹Ÿåº”è¯¥æ³¨æ„ä¸‹ï¼ŒIntentService ä¸­çš„ä»»åŠ¡æ˜¯æŒ‰ç…§è¢«æ·»åŠ çš„é¡ºåºæ¥æ‰§è¡Œçš„ã€‚ æ€»ç»“ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬å¯¹ IntentService å’Œ HandlerThread çš„åˆ†æžã€‚å®ƒä»¬éƒ½æ˜¯ä½¿ç”¨äº† Handler æ¥å®žçŽ°ï¼Œæ‰€ä»¥æžæ‡‚å®ƒä»¬çš„å‰ææ˜¯æžæ‡‚ Handlerã€‚å…³äºŽ Handlerï¼Œè¿˜æ˜¯æŽ¨èä¸€ä¸‹ç¬”è€…çš„å¦ä¸€ç¯‡æ–‡ç«  ã€ŠAndroid æ¶ˆæ¯æœºåˆ¶ï¼šHandlerã€MessageQueue å’Œ Looperã€‹ã€‚ æˆ‘æ˜¯ WngShhng. å¦‚æžœæ‚¨å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œå¯ä»¥åœ¨ä»¥ä¸‹å¹³å°å…³æ³¨æˆ‘ï¼š ä¸ªäººä¸»é¡µï¼šhttps://shouheng88.github.io/ æŽ˜é‡‘ï¼šhttps://juejin.im/user/585555e11b69e6006c907a2a Githubï¼šhttps://github.com/Shouheng88 CSDNï¼šhttps://blog.csdn.net/github_35186068 å¾®åšï¼šhttps://weibo.com/u/5401152113]]></content>
      <categories>
        <category>Androidé«˜é˜¶ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è¿ç§»åˆ° AndroidX è¿‡ç¨‹ä¸­é‡åˆ°çš„å„ç§é—®é¢˜]]></title>
    <url>%2F2018%2F11%2F11%2F%E8%BF%81%E7%A7%BB%E5%88%B0-AndroidX-%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E5%90%84%E7%A7%8D%E9%97%AE%E9%A2%98%2F</url>
    <content type="text"><![CDATA[è¯¥åšæ–‡ç”¨æ¥æ•´ç†å¼€æºé¡¹ç›® Android-References è¿ç§»åˆ° AndroidX è¿‡ç¨‹ä¸­é‡åˆ°çš„å„ç§é—®é¢˜ã€‚ ðŸ‘ Android-References æ˜¯ä¸€ä¸ª Android ç¤ºä¾‹ç¨‹åºé¡¹ç›®ï¼šåŒ…å«äº† MVP, MVVM, ç»„ä»¶åŒ–, ARouter, RxJava, EventBus, ButterKnife, è§†é¢‘æ’­æ”¾, è§†é¢‘ç›´æ’­, ç½‘ç»œè®¿é—®, å¸ƒå±€å’ŒæŽ§ä»¶æ•´ç†ç­‰ï¼Œæ„Ÿæ€§å´å¯ä»¥åˆ° Gihubï¼šhttps://github.com/Shouheng88/Android-references å‚è€ƒæºç ã€‚ å› ä¸ºè¯¥é¡¹ç›®åŒ…å«äº†å„ç§ support åŒ…æŽ§ä»¶ï¼Œå¹¶ä¸”å„ç§ç»„ä»¶åŒ–ã€æž¶æž„æ¨¡å¼å’Œå„ç§å¸¸è§çš„åŠŸèƒ½ä¸€åº”ä¿±å…¨ï¼Œå› æ­¤ï¼Œæ¯”è¾ƒå…·æœ‰ä»£è¡¨æ€§ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å®ƒæ¥ä½œä¸ºä¸€ä¸ªç¤ºä¾‹æ¥å°†æˆ‘ä»¬çš„é¡¹ç›®è¿ç§»åˆ° AndroidXã€‚ 1ã€å…³äºŽ AndroidXå…³äºŽ AndroidXï¼Œå¯ä»¥å‚è€ƒ: Hello world AndroidX AndroidX ç”¨æ¥ç»Ÿä¸€ Android ä¸­çš„ support åŒ…ï¼Œä¹‹å‰æˆ‘ä»¬é€šè¿‡å¼•å…¥ support åŒ…çš„å„ä¸ªç‰ˆæœ¬æ¥ä½¿ç”¨æ”¯æŒåŒ…ï¼ŒçŽ°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ AndroidX æ¥ä½¿ç”¨æ”¯æŒåŒ…ã€‚ä»Žé•¿è¿œæ¥çœ‹è¿™å½“ç„¶æ˜¯å¤§æœ‰å¥½å¤„çš„ï¼Œå¯ä»¥é¿å…ä½¿ç”¨æ”¯æŒåŒ…ä¸­é‡åˆ°çš„ç‰ˆæœ¬å†²çªã€å‡çº§å¸¦æ¥çš„å„ç§é—®é¢˜ã€‚ ä¸è¿‡ï¼Œå¦‚æžœé¡¹ç›®å®Œå…¨è¿ç§»åˆ° AndroidX é£Žé™©è¿˜æ˜¯å¤ªå¤§ã€‚å¦‚æžœé¡¹ç›®ç´§æ€¥çš„è¯ï¼Œå¼•å…¥ AndroidX æˆæœ¬éƒ½æœ‰äº›é«˜ï¼Œä¸»è¦æ˜¯å› ä¸ºä¸€äº›ä¸‰æ–¹åº“çš„åŽŸå› ã€‚è™½ç„¶ä¸€äº›ä½¿ç”¨ç‰¹åˆ«å¤šçš„ä¸‰æ–¹åº“ï¼Œæ¯”å¦‚ Glide ç­‰éƒ½å·²ç»å¼€å§‹æ”¯æŒ AndroidXã€‚å½“ç„¶ï¼Œè¿˜æœ‰ä¸€äº›æ½œåœ¨çš„é—®é¢˜ï¼Œæ¯”å¦‚ä½¿ç”¨å­—ç¬¦ä¸²æ¥èŽ·å–ç±»çš„ Behavior ç­‰ï¼Œè¿ç§»çš„æ—¶å€™å¯èƒ½å°±ä¸ä¼šè¢«ç…§é¡¾åˆ°ã€‚ ä¸ºäº†è¿ç§»åˆ° AndroidXï¼ŒGoogle ç»™å¼€å‘è€…æä¾›äº†ä¸€ä¸ªå·¥å…·ï¼šåœ¨ AS çš„ Refactor ä¸­æä¾›äº†ä¸€é¡¹ Migrate to AndroidX çš„é€‰é¡¹ã€‚ä½†é€‰æ‹©äº†è¿ç§»ä¹‹åŽï¼Œå‡ºçŽ°ä¸€äº›é—®é¢˜è¿˜éœ€è¦å¼€å‘è€…è‡ªå·±æ‰‹åŠ¨è§£å†³ã€‚ 2ã€ç€æ‰‹è¿ç§»2.1 ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šExecution failed for task â€˜:app:transformClassesWithMultidexlistForAlphaDebugâ€™è¿™é‡Œæˆ‘ä»¬è¿ç§»ä¹‹åŽåœ¨ build çš„æ—¶å€™å‡ºçŽ°äº†æ ‡é¢˜çš„é—®é¢˜ï¼š 123* What went wrong:Execution failed for task &apos;:app:transformClassesWithMultidexlistForAlphaDebug&apos;.&gt; com.android.build.api.transform.TransformException: Error while generating the main dex list. æ˜¾ç„¶æ˜¯å°† class è½¬æ¢æˆ dex çš„è¿‡ç¨‹ä¸­å‡ºçŽ°äº†ä¸€äº›é—®é¢˜ï¼Œä¸è¿‡åªæ˜¯ä¸Šé¢çš„è¿™è¡Œæ—¥å¿—æˆ‘ä»¬æ— æ³•å®šä½é—®é¢˜ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦è®© gradle è¾“å‡ºæ›´å¤šçš„é”™è¯¯ä¿¡æ¯ï¼ŒäºŽæ˜¯æˆ‘ä»¬æ‰§è¡Œï¼š 1gradlew build --stacktrace æ¥è®© Gradle è¾“å‡ºé”™è¯¯æ ˆä¿¡æ¯ï¼š 12345Caused by: com.android.builder.multidex.D8MainDexList$MainDexListException: com.android.tools.r8.errors.CompilationError: Program type already present: com.alibaba.android.arouter.routes.ARouter$$Group$$library at com.android.builder.multidex.D8MainDexList.generate(D8MainDexList.java:87) at com.android.build.gradle.internal.transforms.D8MainDexListTransform.transform(D8MainDexListTransform.kt:131) ... 54 more æ˜¾ç„¶æ˜¯ ARouter$$Group$$library ç±»çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨ Ctrl+N æ¥æœç´¢è¿™ä¸ªç±»ï¼Œå‘çŽ°å‡ºçŽ°äº†ä¸¤ä¸ªåŒæ ·çš„ç±»ã€‚è¿™ä¸ªç±»æ˜¯ä½¿ç”¨é˜¿é‡Œçš„ ARouter çš„æ—¶å€™åœ¨ç¼–è¯‘æœŸé—´ç”Ÿæˆçš„ï¼š æŒ‰ç…§ä¸Šé¢çš„é”™è¯¯æç¤ºï¼Œè¯¥ç±»åŒæ—¶å‡ºçŽ°åœ¨äº†æˆ‘ä»¬çš„ä¸¤ä¸ªæ¨¡å— libraries å’Œ layout ä¸‹é¢ï¼Œå› è€Œç±»å†²çªäº†ã€‚æ‰€ä»¥ï¼ŒæŽ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯è¦å‘çŽ°ä¸ºä»€ä¹ˆä¼šå‡ºçŽ°ç±»å†²çªã€‚ ç»è¿‡ä¸€å±‚å±‚æŽ’æŸ¥å‘çŽ°æ˜¯ä¸€ä¸ªåœ°æ–¹å†™é”™äº†ï¼š è¿™ä¸ªæ˜¯ layout æ¨¡å—ä¸‹é¢çš„å†²çªçš„ç±»ï¼Œæˆ‘ä»¬å‘çŽ°å®ƒçš„è·¯ç”±åœ°å€æ˜¯ /library/swipe_backï¼Œæ‰€ä»¥å› ä¸ºè·¯ç”±çš„åœ°å€æ˜¯ library çš„åŽŸå› å®ƒåœ¨ layout çš„æ¨¡å—ä¸‹é¢ç”Ÿæˆäº† ARouter$$Group$$Libraryã€‚æŒ‰ç…§æ­£ç¡®çš„å†™æ³•å®ƒåº”è¯¥æ˜¯å‡ºçŽ°åœ¨ layout æ¨¡å—ä¸‹é¢ï¼Œå¹¶ä¸”è·¯ç”±çš„åœ°å€æ˜¯ /layout/swipe_backï¼Œé‚£æ ·å°±åº”è¯¥è¢«ç”Ÿæˆåˆ° ARouter$$Group$$Layout ä¸‹é¢ï¼Œå°±ä¸ä¼šå¤šå‡ºä¸€ä¸ªç±» ARouter$$Group$$Library äº†ã€‚ è™½ç„¶ï¼Œæœ€ç»ˆé—®é¢˜çš„åŽŸå› å¾ˆç®€å•ï¼Œä½†æ˜¯æˆ‘ä»¬çœ‹åˆ°ï¼Œå‘çŽ°é—®é¢˜çš„è¿‡ç¨‹ä¸­éœ€è¦è‡ªå·±æœ‰æ€è·¯çš„åŽ»æŽ’æŸ¥ï¼Œè€Œä¸æ˜¯é™¤äº†é—®é¢˜ç«‹åˆ» Google æˆ–è€… SOFã€‚ 2.2 android.view.InflateException: Binary XML file line #14: Error inflating classä¿®æ”¹äº†ä¸Šé¢çš„é—®é¢˜ä¹‹åŽï¼Œæˆ‘ä»¬çš„ç¨‹åºå¯ä»¥ç¼–è¯‘å¹¶ä¸”å®‰è£…äº†ã€‚ ç„¶åŽï¼Œæˆ‘ä»¬åˆé‡åˆ°ä¸‹é¢çš„é—®é¢˜ï¼š 1android.view.InflateException: Binary XML file line #14: Error inflating class è¿™ç§é—®é¢˜æ¯”è¾ƒå¸¸è§ï¼Œæ˜¯ XML çš„æŸä¸ªåœ°æ–¹å†™é”™äº†ï¼Œç»è¿‡æŽ’æŸ¥å‘çŽ°æœ‰ä¸€è¡Œä»£ç ï¼Œå½“æˆ‘ä»¬ä¸ºæŽ§ä»¶æ·»åŠ  Behavior çš„æ—¶å€™ä½¿ç”¨äº†å­—ç¬¦ä¸²å½¢å¼çš„ç±»åã€‚åœ¨è¿ç§»çš„æ—¶å€™æ²¡æœ‰è¢«ç…§é¡¾åˆ°ï¼š äº‹å®žä¸Šåœ¨ Google çš„æ–°çš„ material åŒ…ä¸‹é¢çš„ values.xml æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€äº› Behaviorï¼Œæ–°çš„åŒ…ä¸­è¿™äº›å­—ç¬¦ä¸²çš„å€¼å·²ç»è¢«æ›¿æ¢è¿‡ã€‚ä½†æ˜¯åƒæˆ‘ä»¬ä¸Šé¢çš„è¿™ç§æƒ…å†µï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯å­—ç¬¦ä¸²è€Œä¸æ˜¯å¼•ç”¨çš„èµ„æºï¼Œæ‰€ä»¥å°±æ²¡æœ‰è¢«æ›¿æ¢è¿‡åŽ»ã€‚å› æ­¤ï¼Œå¼•ç”¨éžè‡ªå®šä¹‰çš„ Behavior çš„æ—¶å€™éœ€è¦æ³¨æ„ä½¿ç”¨å­—ç¬¦ä¸²èµ„æºè¿›è¡Œå¼•ç”¨è€Œä¸æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²ï¼š 2.3 android.view.InflateException: Binary XML file line #12: Binary XML file line #12: Error inflating class com.google.android.material.button.MaterialButtonè¿™é‡Œçš„ç±» Support28Activity ç”¨æ¥æ•´ç†åŽŸæ¥çš„ support-28 åŒ…é‡Œé¢çš„ä¸€äº›æŽ§ä»¶ï¼Œè¿ç§»ä¹‹åŽé¡µé¢æ‰“å¼€çš„æ—¶å€™ç«‹å³å´©æºƒã€‚ç„¶åŽç•™ä¸‹äº†ä¸€åœ°é¸¡æ¯›ï¼ˆå¼‚å¸¸ï¼‰ï¼š 1java.lang.RuntimeException: Unable to start activity ComponentInfo&#123;me.shouheng.references/me.shouheng.layout.view.support28.Support28Activity&#125;: android.view.InflateException: Binary XML file line #12: Binary XML file line #12: Error inflating class com.google.android.material.button.MaterialButton æˆ‘ä»¬å°è¯•åœ¨ç¨‹åºä¸­å¯»æ‰¾ MaterialButtonï¼Œå‘çŽ°ç¡®å®žèƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªç±»ï¼Œä½†è¿™é‡ŒåŠ è½½å¤±è´¥æ˜¯ä»€ä¹ˆåŽŸå› å‘¢ï¼Ÿ äºŽæ˜¯æˆ‘ä»¬ç»§ç»­æŸ¥çœ‹è¾“å‡ºçš„é”™è¯¯æ—¥å¿—ï¼Œä»Žè¿™é‡Œæˆ‘ä»¬èŽ·å–åˆ°äº†æ›´å¤šçš„ä¿¡æ¯ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152 Process: me.shouheng.references, PID: 22961 java.lang.RuntimeException: Unable to start activity ComponentInfo&#123;me.shouheng.references/me.shouheng.layout.view.support28.Support28Activity&#125;: android.view.InflateException: Binary XML file line #12: Binary XML file line #12: Error inflating class com.google.android.material.button.MaterialButton at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:3037) at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3172) at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:78) at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:108) at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:68) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1906) at android.os.Handler.dispatchMessage(Handler.java:106) at android.os.Looper.loop(Looper.java:193) at android.app.ActivityThread.main(ActivityThread.java:6863) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:537) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858) Caused by: android.view.InflateException: Binary XML file line #12: Binary XML file line #12: Error inflating class com.google.android.material.button.MaterialButton Caused by: android.view.InflateException: Binary XML file line #12: Error inflating class com.google.android.material.button.MaterialButton Caused by: java.lang.reflect.InvocationTargetException at java.lang.reflect.Constructor.newInstance0(Native Method) at java.lang.reflect.Constructor.newInstance(Constructor.java:343) at android.view.LayoutInflater.createView(LayoutInflater.java:647) at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:790) at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:730) at android.view.LayoutInflater.rInflate(LayoutInflater.java:863) at android.view.LayoutInflater.rInflateChildren(LayoutInflater.java:824) at android.view.LayoutInflater.inflate(LayoutInflater.java:515) at android.view.LayoutInflater.inflate(LayoutInflater.java:423) at androidx.databinding.DataBindingUtil.inflate(DataBindingUtil.java:126) at androidx.databinding.DataBindingUtil.inflate(DataBindingUtil.java:95) at me.shouheng.commons.view.activity.CommonActivity.onCreate(CommonActivity.java:41) at android.app.Activity.performCreate(Activity.java:7149) at android.app.Activity.performCreate(Activity.java:7140) at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1288) at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:3017) at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3172) at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:78) at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:108) at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:68) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1906) at android.os.Handler.dispatchMessage(Handler.java:106) at android.os.Looper.loop(Looper.java:193) at android.app.ActivityThread.main(ActivityThread.java:6863) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:537) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858) Caused by: java.lang.IllegalArgumentException: The style on this component requires your app theme to be Theme.MaterialComponents (or a descendant). at com.google.android.material.internal.ThemeEnforcement.checkTheme(ThemeEnforcement.java:240) at com.google.android.material.internal.ThemeEnforcement.checkMaterialTheme(ThemeEnforcement.java:215) at com.google.android.material.internal.ThemeEnforcement.checkCompatibleTheme(ThemeEnforcement.java:143)2018-11-10 15:21:55.948 22961-22961/me.shouheng.references E/AndroidRuntime: at com.google.android.material.internal.ThemeEnforcement.obtainStyledAttributes(ThemeEnforcement.java:78) at com.google.android.material.button.MaterialButton.&lt;init&gt;(MaterialButton.java:140) at com.google.android.material.button.MaterialButton.&lt;init&gt;(MaterialButton.java:133) ... 27 more æŒ‰ç…§åŽé¢å‡ è¡Œçš„æ„æ€ï¼š 1Caused by: java.lang.IllegalArgumentException: The style on this component requires your app theme to be Theme.MaterialComponents (or a descendant). è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸ºæˆ‘ä»¬è®¾ç½®çš„ä¸»é¢˜ç…§æˆçš„ã€‚æŒ‰ç…§ä¸Šé¢çš„æ„æ€ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°è‡ªå·±çš„æŽ§ä»¶çš„ä¸»é¢˜åˆ° Theme.MaterialComponentsã€‚é™¤äº†åˆ‡æ¢æŽ§ä»¶çš„ä¸»é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°åº”ç”¨çš„ä¸»é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥è®©è‡ªå·±çš„åº”ç”¨ä¸»é¢˜ç»§æ‰¿ Material Components Bridge ä¸»é¢˜ï¼š 123&lt;style name=&quot;Theme.MyApp&quot; parent=&quot;Theme.MaterialComponents.Light.Bridge&quot;&gt; &lt;!-- ... --&gt;&lt;/style&gt; å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦é€‰æ‹©ç»§æ‰¿ä¸‹é¢çš„å‡ ç§ä¸»é¢˜ï¼š 12345Theme.MaterialComponents.BridgeTheme.MaterialComponents.Light.BridgeTheme.MaterialComponents.NoActionBar.BridgeTheme.MaterialComponents.Light.NoActionBar.BridgeTheme.MaterialComponents.Light.DarkActionBar.Bridge æˆ–è€…åœ¨ä½ ä¹‹å‰çš„ AppCompact ä¸»é¢˜ä¹‹ä¸Šå¢žåŠ ä¸€äº›æ–°çš„å±žæ€§ï¼š 123456789101112131415161718192021222324252627282930313233&lt;style name=&quot;Theme.MyApp&quot; parent=&quot;Theme.AppCompat&quot;&gt; &lt;!-- Original AppCompat attributes. --&gt; &lt;item name=&quot;colorPrimary&quot;&gt;@color/my_app_primary_color&lt;/item&gt; &lt;item name=&quot;colorSecondary&quot;&gt;@color/my_app_secondary_color&lt;/item&gt; &lt;item name=&quot;android:colorBackground&quot;&gt;@color/my_app_background_color&lt;/item&gt; &lt;item name=&quot;colorError&quot;&gt;@color/my_app_error_color&lt;/item&gt; &lt;!-- New MaterialComponents attributes. --&gt; &lt;item name=&quot;colorPrimaryVariant&quot;&gt;@color/my_app_primary_variant_color&lt;/item&gt; &lt;item name=&quot;colorSecondaryVariant&quot;&gt;@color/my_app_secondary_variant_color&lt;/item&gt; &lt;item name=&quot;colorSurface&quot;&gt;@color/my_app_surface_color&lt;/item&gt; &lt;item name=&quot;colorOnPrimary&quot;&gt;@color/my_app_color_on_primary&lt;/item&gt; &lt;item name=&quot;colorOnSecondary&quot;&gt;@color/my_app_color_on_secondary&lt;/item&gt; &lt;item name=&quot;colorOnBackground&quot;&gt;@color/my_app_color_on_background&lt;/item&gt; &lt;item name=&quot;colorOnError&quot;&gt;@color/my_app_color_on_error&lt;/item&gt; &lt;item name=&quot;colorOnSurface&quot;&gt;@color/my_app_color_on_surface&lt;/item&gt; &lt;item name=&quot;scrimBackground&quot;&gt;@color/mtrl_scrim_color&lt;/item&gt; &lt;item name=&quot;textAppearanceHeadline1&quot;&gt;@style/TextAppearance.MaterialComponents.Headline1&lt;/item&gt; &lt;item name=&quot;textAppearanceHeadline2&quot;&gt;@style/TextAppearance.MaterialComponents.Headline2&lt;/item&gt; &lt;item name=&quot;textAppearanceHeadline3&quot;&gt;@style/TextAppearance.MaterialComponents.Headline3&lt;/item&gt; &lt;item name=&quot;textAppearanceHeadline4&quot;&gt;@style/TextAppearance.MaterialComponents.Headline4&lt;/item&gt; &lt;item name=&quot;textAppearanceHeadline5&quot;&gt;@style/TextAppearance.MaterialComponents.Headline5&lt;/item&gt; &lt;item name=&quot;textAppearanceHeadline6&quot;&gt;@style/TextAppearance.MaterialComponents.Headline6&lt;/item&gt; &lt;item name=&quot;textAppearanceSubtitle1&quot;&gt;@style/TextAppearance.MaterialComponents.Subtitle1&lt;/item&gt; &lt;item name=&quot;textAppearanceSubtitle2&quot;&gt;@style/TextAppearance.MaterialComponents.Subtitle2&lt;/item&gt; &lt;item name=&quot;textAppearanceBody1&quot;&gt;@style/TextAppearance.MaterialComponents.Body1&lt;/item&gt; &lt;item name=&quot;textAppearanceBody2&quot;&gt;@style/TextAppearance.MaterialComponents.Body2&lt;/item&gt; &lt;item name=&quot;textAppearanceCaption&quot;&gt;@style/TextAppearance.MaterialComponents.Caption&lt;/item&gt; &lt;item name=&quot;textAppearanceButton&quot;&gt;@style/TextAppearance.MaterialComponents.Button&lt;/item&gt; &lt;item name=&quot;textAppearanceOverline&quot;&gt;@style/TextAppearance.MaterialComponents.Overline&lt;/item&gt;&lt;/style&gt; æ˜¾ç„¶ï¼Œè¿™é‡Œæ˜¯è¦æ±‚ä½ ä¸ºäº†ä½¿è‡ªå·±çš„åº”ç”¨ç¬¦åˆ Material è§„èŒƒï¼Œéœ€è¦é¢„å…ˆå®šä¹‰ä¸€äº›å±žæ€§å€¼ï¼Œç„¶åŽä¼šè¢«åº”ç”¨åˆ°ç¨‹åºçš„æŽ§ä»¶ä¸­ã€‚ è¿™é‡Œæˆ‘ä»¬å°†ä¸»é¢˜ç¨åšä¿®æ”¹ 123&lt;!--&lt;style name=&quot;AppTheme&quot; parent=&quot;Theme.AppCompat.Light.NoActionBar&quot;&gt;--&gt;&lt;style name=&quot;AppTheme&quot; parent=&quot;Theme.MaterialComponents.Light.NoActionBar.Bridge&quot;&gt;&lt;/style&gt; æŒ‰ç…§ä¸Šé¢çš„æ–¹å¼ï¼Œæˆ‘ä»¬æˆåŠŸåœ°æ‰“å¼€äº†è¯¥é¡µé¢ã€‚ 2.4 java.lang.IllegalArgumentException: Invalid Region.Op - only INTERSECT and DIFFERENCE are allowedç„¶è€Œæ‰“å¼€äº†é¡µé¢ä¸ä¹…å°±åˆå‘çŽ°äº†é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜å‡ºçŽ°åœ¨ MaterialButton çš„ç‚¹å‡»çš„æ—¶å€™ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556Process: me.shouheng.references, PID: 5730java.lang.IllegalArgumentException: Invalid Region.Op - only INTERSECT and DIFFERENCE are allowed at android.graphics.Canvas.checkValidClipOp(Canvas.java:779) at android.graphics.Canvas.clipRect(Canvas.java:826) at com.google.android.material.shape.MaterialShapeDrawable.prepareCanvasForShadow(MaterialShapeDrawable.java:850) at com.google.android.material.shape.MaterialShapeDrawable.draw(MaterialShapeDrawable.java:746) at android.view.View.getDrawableRenderNode(View.java:20622) at android.view.View.drawBackground(View.java:20558) at android.view.View.draw(View.java:20357) at android.view.View.updateDisplayListIfDirty(View.java:19241) at android.view.View.draw(View.java:20094) at android.view.ViewGroup.drawChild(ViewGroup.java:4337) at androidx.coordinatorlayout.widget.CoordinatorLayout.drawChild(CoordinatorLayout.java:1246) at android.view.ViewGroup.dispatchDraw(ViewGroup.java:4116) at android.view.View.updateDisplayListIfDirty(View.java:19232) at android.view.View.draw(View.java:20094) at android.view.ViewGroup.drawChild(ViewGroup.java:4337) at android.view.ViewGroup.dispatchDraw(ViewGroup.java:4116) at android.view.View.updateDisplayListIfDirty(View.java:19232) at android.view.View.draw(View.java:20094) at android.view.ViewGroup.drawChild(ViewGroup.java:4337) at android.view.ViewGroup.dispatchDraw(ViewGroup.java:4116) at android.view.View.updateDisplayListIfDirty(View.java:19232) at android.view.View.draw(View.java:20094) at android.view.ViewGroup.drawChild(ViewGroup.java:4337) at android.view.ViewGroup.dispatchDraw(ViewGroup.java:4116) at android.view.View.updateDisplayListIfDirty(View.java:19232) at android.view.View.draw(View.java:20094) at android.view.ViewGroup.drawChild(ViewGroup.java:4337) at android.view.ViewGroup.dispatchDraw(ViewGroup.java:4116) at android.view.View.updateDisplayListIfDirty(View.java:19232) at android.view.View.draw(View.java:20094) at android.view.ViewGroup.drawChild(ViewGroup.java:4337) at android.view.ViewGroup.dispatchDraw(ViewGroup.java:4116) at android.view.View.draw(View.java:20369) at com.android.internal.policy.DecorView.draw(DecorView.java:781) at android.view.View.updateDisplayListIfDirty(View.java:19241) at android.view.ThreadedRenderer.updateViewTreeDisplayList(ThreadedRenderer.java:690) at android.view.ThreadedRenderer.updateRootDisplayList(ThreadedRenderer.java:696) at android.view.ThreadedRenderer.draw(ThreadedRenderer.java:805) at android.view.ViewRootImpl.draw(ViewRootImpl.java:3515) at android.view.ViewRootImpl.performDraw(ViewRootImpl.java:3312) at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:2681) at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:1633) at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:7786) at android.view.Choreographer$CallbackRecord.run(Choreographer.java:1004) at android.view.Choreographer.doCallbacks(Choreographer.java:816) at android.view.Choreographer.doFrame(Choreographer.java:751) at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:990) at android.os.Handler.handleCallback(Handler.java:873) at android.os.Handler.dispatchMessage(Handler.java:99) at android.os.Looper.loop(Looper.java:193) at android.app.ActivityThread.main(ActivityThread.java:6863) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:537) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858) ç»è¿‡æŽ’æŸ¥å‘çŽ°ï¼Œåœ¨ com.google.android.material.shape.MaterialShapeDrawable ä¸­çš„ prepareCanvasForShadow() æ–¹æ³•ä¸­ä½¿ç”¨äº† Region.Op.REPLACEï¼Œ 12345private void prepareCanvasForShadow(Canvas canvas) &#123; // ... æ— å…³ä»£ç  canvas.clipRect(canvasClipBounds, Region.Op.REPLACE); // ... æ— å…³ä»£ç &#125; è€Œåœ¨ support-28 ä¸­å¢žåŠ äº†ä¸‹é¢çš„æ ¡éªŒï¼ˆè¿™ä¸ªæ ¡éªŒåœ¨ support-27 ä¸Šé¢æ˜¯ä¸å­˜åœ¨çš„ï¼‰ï¼Œæ˜¾ç„¶æ˜¯å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº† Region.Op.REPLACE å±žæ€§çš„åŽŸå› ï¼š 1234567private static void checkValidClipOp(@NonNull Region.Op op) &#123; if (sCompatiblityVersion &gt;= Build.VERSION_CODES.P &amp;&amp; op != Region.Op.INTERSECT &amp;&amp; op != Region.Op.DIFFERENCE) &#123; throw new IllegalArgumentException( &quot;Invalid Region.Op - only INTERSECT and DIFFERENCE are allowed&quot;); &#125;&#125; åœ¨è¯¥æ–¹æ³•ä¸Šé¢æœ‰çœŸä¹ˆå‡ è¡Œæ³¨é‡Šï¼š 1Region.Op values other than Region.Op.INTERSECT and Region.Op.DIFFERENCE have the ability to expand the clip. The canvas clipping APIs are intended to only expand the clip as a result of a restore operation. This enables a view parent to clip a canvas to clearly define the maximal drawing area of its children. The recommended alternative calls are clipRect(Rect) and clipOutRect(Rect) å¤§ä½“æ„æ€æ˜¯ï¼šRegion.Op.INTERSECTå’ŒRegion.Op.DIFFERENCEä»¥å¤–çš„Region.Opå€¼å¯ä»¥å±•å¼€ Clipã€‚ç”»å¸ƒå‰ªè¾‘APIä»…ç”¨äºŽåœ¨è¿˜åŽŸæ“ä½œåŽå±•å¼€Clipã€‚è¿™ä½¿è§†å›¾çˆ¶çº§èƒ½å¤Ÿå‰ªåˆ‡ç”»å¸ƒä»¥æ¸…æ¥šåœ°å®šä¹‰å…¶å­ç”»é¢çš„æœ€å¤§ç»˜åˆ¶åŒºåŸŸã€‚æŽ¨èè°ƒç”¨clipRectï¼ˆRectï¼‰å’ŒclipOutRectï¼ˆRectï¼‰. è™½ç„¶æˆ‘ä»¬æ‰¾åˆ°äº†é—®é¢˜çš„åŽŸå› ï¼Œä½†æ˜¯è¿™ä¸ªç±»ç©¶ç«Ÿæ˜¯åœ¨å“ªé‡Œç”¨åˆ°çš„æˆ‘ä»¬è¿˜æ— æ³•å®šä½åˆ°ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›ä¸€æ­¥è¿›è¡ŒæŽ’æŸ¥ã€‚ ç»è¿‡æŽ’æŸ¥ï¼Œæˆ‘ä»¬å‘çŽ°å‡ºçŽ°é—®é¢˜çš„åŽŸå› æ˜¯ material åŒ…ä¸­çš„ BottomAppBar æŽ§ä»¶ã€‚å…¶å®žä»Žä¸Šé¢çš„æ ˆä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºè¿™ä¸€ç‚¹ï¼šæ˜Žæ˜¾æ˜¯åœ¨ç»˜åˆ¶ View æ ‘çš„å­ View çš„æ—¶å€™å‡ºçŽ°çš„å¼‚å¸¸ï¼Œè€Œä¸”æ˜¯ç»˜åˆ¶ CoordinatorLayoutã€‚åœ¨ BottomAppBar ä¸­ä½¿ç”¨äº† materialShapeDrawableï¼Œè¯¥å˜é‡æ˜¯ MaterialShapeDrawableã€‚æ­£æ˜¯å‡ºçŽ°é—®é¢˜çš„ç½ªé­ç¥¸é¦–ã€‚ è¿™ä¸ªç±»MaterialShapeDrawableæ˜¯ç”¨æ¥å®žçŽ° BottomBar çš„é˜´å½±æ•ˆæžœçš„ï¼Œè™½ç„¶å®ƒæ˜¯ BottomBar çš„å†…éƒ¨ç±»ï¼Œä½†æ˜¯å¦‚æžœä¸å¸Œæœ›å®ƒè°ƒç”¨ä¸Šé¢çš„é‚£ä¸ªæ–¹æ³•ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ é¦–å…ˆï¼Œæˆ‘å‘çŽ°å®ƒè¦å…ˆåˆ¤æ–­æ˜¯å¦å…·æœ‰é˜´å½±å†è°ƒç”¨ç»˜åˆ¶é˜´å½±çš„æ–¹æ³•ï¼š 1234567 if (hasCompatShadow()) &#123; // Save the canvas before changing the clip bounds. canvas.save(); prepareCanvasForShadow(canvas);// ...æ— å…³ä»£ç  &#125; è€Œè¿™é‡Œçš„åˆ¤æ–­æ˜¯å¦å…·æœ‰é˜´å½±çš„æ–¹æ³•å¦‚ä¸‹ï¼š 12345private boolean hasCompatShadow() &#123; return shadowCompatMode != SHADOW_COMPAT_MODE_NEVER &amp;&amp; shadowCompatRadius &gt; 0 &amp;&amp; (shadowCompatMode == SHADOW_COMPAT_MODE_ALWAYS || requiresCompatShadow());&#125; æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸º BottomBar è®¾ç½®ç§»é™¤é˜´å½±æ•ˆæžœæ¥é¿å…è¿™ä¸ªç±»è°ƒç”¨ç»˜åˆ¶é˜´å½±çš„æ–¹æ³•ã€‚äºŽæ˜¯ï¼Œ 123456789&lt;com.google.android.material.bottomappbar.BottomAppBar android:id=&quot;@+id/bottom_app_bar&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;50dp&quot; android:layout_gravity=&quot;bottom&quot; app:backgroundTint=&quot;@color/colorAccent&quot; app:fabAlignmentMode=&quot;center&quot; app:elevation=&quot;0dp&quot; app:layout_behavior=&quot;@string/hide_bottom_view_on_scroll_behavior&quot;/&gt; è™½ç„¶æ•ˆæžœä¸å¥½çœ‹ï¼Œä½†æ˜¯é˜´å½±è§£å†³äº†ã€‚ 2.5 android.view.InflateException: Binary XML file line #24: Binary XML file line #24: Error inflating class com.google.android.material.floatingactionbutton.FloatingActionButtonåœ¨æŽ’æŸ¥ä¸Šé¢é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åŒæ ·å‘çŽ°äº† FAB çš„ä¸€ä¸ªé—®é¢˜ã€‚è¿™ä¸ª Material åŒ…ä¸­çš„ FAB ä¸Ž Support-28 åŒ…ä¸­çš„ç›¸æ¯”åšäº†ä¸€äº›è°ƒæ•´ã€‚ä¸”çœ‹ä¸‹é¢çš„å¼‚å¸¸ä¿¡æ¯ã€‚è¿™é‡Œé—®é¢˜æ˜¾ç„¶æ˜¯ç±»æ— æ³•è®°è½½é€ æˆçš„ã€‚é‚£ä¹ˆå…·ä½“æ˜¯å› ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¾€ä¸‹çœ‹åˆ°é”™è¯¯æ ˆçš„æœ€åŽå‡ è¡Œï¼Œå‘çŽ°æ˜¯æœ‰ä¸€ä¸ªå±žæ€§æ²¡æœ‰æ‰¾åˆ°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950512018-11-10 16:56:48.408 27581-27581/me.shouheng.references E/AndroidRuntime: FATAL EXCEPTION: main Process: me.shouheng.references, PID: 27581 java.lang.RuntimeException: Unable to start activity ComponentInfo&#123;me.shouheng.references/me.shouheng.layout.view.support28.BottomAppBarActivity&#125;: android.view.InflateException: Binary XML file line #24: Binary XML file line #24: Error inflating class com.google.android.material.floatingactionbutton.FloatingActionButton at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:3037) at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3172) at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:78) at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:108) at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:68) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1906) at android.os.Handler.dispatchMessage(Handler.java:106) at android.os.Looper.loop(Looper.java:193) at android.app.ActivityThread.main(ActivityThread.java:6863) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:537) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858) Caused by: android.view.InflateException: Binary XML file line #24: Binary XML file line #24: Error inflating class com.google.android.material.floatingactionbutton.FloatingActionButton Caused by: android.view.InflateException: Binary XML file line #24: Error inflating class com.google.android.material.floatingactionbutton.FloatingActionButton Caused by: java.lang.reflect.InvocationTargetException at java.lang.reflect.Constructor.newInstance0(Native Method) at java.lang.reflect.Constructor.newInstance(Constructor.java:343) at android.view.LayoutInflater.createView(LayoutInflater.java:647) at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:790) at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:730) at android.view.LayoutInflater.rInflate(LayoutInflater.java:863) at android.view.LayoutInflater.rInflateChildren(LayoutInflater.java:824) at android.view.LayoutInflater.inflate(LayoutInflater.java:515) at android.view.LayoutInflater.inflate(LayoutInflater.java:423) at androidx.databinding.DataBindingUtil.inflate(DataBindingUtil.java:126) at androidx.databinding.DataBindingUtil.inflate(DataBindingUtil.java:95) at me.shouheng.commons.view.activity.CommonActivity.onCreate(CommonActivity.java:41) at android.app.Activity.performCreate(Activity.java:7149) at android.app.Activity.performCreate(Activity.java:7140) at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1288) at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:3017) at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3172) at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:78) at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:108) at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:68) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1906) at android.os.Handler.dispatchMessage(Handler.java:106) at android.os.Looper.loop(Looper.java:193) at android.app.ActivityThread.main(ActivityThread.java:6863) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:537) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858) Caused by: java.lang.UnsupportedOperationException: Failed to resolve attribute at index 0: TypedValue&#123;t=0x2/d=0x7f0300b3 a=3&#125; at android.content.res.TypedArray.getColorStateList(TypedArray.java:565) at com.google.android.material.resources.MaterialResources.getColorStateList(MaterialResources.java:65) at com.google.android.material.floatingactionbutton.FloatingActionButton.&lt;init&gt;(FloatingActionButton.java:204)2018-11-10 16:56:48.408 27581-27581/me.shouheng.references E/AndroidRuntime: at com.google.android.material.floatingactionbutton.FloatingActionButton.&lt;init&gt;(FloatingActionButton.java:190) ... 27 more æ ¹æ®é”™è¯¯çš„æ ˆä¿¡æ¯ï¼Œæˆ‘ä»¬åˆ°æŒ‡å®šçš„æ–¹æ³•ä¸‹é¢åŽ»æŸ¥çœ‹é—®é¢˜çš„åŽŸå› ï¼Œå‘çŽ°æ˜¯è®¾ç½®èƒŒæ™¯ç€è‰²çš„æ—¶å€™å‡ºçŽ°çš„é—®é¢˜ï¼š 123backgroundTint = MaterialResources.getColorStateList( context, a, R.styleable.FloatingActionButton_backgroundTint); ä½†æˆ‘ä»¬å¹¶æ²¡æœ‰ä¸º FAB æ·»åŠ è¯¥å±žæ€§ï¼Œé‚£ä¹ˆåˆæ˜¯å“ªé‡Œå‡ºçŽ°çš„é—®é¢˜å‘¢ï¼ŸåŽŸæ¥æ˜¯å› ä¸ºæˆ‘ä»¬ä¸º FAB æ·»åŠ äº†ä¸€ä¸ª styleï¼š 1style=&quot;@style/Widget.MaterialComponents.FloatingActionButton&quot; è€Œè¯¥ style çš„å®šä¹‰æ˜¯ï¼š 123456789101112&lt;/style&gt; &lt;style name=&quot;Widget.MaterialComponents.FloatingActionButton&quot; parent=&quot;Widget.Design.FloatingActionButton&quot;&gt; &lt;item name=&quot;enforceMaterialTheme&quot;&gt;true&lt;/item&gt; &lt;item name=&quot;elevation&quot;&gt;@dimen/mtrl_fab_elevation&lt;/item&gt; &lt;item name=&quot;backgroundTint&quot;&gt;?attr/colorSecondary&lt;/item&gt; &lt;item name=&quot;tint&quot;&gt;?attr/colorOnSecondary&lt;/item&gt; &lt;item name=&quot;hoveredFocusedTranslationZ&quot;&gt;@dimen/mtrl_fab_translation_z_hovered_focused&lt;/item&gt; &lt;item name=&quot;pressedTranslationZ&quot;&gt;@dimen/mtrl_fab_translation_z_pressed&lt;/item&gt; &lt;item name=&quot;rippleColor&quot;&gt;@color/mtrl_fab_ripple_color&lt;/item&gt; &lt;item name=&quot;showMotionSpec&quot;&gt;@animator/mtrl_fab_show_motion_spec&lt;/item&gt; &lt;item name=&quot;hideMotionSpec&quot;&gt;@animator/mtrl_fab_hide_motion_spec&lt;/item&gt;&lt;/style&gt; è¿™æ ·åˆšå¥½ä¸Žæˆ‘ä»¬çš„é—®é¢˜å»åˆï¼Œæ‰€ä»¥è§£å†³çš„æ–¹æ¡ˆå°±æ˜¯ç§»é™¤è¿™ä¸ªå±žæ€§ã€‚ 2.6 java.net.UnknownServiceException: CLEARTEXT communication to baobab.kaiyanapp.com not permitted by network security policyæŒ‰ç…§ä¸Šé¢çš„æ–¹å¼å¯¹æˆ‘ä»¬çš„é¡¹ç›®åšäº†è°ƒæ•´ä¹‹åŽï¼Œæˆ‘ä»¬å‘çŽ°é¡¹ç›®å·²ç»å¯ä»¥è¿è¡Œäº†ã€‚æŽ¥ä¸‹æ¥å‡ºçŽ°çš„é—®é¢˜æ˜¯ç½‘ç»œè®¿é—®è¿‡ç¨‹ä¸­å‡ºçŽ°çš„ã€‚å½“æˆ‘ä»¬è®¿é—®ç½‘ç»œçš„æ—¶å€™ä¼šé‡åˆ°ä¸‹é¢çš„è¿™ä¸ªå¼‚å¸¸ï¼š 1java.net.UnknownServiceException: CLEARTEXT communication to baobab.kaiyanapp.com not permitted by network security policy è¿™ä¸ªæ˜¯å› ä¸º Android P ä¸­æ–°å¼•å…¥äº†ç½‘ç»œå®‰å…¨è§„åˆ™ï¼Œä»¥ä¸Šå†…å®¹ä¼šå¯¹ä½¿ç”¨ http çš„ URL å‡ºçŽ°ï¼Œé»˜è®¤ä¼šç¦æ­¢è®¿é—® http ç±»åž‹çš„åœ°å€ã€‚ å½“ç„¶ï¼Œé€šå¸¸æˆ‘ä»¬å‘å¸ƒçš„æ—¶å€™ä¼šä½¿ç”¨ Https ç±»åž‹çš„ç½‘ç»œåè®®ï¼Œè€Œå½“å¼€å‘å’Œè°ƒè¯•çš„æ—¶å€™å¯èƒ½å°±æ²¡æœ‰é‚£ä¹ˆä¸¥æ ¼äº†ã€‚æ‰€ä»¥ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ Android æ–°å¼•å…¥äº†ä¸‹é¢çš„è§£å†³æ–¹æ¡ˆï¼š é¦–å…ˆï¼Œåˆ›å»ºé…ç½®æ–‡ä»¶ res/xml/network_security_config.xmlï¼Œå†…å®¹å¦‚ä¸‹ï¼š 123456&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;network-security-config&gt; &lt;domain-config cleartextTrafficPermitted=&quot;true&quot;&gt; &lt;domain includeSubdomains=&quot;true&quot;&gt;localhost&lt;/domain&gt; &lt;/domain-config&gt;&lt;/network-security-config&gt; è¿™é‡Œçš„ localhostæ˜¯ host çš„åœ°å€ï¼Œæ¯”å¦‚æˆ‘ä¸Šé¢çš„å‡ºé”™çš„åœ°å€åº”è¯¥æ˜¯kaiyanapp.com`ã€‚ ç„¶åŽï¼Œæˆ‘ä»¬å°†å…¶é…ç½®åˆ° manifest.xml ä¸­ï¼š 123456&lt;application android:networkSecurityConfig=&quot;@xml/network_security_config&quot; android:label=&quot;@string/app_name&quot; android:theme=&quot;@style/AppTheme&quot;&gt; &lt;activity android:name=&quot; (...) &lt;/application&gt; åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ä½¿ç”¨äº†ä¸‰ä¸ªä¸åŒçš„åœ°å€ï¼Œå¹¶ä¸”éƒ½æ˜¯ http çš„ï¼Œæ‰€ä»¥å°±éœ€è¦åœ¨è¯¥åœ°å€ä¸‹é¢é…ç½®ä¸‰ä¸ªåŸŸåï¼Œç„¶åŽå†æ¬¡è®¿é—®ç½‘ç»œï¼Œé—®é¢˜å°±è§£å†³äº†ã€‚ å…³äºŽ Android ç½‘ç»œå’Œå®‰å…¨çš„å†…å®¹ï¼Œå»ºè®®å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šç½‘ç»œå®‰å…¨æ€§é…ç½® | Android Developersã€‚ æ€»ç»“æ˜¾ç„¶è¿ç§»åˆ° AndroidX çš„è¿‡ç¨‹ä¸­è¿˜æ˜¯ä¼šå‡ºçŽ°è®¸å¤šé—®é¢˜çš„ï¼Œå¤§å¤šæ•°æ˜¯ä¸Ž Android çš„æ”¯æŒåŒ…æœ‰å…³çš„ã€‚æŒ‰ç…§æˆ‘ä»¬ä¸Šé¢é‡åˆ°çš„é—®é¢˜ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹å†…å®¹ï¼š ä¸»é¢˜ æ”¯æŒåº“çš„æŽ§ä»¶ï¼ˆæŽ§ä»¶å±žæ€§ï¼Œå®žçŽ°æ–¹å¼å¥½åƒå˜äº†ä¸€äº›ï¼‰ ä¸‰æ–¹åº“ï¼Œè®¸å¤šåº“å¹¶æ²¡æœ‰è¿ç§»ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ç¨‹åºå†…æ ‡çº¢ï¼Œä½†æ˜¯ç¼–è¯‘å’Œè¿è¡Œæ²¡æœ‰é—®é¢˜ ç½‘ç»œå®‰å…¨ï¼Œç½‘ç»œå®‰å…¨éƒ¨åˆ†åšäº†ä¸€äº›è°ƒæ•´ å¥½äº†ï¼Œè¿™ç¯‡æ–‡ç« å¤§è‡´åˆ°è¿™é‡Œã€‚ä¹Ÿå¸Œæœ›é€šè¿‡è¿™ç¯‡æ–‡ç« æ¥è®©ä½ äº†è§£ä¸‹è¿ç§»åˆ° AndroidX è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºçŽ°ä»€ä¹ˆé—®é¢˜ï¼Œå¹¶ä»¥æ­¤æ¥è€ƒè™‘è¿ç§»çš„æˆæœ¬ã€‚ 1.Getting started with Material Components for Android2.ç½‘ç»œå®‰å…¨æ€§é…ç½® | Android Developers å¦‚æžœæ‚¨å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œå¯ä»¥åœ¨ä»¥ä¸‹å¹³å°å…³æ³¨æˆ‘ï¼š ä¸ªäººä¸»é¡µï¼šhttps://shouheng88.github.io/ æŽ˜é‡‘ï¼šhttps://juejin.im/user/585555e11b69e6006c907a2a Githubï¼šhttps://github.com/Shouheng88 CSDNï¼šhttps://blog.csdn.net/github_35186068 å¾®åšï¼šhttps://weibo.com/u/5401152113]]></content>
      <categories>
        <category>Androidé«˜é˜¶ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Java</tag>
        <tag>AndroidX</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Android æ¶ˆæ¯æœºåˆ¶ï¼šHandlerã€MessageQueue å’Œ Looper]]></title>
    <url>%2F2018%2F11%2F04%2FAndroid-%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%EF%BC%9AHandler%E3%80%81MessageQueue-%E5%92%8C-Looper%2F</url>
    <content type="text"><![CDATA[åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šè®¨è®º Android çš„æ¶ˆæ¯æœºåˆ¶ã€‚æåˆ° Handlerï¼Œæœ‰è¿‡ä¸€äº› Android å¼€å‘ç»éªŒçš„éƒ½åº”è¯¥å¾ˆæ¸…æ¥šå®ƒçš„ä½œç”¨ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨å®ƒæ¥é€šçŸ¥ä¸»çº¿ç¨‹æ›´æ–° UIã€‚ä½†æ˜¯ Handler éœ€è¦åº•å±‚çš„ MessageQueue å’Œ Looper æ¥æ”¯æŒæ‰èƒ½è¿ä½œã€‚è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šè®¨è®ºå®ƒä»¬ä¸‰ä¸ªä¹‹é—´çš„å…³ç³»ä»¥åŠå®žçŽ°åŽŸç†ã€‚ åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå› ä¸ºæ¶‰åŠçº¿ç¨‹æ–¹é¢çš„ä¸œè¥¿ï¼Œæ‰€ä»¥å°±é¿ä¸å¼€ ThreadLocalã€‚ç¬”è€…åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­æœ‰åˆ†æžè¿‡è¯¥ API çš„ä½œç”¨ï¼Œä½ å¯ä»¥å‚è€ƒç¬”è€…çš„è¿™ç¯‡æ–‡ç« æ¥å­¦ä¹ ä¸‹å®ƒçš„ä½œç”¨å’ŒåŽŸç†ï¼Œæœ¬æ–‡ä¸­æˆ‘ä»¬å°±ä¸å†ä¸“é—¨è®²è§£ï¼šã€ŠJava å¹¶å‘ç¼–ç¨‹ï¼šThreadLocal çš„ä½¿ç”¨åŠå…¶æºç å®žçŽ°ã€‹ã€‚ 1ã€Handler çš„ä½œç”¨é€šå¸¸ï¼Œå½“æˆ‘ä»¬åœ¨éžä¸»çº¿ç¨‹å½“ä¸­åšäº†å¼‚æ­¥çš„æ“ä½œä¹‹åŽä½¿ç”¨ Handler æ¥åœ¨ä¸»çº¿ç¨‹å½“ä¸­æ›´æ–° UIã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆè®¾è®¡æ— éžå°±æ˜¯å› ä¸º Android ä¸­çš„ View ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¹‹æ‰€ä»¥å°† View è®¾è®¡æˆéžçº¿ç¨‹å®‰å…¨çš„ï¼Œæ˜¯å› ä¸ºï¼š1).å¯¹ View è¿›è¡ŒåŠ é”ä¹‹åŽä¼šå¢žåŠ æŽ§ä»¶ä½¿ç”¨çš„å¤æ‚åº¦ï¼›2).åŠ é”ä¹‹åŽä¼šé™ä½ŽæŽ§ä»¶æ‰§è¡Œçš„æ•ˆçŽ‡ã€‚ä½† Handler å¹¶éžåªèƒ½ç”¨æ¥åœ¨ä¸»çº¿ç¨‹å½“ä¸­æ›´æ–° UIï¼Œç¡®åˆ‡æ¥è¯´å®ƒæœ‰ä¸¤ä¸ªä½œç”¨ï¼š ä»»åŠ¡è°ƒåº¦ï¼šå³é€šè¿‡ post() å’Œ send() ç­‰æ–¹æ³•æ¥æŒ‡å®šæŸä¸ªä»»åŠ¡åœ¨æŸä¸ªæ—¶é—´æ‰§è¡Œï¼› çº¿ç¨‹åˆ‡æ¢ï¼šä½ ä¹Ÿè®¸ç”¨è¿‡ RxJavaï¼Œä½†å¦‚æžœåœ¨ Android ä¸­ä½¿ç”¨çš„è¯è¿˜è¦é…åˆ RxAndroidï¼Œè€Œè¿™é‡Œçš„ RxAndroid å†…éƒ¨å°±ä½¿ç”¨ Handler æ¥å®žçŽ°çº¿ç¨‹åˆ‡æ¢ã€‚ ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬å°±æ¥åˆ†åˆ«çœ‹ä¸€ä¸‹å®ƒçš„è¿™ä¸¤ä¸ªåŠŸèƒ½çš„ä½œç”¨å’ŒåŽŸç†ã€‚ 1.1 ä»»åŠ¡è°ƒåº¦ä½¿ç”¨ Hanlder å¯ä»¥è®©ä¸€ä¸ªä»»åŠ¡åœ¨æŸä¸ªæ—¶é—´ç‚¹æ‰§è¡Œæˆ–è€…ç­‰å¾…æŸæ®µæ—¶é—´ä¹‹åŽæ‰§è¡Œã€‚Handler ä¸ºæ­¤æä¾›äº†è®¸å¤šæ–¹æ³•ï¼Œä»Žæ–¹æ³•çš„å‘½åä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†æˆ post() å’Œ sned() ä¸¤ç±»æ–¹æ³•ã€‚post() ç±»çš„ç”¨æ¥æŒ‡å®šæŸä¸ª Runnable åœ¨æŸä¸ªæ—¶é—´ç‚¹æ‰§è¡Œï¼Œsend() ç±»çš„ç”¨æ¥æŒ‡å®šæŸä¸ª Message åœ¨æŸä¸ªæ—¶é—´ç‚¹æ‰§è¡Œã€‚ è¿™é‡Œçš„ Message æ˜¯ Android ä¸­å®šä¹‰çš„ä¸€ä¸ªç±»ã€‚å®ƒå†…éƒ¨æœ‰å¤šä¸ªå­—æ®µï¼Œæ¯”å¦‚ whatã€arg1ã€arg2ã€replyTo å’Œ sendingUid æ¥å¸®åŠ©æˆ‘ä»¬æŒ‡å®šè¯¥æ¶ˆæ¯çš„å†…å®¹å’Œå¯¹è±¡ã€‚åŒæ—¶ï¼Œ Message è¿˜å®žçŽ°äº† Parcelable æŽ¥å£ï¼Œè¿™è¡¨æ˜Žå®ƒå¯ä»¥è¢«ç”¨æ¥è·¨è¿›ç¨‹ä¼ è¾“ã€‚æ­¤å¤–ï¼Œå®ƒå†…éƒ¨è¿˜å®šä¹‰äº†ä¸€ä¸ª Message ç±»åž‹çš„ next å­—æ®µï¼Œè¿™è¡¨æ˜Ž Message å¯ä»¥è¢«ç”¨ä½œé“¾è¡¨çš„ç»“ç‚¹ã€‚å®žé™…ä¸Š MessageQueue é‡Œé¢åªå­˜æ”¾äº†ä¸€ä¸ª mMessageï¼Œå³é“¾è¡¨çš„å¤´ç»“ç‚¹ã€‚æ‰€ä»¥ï¼ŒMessageQueue å†…éƒ¨çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå•é“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨çš„ç»“ç‚¹å°±æ˜¯ Messageã€‚ å½“è°ƒç”¨ post() ç±»åž‹çš„æ–¹æ³•æ¥è°ƒåº¦æŸä¸ª Runnable çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå°†å…¶åŒ…è£…æˆä¸€ä¸ª Messageï¼Œç„¶åŽå†ä½¿ç”¨ send() ç±»çš„æ–¹æ³•è¿›è¡Œä»»åŠ¡åˆ†å‘ã€‚æ‰€ä»¥ï¼Œä¸è®ºæ˜¯ post() ç±»çš„æ–¹æ³•è¿˜æ˜¯ send() ç±»çš„æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šä½¿ç”¨ Handler çš„ sendMessageAtTime() æ–¹æ³•æ¥å°†å…¶åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼š public boolean sendMessageAtTime(Message msg, long uptimeMillis) { MessageQueue queue = mQueue; if (queue == null) { // ... æ— å…³ä»£ç  return false; } return enqueueMessage(queue, msg, uptimeMillis); } ä½¿ç”¨ Handler è¿›è¡Œä»»åŠ¡è°ƒåº¦æ˜¯éžå¸¸ç®€å•çš„ã€‚ä¸‹é¢çš„ä»£ç å°±å®žçŽ°äº†è®©ä¸€ä¸ª Runnable åœ¨ 500ms ä¹‹åŽæ‰§è¡Œçš„é€»è¾‘ï¼š new Handler().postDelayed(new Runnable() { @Override public void run() { // do something } }, 500); ä¸Šé¢çš„ä»»åŠ¡æ‰§è¡Œæ–¹å¼åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œä¸ä¼šå‡ºçŽ°ä»»ä½•é—®é¢˜ï¼Œå¦‚æžœä½ åœ¨éžä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„è¯å°±å¯èƒ½ä¼šå‡ºçŽ°å¼‚å¸¸ã€‚åŽŸå› æˆ‘ä»¬åŽé¢ä¼šè®²è§£ã€‚ æ—¢ç„¶æ¯ä¸ª Runnable è¢« post() å‘é€ä¹‹åŽè¿˜è¦è¢«åŒ…è£…æˆ Messageï¼Œé‚£ä¹ˆ Message çš„æ„ä¹‰ä½•åœ¨å‘¢ï¼Ÿ Runnable è¢«åŒ…è£…çš„è¿‡ç¨‹ä¾èµ–äºŽ Handler å†…éƒ¨çš„ getPostMessage() æ–¹æ³•ã€‚ä¸‹é¢æ˜¯è¯¥æ–¹æ³•çš„å®šä¹‰ï¼š private static Message getPostMessage(Runnable r) { Message m = Message.obtain(); m.callback = r; return m; } å¯è§ï¼Œæˆ‘ä»¬çš„ Runnable ä¼šè¢«èµ‹å€¼ç»™ Message çš„ callbackã€‚è¿™ç§ç±»åž‹çš„æ¶ˆæ¯æ— æ³•åšæ›´è¯¦ç»†çš„å¤„ç†ã€‚å°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æ— æ³•åˆ©ç”¨æ¶ˆæ¯çš„ whatã€arg1 ç­‰å­—æ®µï¼ˆæœ¬èº«æˆ‘ä»¬ä¹Ÿæ²¡æœ‰è®¾ç½®è¿™äº›å­—æ®µï¼‰ã€‚å¦‚æžœæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ Message çš„è¿™äº›å­—æ®µä¿¡æ¯ï¼Œå°±éœ€è¦ï¼š é¦–å…ˆï¼Œè¦ä½¿ç”¨ send() ç±»åž‹çš„æ–¹æ³•æ¥ä¼ é€’æˆ‘ä»¬çš„ Message ç»™ Handlerï¼› ç„¶åŽï¼Œæˆ‘ä»¬çš„ Handler è¦è¦†å†™ handleMessage() æ–¹æ³•ï¼Œå¹¶åœ¨è¯¥æ–¹æ³•ä¸­èŽ·å–æ¯ä¸ª Message å¹¶æ ¹æ®å…¶å†…éƒ¨çš„ä¿¡æ¯ä¾æ¬¡å¤„ç†ã€‚ ä¸‹é¢çš„ä¸€ä¸ªä¾‹å­ç”¨æ¥æ¼”ç¤º send() ç±»åž‹çš„æ–¹æ³•ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è¦å®šä¹‰ Handler å¹¶è¦†å†™å…¶ handleMessage() æ–¹æ³•æ¥å¤„ç†æ¶ˆæ¯ï¼š private final static int SAY_HELLO = 1; private static Handler handler = new Handler() { @Override public void handleMessage(Message msg) { switch (msg.what) { case SAY_HELLO: LogUtils.d(&quot;Hello!&quot;); break; } } }; ç„¶åŽï¼Œæˆ‘ä»¬å‘è¯¥ Handler å‘é€æ¶ˆæ¯ï¼š Message message = Message.obtain(handler); message.what = SAY_HELLO; message.sendToTarget(); è¿™æ ·ï¼Œæˆ‘ä»¬çš„ Handler æŽ¥æ”¶åˆ°äº†æ¶ˆæ¯å¹¶æ ¹æ®å…¶ what å¾—çŸ¥è¦ SAY_HELLOï¼ŒäºŽæ˜¯å°±æ‰“å°å‡ºäº†æ—¥å¿—ä¿¡æ¯ã€‚é™¤äº†è°ƒç”¨ Message çš„ sendToTarget() æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç›´æŽ¥è°ƒç”¨ handler çš„ sendMessage() æ–¹æ³•ï¼ˆsendToTarget() å†…éƒ¨è°ƒç”¨äº† handler çš„ sendMessage()ï¼‰ã€‚ 1.2 çº¿ç¨‹åˆ‡æ¢ä¸‹é¢æˆ‘ä»¬ç”¨äº†ä¸€ä»½ç¤ºä¾‹ä»£ç ï¼Œå®ƒä¼šå…ˆåœ¨ä¸»çº¿ç¨‹å½“ä¸­å®žä¾‹åŒ–ä¸€ä¸ª Handlerï¼Œç„¶åŽåœ¨æŸä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¼€å¯äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œäº†æŸä¸ªä»»åŠ¡ã€‚2 ç§’ä¹‹åŽä»»åŠ¡ç»“æŸï¼Œæˆ‘ä»¬æ¥æ›´æ–° UIã€‚ // åœ¨ä¸»çº¿ç¨‹ä¸­èŽ·å– Handler private static Handler handler = new Handler(); // æ›´æ–°UIï¼Œä¼šå°†æ¶ˆæ¯å‘é€åˆ°ä¸»çº¿ç¨‹å½“ä¸­ new Thread(() -&gt; { try { Thread.sleep(2000); handler.post(() -&gt; getBinding().tv.setText(&quot;ä¸»çº¿ç¨‹æ›´æ–°UI&quot;)); } catch (InterruptedException e) { e.printStackTrace(); } }).start(); ä¸Šé¢ä¹‹æ‰€ä»¥èƒ½å¤Ÿåœ¨ä¸»çº¿ç¨‹å½“ä¸­æ›´æ–° UIï¼Œä¸»è¦æ˜¯å› ä¸ºæˆ‘ä»¬çš„ Handler æ˜¯åœ¨ä¸»çº¿ç¨‹å½“ä¸­è¿›è¡ŒèŽ·å–çš„ã€‚éšåŽï¼Œæˆ‘ä»¬è°ƒç”¨ handler çš„ post() æ–¹æ³•ä¹‹åŽï¼Œä¼ å…¥çš„ Runnable ä¼šè¢«åŒ…è£…æˆ Messageï¼Œç„¶åŽåŠ å…¥åˆ°ä¸»çº¿ç¨‹å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­åŽ»ï¼Œå¹¶ç”±ä¸»çº¿ç¨‹å¯¹åº”çš„ Looper èŽ·å–åˆ°å¹¶æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œå°±ä½¿å¾—è¯¥ Runnable çš„æ“ä½œæœ€ç»ˆåœ¨ä¸»çº¿ç¨‹ä¸­å®Œæˆã€‚ ä¹Ÿè®¸ä½ ä¼šè§‰å¾—å…ˆåœ¨ä¸»çº¿ç¨‹å½“ä¸­èŽ·å–åˆ° Handler ç„¶åŽå†ä½¿ç”¨æ¯”è¾ƒéº»çƒ¦ã€‚åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬è¿˜æœ‰å¦ä¸€ç§æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥ç›´æŽ¥ä½¿ç”¨ Looper çš„ getMainLooper() æ–¹æ³•æ¥èŽ·å–ä¸»çº¿ç¨‹å¯¹åº”çš„ Looperï¼Œç„¶åŽä½¿ç”¨å®ƒæ¥å®žä¾‹åŒ–ä¸€ä¸ª Handler å¹¶ä½¿ç”¨è¯¥ Handler æ¥å¤„ç†æ¶ˆæ¯ï¼š new Handler(Looper.getMainLooper()) .post(() -&gt; getBinding().tv.setText(&quot;ä¸»çº¿ç¨‹æ›´æ–°UI&quot;)); æœ¬è´¨ä¸Šï¼Œå½“æˆ‘ä»¬è°ƒç”¨ Handler çš„æ— å‚æž„é€ æ–¹æ³•ï¼Œæˆ–è€…è¯´ä¸æŒ‡å®š Looper çš„æž„é€ æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šç›´æŽ¥ä½¿ç”¨å½“å‰çº¿ç¨‹å¯¹åº”çš„ Looper æ¥å®žä¾‹åŒ– Handlerã€‚æ¯ä¸ªçº¿ç¨‹å¯¹åº”çš„ Looper å­˜å‚¨åœ¨è¯¥çº¿ç¨‹çš„å±€éƒ¨å˜é‡ ThreadLocal é‡Œã€‚å½“æŸä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡é‡Œé¢æ²¡æœ‰ Looper çš„æ—¶å€™å°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¹‹å‰è¯´ç›´æŽ¥ä½¿ç”¨ new æ¥å®žä¾‹åŒ–ä¸€ä¸ª Handler çš„æ—¶å€™å¯èƒ½å‡ºé”™å°±æ˜¯è¿™ä¸ªåŽŸå› ã€‚ ä¸»çº¿ç¨‹å¯¹åº”çš„ Looper ä¼šåœ¨ ActivityThread çš„é™æ€æ–¹æ³• main() ä¸­è¢«åˆ›å»ºï¼Œå®ƒä¼šè°ƒç”¨ Looper çš„ prepareMainLooper() é™æ€æ–¹æ³•æ¥åˆ›å»ºä¸»çº¿ç¨‹å¯¹åº”çš„ Looperã€‚ç„¶åŽä¼šè°ƒç”¨ Looper çš„ loop() é™æ€æ–¹æ³•æ¥å¼€å¯ Looper å¾ªçŽ¯ä»¥ä¸æ–­å¤„ç†æ¶ˆæ¯ã€‚è¿™é‡Œçš„ ActivityThread ç”¨æ¥å¤„ç†åº”ç”¨è¿›ç¨‹ä¸­çš„æ´»åŠ¨å’Œå¹¿æ’­çš„è¯·æ±‚ï¼Œä¼šåœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™è°ƒç”¨ã€‚ActivityThread å†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªå†…éƒ¨ç±» Hï¼Œå®ƒç»§æ‰¿è‡ª Handlerï¼ŒåŒæ ·è¿è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œç”¨æ¥å¤„ç†æŽ¥æ”¶åˆ°çš„æ¥è‡ªå„ä¸ªæ´»åŠ¨ã€å¹¿æ’­å’ŒæœåŠ¡çš„è¯·æ±‚ã€‚ é™¤äº†ä½¿ç”¨ä¸»çº¿ç¨‹å¯¹åº”çš„ Looperï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¼€å¯æˆ‘ä»¬è‡ªå®šä¹‰çº¿ç¨‹çš„ Looperã€‚ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¼€å¯äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶åœ¨çº¿ç¨‹ä¸­å…ˆè°ƒç”¨ Looper çš„ prepare() é™æ€æ–¹æ³•ï¼Œæ­¤æ—¶ Looper ä¼šä¸ºæˆ‘ä»¬å½“å‰çš„çº¿ç¨‹åˆ›å»º Looperï¼Œç„¶åŽå°†å…¶åŠ å…¥åˆ°å½“å‰çº¿ç¨‹çš„å±€éƒ¨å˜é‡é‡Œé¢ã€‚éšåŽï¼Œå½“æˆ‘ä»¬è°ƒç”¨ Looper çš„ loop() æ–¹æ³•çš„æ—¶å€™å°±å¼€å¯äº† Looper å¾ªçŽ¯æ¥ä¸æ–­å¤„ç†æ¶ˆæ¯ï¼š new Thread(() -&gt; { LogUtils.d(&quot;+++++++++&quot; + Thread.currentThread()); Looper.prepare(); new Handler().post(() -&gt; LogUtils.d(&quot;+++++++++&quot; + Thread.currentThread())); Looper.loop(); }).start(); ä»Žä»¥ä¸Šçš„å†…å®¹æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒHandler ä¹‹æ‰€ä»¥èƒ½å¤Ÿå®žçŽ°çº¿ç¨‹åˆ‡æ¢ï¼Œä¸»è¦çš„åŽŸå› æ˜¯å…¶å†…éƒ¨çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¯¹åº”äºŽæ¯ä¸€ä¸ªçº¿ç¨‹çš„ã€‚å‘é€çš„ä»»åŠ¡ä¼šåœ¨è¯¥çº¿ç¨‹å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¢«æ‰§è¡Œã€‚è€ŒæˆåŠŸèŽ·å–åˆ°è¯¥çº¿ç¨‹å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—å°±ä¾é  ThreadLocal æ¥å¯¹æ¯ä¸ªçº¿ç¨‹å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå­˜å‚¨ã€‚ 2ã€æºç è§£æžä»¥ä¸Šï¼Œæˆ‘ä»¬åˆ†æžäº† Handler çš„ä¸»è¦çš„ä¸¤ç§ä¸»è¦ç”¨é€”ï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æåŠäº†è®¸å¤š Handlerã€MessageQueue å’Œ Looper çš„åº•å±‚è®¾è®¡ã€‚åœ¨ä¸Šé¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ä½¿ç”¨äº†æ–‡å­—æ¥è¿›è¡Œæè¿°ã€‚åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬æ¥é€šè¿‡æºç æ¥éªŒè¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ä¸€äº›å†…å®¹ã€‚ 2.1 å®žä¾‹åŒ– HandlerHandler äº†æä¾›äº†å¤šä¸ªé‡è½½çš„æž„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†æˆä¸¤ç§ä¸»è¦çš„ç±»åž‹ã€‚ä¸€ç§åœ¨æž„é€ æ–¹æ³•ä¸­éœ€è¦æ˜Žç¡®æŒ‡å®šä¸€ä¸ª Looperï¼Œå¦ä¸€ç§åœ¨æž„é€ æ–¹æ³•ä¸­ä¸éœ€è¦æŒ‡å®šä»»ä½• Looperï¼Œåœ¨æž„é€ æ–¹æ³•å†…éƒ¨ä¼šèŽ·å–å½“å‰çº¿ç¨‹å¯¹åº”çš„ Looper æ¥åˆå§‹åŒ– Handlerã€‚ ç¬¬ä¸€ç§åˆå§‹åŒ–çš„æ–¹å¼æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ä¸‹é¢çš„æ–¹æ³•æ¥å®Œæˆåˆå§‹åŒ–ã€‚è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œæ˜¯åŸºæœ¬çš„èµ‹å€¼æ“ä½œï¼š public Handler(Looper looper, Callback callback, boolean async) { mLooper = looper; mQueue = looper.mQueue; mCallback = callback; mAsynchronous = async; } ç¬¬äºŒç§åˆå§‹åŒ–çš„æ–¹å¼æœ€ç»ˆä¼šè°ƒç”¨ä¸‹é¢çš„æ–¹æ³•ã€‚è¿™é‡Œä½¿ç”¨ Looper çš„é™æ€æ–¹æ³• myLooper() æ¥èŽ·å–å½“å‰çº¿ç¨‹å¯¹åº”çš„ Looperã€‚å¦‚æžœå½“å‰çº¿ç¨‹ä¸å­˜åœ¨ä»»ä½• Looper å°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚ public Handler(Callback callback, boolean async) { // æ½œåœ¨å†…å­˜æ³„æ¼çš„æ£€æŸ¥ if (FIND_POTENTIAL_LEAKS) { final Class&lt;? extends Handler&gt; klass = getClass(); if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp; (klass.getModifiers() &amp; Modifier.STATIC) == 0) { Log.w(TAG, &quot;The following Handler class should be static or leaks might occur: &quot; + klass.getCanonicalName()); } } // ä½¿ç”¨ Looper çš„é™æ€æ–¹æ³• myLooper() æ¥èŽ·å–å½“å‰çº¿ç¨‹çš„ Looper mLooper = Looper.myLooper(); if (mLooper == null) { throw new RuntimeException(); } mQueue = mLooper.mQueue; mCallback = callback; mAsynchronous = async; } è€Œ Looper çš„é™æ€æ–¹æ³• myLooper() ä¼šä½¿ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡ sThreadLocal æ¥èŽ·å–ä¹‹å‰å­˜å‚¨åˆ°è¯¥çº¿ç¨‹å†…éƒ¨çš„ Looperï¼š public static @Nullable Looper myLooper() { return sThreadLocal.get(); } 2.2 Looper çš„åˆå§‹åŒ–å‰é¢æˆ‘ä»¬ä¹Ÿè¯´è¿‡ Looper çš„åˆ›å»ºè¿‡ç¨‹ã€‚å¯¹äºŽä¸»çº¿ç¨‹çš„ Looper ä¼šåœ¨ ActivityThread çš„ main() æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼š public static void main(String[] args) { // ... æ— å…³ä»£ç  Looper.prepareMainLooper(); // ... æ— å…³ä»£ç  // å¼€å¯ Looper å¾ªçŽ¯ Looper.loop(); throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;); } è¿™é‡Œè°ƒç”¨äº† Looper çš„é™æ€æ–¹æ³• prepareMainLooper() æ¥åˆå§‹åŒ–ä¸»çº¿ç¨‹çš„ Looperï¼š public static void prepareMainLooper() { prepare(false); synchronized (Looper.class) { if (sMainLooper != null) { throw new IllegalStateException(&quot;The main Looper has already been prepared.&quot;); } sMainLooper = myLooper(); } } å…¶å†…éƒ¨å…ˆè°ƒç”¨äº† prepare(boolean) æ–¹æ³•æ¥åˆå§‹åŒ–ä¸€ä¸ª Looper å¹¶å°†å…¶æ”¾åœ¨çº¿ç¨‹å±€éƒ¨å˜é‡ sThreadLocal ä¸­ï¼Œç„¶åŽåˆ¤æ–­ sMainLooper æ˜¯å¦ä¹‹å‰å­˜åœ¨è¿‡ã€‚è¿™æ˜¯ä¸€ç§åŸºæœ¬çš„å•ä¾‹æ ¡éªŒï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬åªå…è®¸ä¸»çº¿ç¨‹çš„ Looper è¢«å®žä¾‹åŒ–ä¸€æ¬¡ã€‚ åŒæ ·ï¼Œéžä¸»çº¿ç¨‹çš„ Looper ä¹Ÿåªå…è®¸è¢«å®žä¾‹åŒ–ä¸€æ¬¡ã€‚å½“æˆ‘ä»¬åœ¨éžä¸»çº¿ç¨‹å®žä¾‹åŒ–ä¸€ä¸ª Looper çš„æ—¶å€™ä¼šè°ƒç”¨å®ƒçš„ prepare() é™æ€æ–¹æ³•ã€‚å®ƒåŒæ ·è°ƒç”¨äº† prepare(boolean) æ–¹æ³•æ¥åˆå§‹åŒ–ä¸€ä¸ª Looper å¹¶å°†å…¶æ”¾åœ¨çº¿ç¨‹å±€éƒ¨å˜é‡ sThreadLocal ä¸­ã€‚æ‰€ä»¥ï¼Œä¸»çº¿ç¨‹å’Œéžä¸»çº¿ç¨‹çš„ Looper å®žä¾‹åŒ–çš„æ—¶å€™æœ¬è´¨ä¸Šæ˜¯è°ƒç”¨åŒæ ·çš„æ–¹æ³•ï¼Œåªæ˜¯å®ƒä»¬å®žçŽ°çš„æ—¶æœºä¸åŒï¼Œå¹¶ä¸”ï¼Œéƒ½åªèƒ½è¢«å®žä¾‹åŒ–ä¸€æ¬¡ã€‚ public static void prepare() { prepare(true); } private static void prepare(boolean quitAllowed) { if (sThreadLocal.get() != null) { throw new RuntimeException(&quot;Only one Looper may be created per thread&quot;); } sThreadLocal.set(new Looper(quitAllowed)); } ç»è¿‡ä¸Šè¿°åˆ†æžï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œå¯¹äºŽä¸€ä¸ªçº¿ç¨‹åªèƒ½å®žä¾‹åŒ–ä¸€ä¸ª Looperï¼Œæ‰€ä»¥å½“æˆ‘ä»¬åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å¤šæ¬¡åˆ›å»º Handler å®žä¾‹ï¼Œå®ƒä»¬æ˜¯å…±äº«ä¸€ä¸ª Looper çš„ã€‚æˆ–è€…è¯´æ˜¯ä¸€ä¸ª Looper å¯¹åº”å¤šä¸ª Handler ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ 2.3 MessageQueue çš„å®žä¾‹åŒ–ç›¸æ¯”äºŽ Looper å’Œ Handlerï¼ŒMessageQueue å°±æ˜¾å¾—ç›¸å¯¹å¤æ‚ä¸€äº›ã€‚å› ä¸ºå†…éƒ¨ç”¨åˆ°äº† JNI ç¼–ç¨‹ã€‚åˆå§‹åŒ–ã€é”€æ¯å’Œå…¥é˜Ÿç­‰äº‹ä»¶éƒ½ç”¨åˆ°äº† native çš„æ–¹æ³•ã€‚ä½ å¯ä»¥åœ¨ android_os_MessageQueue æŸ¥çœ‹å…¶æºç çš„å®šä¹‰ã€‚ æ¯å½“æˆ‘ä»¬å®žä¾‹åŒ–ä¸€ä¸ª Looper çš„æ—¶å€™ä¼šè°ƒç”¨å®ƒçš„æž„é€ æ–¹æ³•ï¼Œå¹¶åœ¨å…¶ä¸­å®žä¾‹åŒ–ä¸€ä¸ª MessageQueueï¼š private Looper(boolean quitAllowed) { mQueue = new MessageQueue(quitAllowed); mThread = Thread.currentThread(); } åœ¨å®žä¾‹åŒ– Handler çš„å°èŠ‚ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯æ¬¡å®žä¾‹åŒ–ä¸€ä¸ª Handler çš„æ—¶å€™ï¼Œä¼šä»Žå½“å‰çº¿ç¨‹å¯¹åº”çš„ Looper ä¸­å–å‡º MessageQueueã€‚æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘ä»¬åˆå¯ä»¥å¾—å‡ºç»“è®ºä¸€ä¸ª Handler å¯¹åº”ä¸€ä¸ª MessageQueueã€‚ å½“æˆ‘ä»¬å®žä¾‹åŒ–ä¸€ä¸ª MessageQueue çš„æ—¶å€™ä¼šä½¿ç”¨å®ƒçš„æž„é€ æ–¹æ³•ã€‚è¿™é‡Œä¼šè°ƒç”¨ native å±‚çš„ nativeInit() æ–¹æ³•æ¥å®Œæˆ MessageQueue çš„åˆå§‹åŒ–ï¼š MessageQueue(boolean quitAllowed) { mQuitAllowed = quitAllowed; mPtr = nativeInit(); } åœ¨ native å±‚ï¼ŒnativeInit() æ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹ï¼š static jlong android_os_MessageQueue_nativeInit(JNIEnv* env, jclass clazz) { NativeMessageQueue* nativeMessageQueue = new NativeMessageQueue(); if (!nativeMessageQueue) { jniThrowRuntimeException(env, &quot;Unable to allocate native queue&quot;); return 0; } nativeMessageQueue-&gt;incStrong(env); return reinterpret_cast&lt;jlong&gt;(nativeMessageQueue); } ä»Žä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å®žä¾‹åŒ–äº†ä¸€ä¸ª NativeMessageQueue ä¹‹åŽè¿”å›žäº† mPtr ä½œä¸ºæ˜¯ Java å±‚ MessageQueue ä¸ŽNativeMessesageQueue çš„æ¡¥æ¢ã€‚è¿™ä¸ª long ç±»åž‹çš„æˆå‘˜ä¿å­˜äº† native å®žä¾‹ï¼Œè¿™æ˜¯ jni å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„æ–¹å¼ã€‚å› æ­¤ MessageQueue åŒæ ·ä½¿ç”¨ mPtr æ¥è¡¨ç¤º native å±‚çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚NativeMessageQueue åœ¨ native å±‚çš„éƒ¨åˆ†å®šä¹‰å’Œå…¶æž„é€ æ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹ã€‚ class NativeMessageQueue : public MessageQueue, public LooperCallback { // ... æ— å…³ä»£ç  NativeMessageQueue::NativeMessageQueue() : mPollEnv(NULL), mPollObj(NULL), mExceptionObj(NULL) { mLooper = Looper::getForThread(); if (mLooper == NULL) { mLooper = new Looper(false); Looper::setForThread(mLooper); } } ä»Žä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒNativeMessageQueue ç»§æ‰¿è‡ª MessageQueueã€‚å¹¶ä¸”åœ¨å…¶å†…éƒ¨å®žä¾‹åŒ–äº†ä¸€ä¸ª native å±‚çš„ Looperï¼ˆå…¶æºç åœ¨ Looperï¼‰ã€‚ åœ¨ Android çš„ native å±‚å­˜åœ¨ç€ä¸€ä¸ªäºŽ Java å±‚ç±»ä¼¼çš„ Looperï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥ä¸Ž Java å±‚çš„ Looper ç›¸äº’é…åˆå®Œæˆ Android ä¸­æœ€ä¸»è¦çš„çº¿ç¨‹é€šä¿¡ã€‚å½“æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯å­˜å…¥æ—¶ï¼Œä¼šå”¤é†’ Natvice å±‚çš„ Looperã€‚å½“æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶æˆ–è€…æ¶ˆæ¯å°šæœªåˆ°å¤„ç†æ—¶é—´æ—¶ï¼Œ Natvice å±‚çš„ Looper ä¼š block ä½æ•´ä¸ªçº¿ç¨‹ã€‚æ‰€ä»¥ï¼Œåˆ›å»ºäº† Java Looper çš„çº¿ç¨‹åªæœ‰åœ¨æœ‰æ¶ˆæ¯å¾…å¤„ç†æ—¶æ‰å¤„äºŽæ´»è·ƒçŠ¶æ€ï¼Œæ— æ¶ˆæ¯æ—¶ block åœ¨ç­‰å¾…æ¶ˆæ¯å†™å…¥çš„çŠ¶æ€ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œå½“æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­å¼€å¯äº† Looper å¾ªçŽ¯çš„è¯ï¼Œä¸ºä»€ä¹ˆä¸ä¼š block ä½æ•´ä¸ªçº¿ç¨‹è€Œå¯¼è‡´ ANR å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬çš„ä¸»çº¿ç¨‹çš„æ¶ˆæ¯éƒ½ä¼šå‘é€ç»™ä¸»çº¿ç¨‹å¯¹åº”çš„ Looper æ¥å¤„ç†ï¼Œæ‰€ä»¥ï¼Œæœ¬è´¨ä¸Šï¼Œæˆ‘ä»¬ä¸»çº¿ç¨‹ä¸­çš„è®¸å¤šäº‹ä»¶ä¹Ÿéƒ½æ˜¯ä»¥æ¶ˆæ¯çš„å½¢å¼å‘é€ç»™ä¸»çº¿ç¨‹çš„ Handler æ¥è¿›è¡Œå¤„ç†çš„ã€‚åªæœ‰å½“æŸä¸ªæ¶ˆæ¯è¢«æ‰§è¡Œçš„æ—¶é—´è¿‡é•¿çš„æ—¶å€™æ‰ä¼šå‡ºçŽ° ANRã€‚ ä¸Šé¢æˆ‘ä»¬å®žä¾‹åŒ–äº†ä¸€ä¸ª Native å±‚çš„ Looperã€‚åœ¨å…¶ä¸­ä¸»è¦åšåˆ°çš„é€»è¾‘å¦‚ä¸‹ï¼š void Looper::rebuildEpollLocked() { // å¦‚æžœä¹‹å‰å­˜åœ¨çš„è¯å°±å…³é—­ä¹‹å‰çš„ epoll å®žä¾‹ if (mEpollFd &gt;= 0) { mEpollFd.reset(); // å…³é—­æ—§çš„epollå®žä¾‹ } // ç”³è¯·æ–°çš„ epoll å®žä¾‹ï¼Œå¹¶ä¸”æ³¨å†Œ â€œWakeç®¡é“â€ mEpollFd.reset(epoll_create(EPOLL_SIZE_HINT)); LOG_ALWAYS_FATAL_IF(mEpollFd &lt; 0, &quot;Could not create epoll instance: %s&quot;, strerror(errno)); struct epoll_event eventItem; // æŠŠæœªä½¿ç”¨çš„æ•°æ®åŒºåŸŸè¿›è¡Œç½®0æ“ä½œ memset(&amp; eventItem, 0, sizeof(epoll_event)); eventItem.events = EPOLLIN; eventItem.data.fd = mWakeEventFd.get(); // å°†å”¤é†’äº‹ä»¶ (mWakeEventFd) æ·»åŠ åˆ° epoll å®žä¾‹ (mEpollFd) int result = epoll_ctl(mEpollFd.get(), EPOLL_CTL_ADD, mWakeEventFd.get(), &amp;eventItem); LOG_ALWAYS_FATAL_IF(result != 0, &quot;Could not add wake event fd to epoll instance: %s&quot;, strerror(errno)); // è¿™é‡Œä¸»è¦æ·»åŠ çš„æ˜¯Inputäº‹ä»¶å¦‚é”®ç›˜ï¼Œä¼ æ„Ÿå™¨è¾“å…¥ï¼Œè¿™é‡ŒåŸºæœ¬ä¸Šç”±ç³»ç»Ÿè´Ÿè´£ï¼Œå¾ˆå°‘ä¸»åŠ¨åŽ»æ·»åŠ  for (size_t i = 0; i &lt; mRequests.size(); i++) { const Request&amp; request = mRequests.valueAt(i); struct epoll_event eventItem; request.initEventItem(&amp;eventItem); // å°† request é˜Ÿåˆ—çš„äº‹ä»¶ï¼Œåˆ†åˆ«æ·»åŠ åˆ° epoll å®žä¾‹ int epollResult = epoll_ctl(mEpollFd.get(), EPOLL_CTL_ADD, request.fd, &amp;eventItem); } } è¿™é‡Œæ¶‰åŠäº† epoll ç›¸å…³çš„çŸ¥è¯†ã€‚epoll æ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„ Linux I/O äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œç”¨æ¥å®žçŽ°å¤šè·¯å¤ç”¨ (Multiplexing)ã€‚å®ƒå°†å”¤é†’äº‹ä»¶æŒ‰å¯¹åº”çš„ fd æ³¨å†Œè¿› epollï¼Œç„¶åŽ epoll å¸®ä½ ç›‘å¬å“ªäº›å”¤é†’äº‹ä»¶ä¸Šæœ‰æ¶ˆæ¯åˆ°è¾¾ã€‚æ­¤æ—¶çš„å”¤é†’äº‹ä»¶åº”è¯¥é‡‡ç”¨éžé˜»å¡žæ¨¡å¼ã€‚è¿™æ ·ï¼Œæ•´ä¸ªè¿‡ç¨‹åªåœ¨è°ƒç”¨ epoll çš„æ—¶å€™æ‰ä¼šé˜»å¡žï¼Œæ”¶å‘å®¢æˆ·æ¶ˆæ¯æ˜¯ä¸ä¼šé˜»å¡žçš„ï¼Œæ•´ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹å°±è¢«å……åˆ†åˆ©ç”¨èµ·æ¥ï¼Œè¿™å°±æ˜¯äº‹ä»¶é©±åŠ¨ï¼Œæ‰€è°“çš„å“åº”æ¨¡å¼ã€‚ ä¸Šé¢çš„ä»£ç ä¸­ä½¿ç”¨äº† epoll_ctl æ–¹æ³•æ¥å°†è¢«ç›‘å¬çš„æè¿°ç¬¦æ·»åŠ åˆ° epoll å¥æŸ„ã€‚å…³äºŽ epoll çš„æŒ‡ä»¤ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡åšæ–‡ ã€Šepollæœºåˆ¶:epoll_createã€epoll_ctlã€epoll_waitã€closeã€‹ã€‚è¿™éƒ¨åˆ†ä»£ç çš„ä¸»è¦ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ª epoll å®žä¾‹å¹¶ç”¨å®ƒæ¥ç›‘å¬ event è§¦å‘ã€‚ 2.4 æ¶ˆæ¯çš„æ‰§è¡Œè¿‡ç¨‹2.4.1 æ¶ˆæ¯å…¥é˜Ÿçš„è¿‡ç¨‹åœ¨ä»‹ç» Handler çš„ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿè¯´è¿‡ä¸è®ºæ˜¯ Runnable è¿˜æ˜¯ Message æœ€ç»ˆéƒ½ä¼šè¢«å°è£…æˆ Meseage å¹¶åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚é‚£ä¹ˆï¼ŒåŠ å…¥é˜Ÿåˆ—ä¹‹åŽåˆæ˜¯æ€Žä¹ˆè¢«æ‰§è¡Œçš„å‘¢ï¼Ÿ é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹å…¥é˜Ÿçš„è¿‡ç¨‹ã€‚ä»¥ä¸‹æ˜¯ Handler ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œæ¯å½“æˆ‘ä»¬å°†ä¸€ä¸ªæ¶ˆæ¯å…¥é˜Ÿçš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨å®ƒæ¥å®Œæˆã€‚ private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) { msg.target = this; if (mAsynchronous) { msg.setAsynchronous(true); } return queue.enqueueMessage(msg, uptimeMillis); } ä»Žä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œå…¥é˜Ÿçš„æ—¶å€™å®žé™…ä¸Šæ˜¯ä½¿ç”¨äº† MessageQueue çš„ enqueueMessage() æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹è¯¥æ–¹æ³•çš„å®šä¹‰ï¼š boolean enqueueMessage(Message msg, long when) { // ... æ— å…³ä»£ç ï¼Œæ ¡éªŒ synchronized (this) { // ... æ— å…³ä»£ç  Message p = mMessages; boolean needWake; if (p == null || when == 0 || when &lt; p.when) { msg.next = p; mMessages = msg; needWake = mBlocked; } else { needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous(); Message prev; for (;;) { prev = p; p = p.next; if (p == null || when &lt; p.when) { break; } if (needWake &amp;&amp; p.isAsynchronous()) { needWake = false; } } msg.next = p; prev.next = msg; } if (needWake) { nativeWake(mPtr); } } return true; } ä»Žä¸Šé¢çš„æ–¹æ³•å¯ä»¥çœ‹å‡ºï¼Œæ‰€è°“çš„å…¥é˜Ÿæ“ä½œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå°†æ–°çš„æ¶ˆæ¯åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­çš„é€»è¾‘ã€‚å½“ç„¶ï¼Œè¿™é‡ŒåŠ å…¥çš„æ—¶å€™è¦æ ¹æ®æ¶ˆæ¯çš„è§¦å‘æ—¶é—´å¯¹æ¶ˆæ¯è¿›è¡ŒæŽ’åºã€‚ç„¶åŽï¼Œä¼šæ ¹æ® needWake æ¥å†³å®šæ˜¯å¦è°ƒç”¨ native å±‚çš„æ–¹æ³•è¿›è¡Œå”¤é†’ã€‚åªæœ‰å½“å½“å‰çš„å¤´ç»“ç‚¹æ¶ˆæ¯ä¹‹å‰å­˜åœ¨æ …æ  (barrier) å¹¶ä¸”æ–°æ’å…¥çš„æ¶ˆæ¯æ˜¯æœ€å…ˆè¦è¢«è§¦å‘çš„å¼‚æ­¥æ¶ˆæ¯å°±è¿›è¡Œå”¤é†’ã€‚å½“ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ— éœ€è¿›è¡Œå”¤é†’çš„ã€‚ è¿™é‡Œçš„ nativeWake() æ–¹æ³•ä¼šæœ€ç»ˆè°ƒç”¨ native å±‚çš„ Looper çš„ awake() æ–¹æ³•ï¼š void Looper::wake() { uint64_t inc = 1; ssize_t nWrite = TEMP_FAILURE_RETRY(write(mWakeEventFd.get(), &amp;inc, sizeof(uint64_t))); if (nWrite != sizeof(uint64_t)) { if (errno != EAGAIN) { LOG_ALWAYS_FATAL(&quot;Could not write wake signal to fd %d: %s&quot;, mWakeEventFd.get(), strerror(errno)); } } } æ­¤æ–¹æ³•å‘ mWakeEventFd å†™å…¥äº†ä¸€ä¸ªå­—èŠ‚çš„å†…å®¹ã€‚åˆ°åº•æ˜¯ä»€ä¹ˆå†…å®¹å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ fd å­˜åœ¨å†…å®¹äº†ï¼Œæ¢å¥è¯è¯´å°±æ˜¯ mWakeEventFd å¯è¯»äº†ï¼Œä¹Ÿå°±æ˜¯ Native å±‚çš„ Looper çš„çº¿ç¨‹ä»Ž block çŠ¶æ€ä¸­é†’äº†è¿‡æ¥ã€‚ä¹‹æ‰€ä»¥éœ€è¦è¿›è¡Œå”¤é†’ï¼Œæ˜¯å› ä¸ºï¼Œæ¯æ¬¡æˆ‘ä»¬å¤„ç†äº†æ¶ˆæ¯ä¹‹åŽä¼šæ ¹æ®ä¸‹ä¸ªæ¶ˆæ¯æ‰§è¡Œçš„æ—¶é—´è¿›è¡Œå”¤é†’ã€‚å¦‚æžœæ–°æ’å…¥çš„æ¶ˆæ¯æ˜¯æœ€æ–°çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå”¤é†’çš„æ—¶é—´é‡ç½®ã€‚ï¼ˆNative å±‚çš„ Looper ä¼šåœ¨æˆ‘ä»¬è°ƒç”¨ Java å±‚çš„ MessageQueue çš„æ—¶å€™æ‰§è¡Œ epoll_wait æ—¶è¿›å…¥ block çŠ¶æ€ã€‚ï¼‰ 2.4.2 æ¶ˆæ¯æ‰§è¡Œçš„è¿‡ç¨‹åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬åˆ†æžäº† MessageQueue å°†æ¶ˆæ¯å…¥é˜Ÿçš„è¿‡ç¨‹ã€‚é‚£ä¹ˆè¿™äº›æ¶ˆæ¯è¦åœ¨ä»€ä¹ˆæ—¶å€™è¢«æ‰§è¡Œå‘¢ï¼Ÿåœ¨ä»‹ç» Handler çš„ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿæåˆ°è¿‡å½“æˆ‘ä»¬å®žä¾‹åŒ–äº† Looper ä¹‹åŽéƒ½åº”è¯¥è°ƒç”¨å®ƒçš„ loop() é™æ€æ–¹æ³•æ¥å¤„ç†æ¶ˆæ¯ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®šä¹‰ã€‚ public static void loop() { final Looper me = myLooper(); // .. æ— å…³ä»£ç  final MessageQueue queue = me.mQueue; // .. æ— å…³ä»£ç  for (;;) { Message msg = queue.next(); // å¯èƒ½ä¼š bolck if (msg == null) { return; } // ... æ— å…³ä»£ç  final long dispatchEnd; try { msg.target.dispatchMessage(msg); dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : 0; } finally { if (traceTag != 0) { Trace.traceEnd(traceTag); } } // ... æ— å…³ä»£ç  msg.recycleUnchecked(); } } ä»Žä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå½“è¯¥æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒä¼šå…ˆå¼€å¯ä¸€ä¸ªæ— é™å¾ªçŽ¯ï¼Œå¹¶åœ¨è¯¥å¾ªçŽ¯ä¸­ä½¿ç”¨ MessageQueue çš„ next() æ–¹æ³•æ¥å–å‡ºä¸‹ä¸€ä¸ªæ¶ˆæ¯å¹¶è¿›è¡Œåˆ†å‘ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆä¸çœ‹ next() æ–¹æ³•çš„å®šä¹‰ã€‚æˆ‘ä»¬å…ˆæŠŠè¿™ä¸ªæ–¹æ³•ä¸­æ¶‰åŠçš„éƒ¨åˆ†åˆ†æžä¸€ä¸‹ã€‚ å½“èŽ·å–åˆ°äº†ä¸‹ä¸€ä¸ªæ¶ˆæ¯ä¹‹åŽï¼Œä¼šè°ƒç”¨å®ƒçš„target ä¹Ÿå°±æ˜¯å‘é€è¯¥æ¶ˆæ¯çš„ Handler çš„ dispatchMessage() æ–¹æ³•æ¥è¿›è¡Œå¤„ç†ã€‚è¯¥æ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹ï¼š public void dispatchMessage(Message msg) { if (msg.callback != null) { handleCallback(msg); } else { if (mCallback != null) { if (mCallback.handleMessage(msg)) { return; } } handleMessage(msg); } } ä»Žä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œå¦‚æžœè¯¥æ¶ˆæ¯æ˜¯é€šè¿‡åŒ…è£… Runnable å¾—åˆ°çš„è¯ï¼Œä¼šç›´æŽ¥è°ƒç”¨å®ƒçš„ handleCallback() æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚åœ¨è¯¥æ–¹æ³•å†…éƒ¨ä¼šç›´æŽ¥è°ƒç”¨ Runnable çš„ run() æ–¹æ³•ã€‚å› ä¸ºæ¯”è¾ƒè§åˆ°é‚£ï¼Œæˆ‘ä»¬å°±è¡¥è´´å‡ºä»£ç äº†ã€‚ ç„¶åŽï¼Œä¼šæ ¹æ® mCallback æ˜¯å¦ä¸ºç©ºæ¥å†³å®šæ˜¯äº¤ç»™ mCallback è¿›è¡Œå¤„ç†è¿˜æ˜¯å†…éƒ¨çš„ handleMessage() æ–¹æ³•ã€‚è¿™é‡Œçš„ mCallback æ˜¯ä¸€ä¸ªæŽ¥å£ï¼Œå¯ä»¥åœ¨åˆ›å»º Handler çš„æ—¶å€™é€šè¿‡æž„é€ æ–¹æ³•æŒ‡å®šï¼Œä¹Ÿæ¯”è¾ƒç®€å•ã€‚è€Œè¿™é‡Œçš„ handleMessage() æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å†ç†Ÿæ‚‰ä¸è¿‡äº†ï¼Œå®ƒå°±æ˜¯æˆ‘ä»¬åˆ›å»º Handler çš„æ—¶å€™é‡å†™çš„ã€ç”¨æ¥å¤„ç†æ¶ˆæ¯çš„æ–¹æ³•ã€‚è¿™æ ·ï¼Œæ¶ˆæ¯å°±è¢«å‘é€åˆ°äº†æˆ‘ä»¬çš„ Handler ä¸­è¿›è¡Œå¤„ç†äº†ã€‚ ä»¥ä¸Šå°±æ˜¯æ¶ˆæ¯è¢«å¤„ç†çš„è¿‡ç¨‹ï¼Œä»£ç çš„é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸‹ MessageQueue æ˜¯å¦‚ä½•èŽ·å– â€œä¸‹ä¸€ä¸ªâ€ æ¶ˆæ¯çš„ã€‚ 2.4.3 MessageQueue çš„æ¶ˆæ¯ç®¡ç†ä¸Šé¢æˆ‘ä»¬å·²ç»åˆ†æžå®Œäº† Handler å‘é€çš„æ¶ˆæ¯æ‰§è¡Œçš„è¿‡ç¨‹ã€‚è¿™é‡Œæˆ‘ä»¬åœ¨æ¥åˆ†æžä¸€ä¸‹å…¶ä¸­çš„èŽ·å– â€œä¸‹ä¸€ä¸ªâ€ æ¶ˆæ¯çš„é€»è¾‘ï¼š Message next() { // å¦‚æžœæ¶ˆæ¯å¾ªçŽ¯å·²ç»åœæ­¢å°±ç›´æŽ¥è¿”å›žã€‚å¦‚æžœåº”ç”¨å°è¯•é‡å¯å·²ç»åœæ­¢çš„Looperå°±ä¼šå¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µã€‚ final long ptr = mPtr; if (ptr == 0) { return null; } int pendingIdleHandlerCount = -1; // -1 only during first iteration int nextPollTimeoutMillis = 0; for (;;) { if (nextPollTimeoutMillis != 0) { Binder.flushPendingCommands(); } // è°ƒç”¨ native çš„æ–¹æ³•ï¼Œå¯èƒ½ä¼šè¿™ä¸ªå‡½æ•°å‘ç”Ÿ block nativePollOnce(ptr, nextPollTimeoutMillis); // ... æ— å…³ä»£ç  } } ä»Žä¸Šé¢å¯ä»¥çœ‹å‡º Java å±‚çš„ MessageQueue çš„ next() æ–¹æ³•æ˜¯ä¸€ä¸ªå¾ªçŽ¯ã€‚é™¤äº†èŽ·å–æ¶ˆæ¯é˜Ÿåˆ—ä¹‹å¤–ï¼Œè¿˜è¦ç›‘å¬ Natvie å±‚ Looper çš„äº‹ä»¶è§¦å‘ã€‚é€šè¿‡è°ƒç”¨ native å±‚çš„ nativePollOnce() æ–¹æ³•æ¥å®žçŽ°ã€‚è¯¥æ–¹æ³•å†…éƒ¨åˆä¼šè°ƒç”¨ NativeMessageQueue çš„ pollOnce() æ–¹æ³•ã€‚è€Œä¸”æ³¨æ„ä¸‹ï¼Œåœ¨ä¸‹é¢çš„æ–¹æ³•ä¸­ï¼ŒnativeMessageQueue æ˜¯ä»Ž Java å±‚çš„ mPtr ä¸­èŽ·å–åˆ°çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¯´ï¼Œåœ¨åˆå§‹åŒ– MessageQueue çš„æ—¶å€™å¾—åˆ°çš„ mPtr èµ·åˆ°äº†æ¡¥æ¢çš„ä½œç”¨ï¼š static void android_os_MessageQueue_nativePollOnce(JNIEnv* env, jobject obj, jlong ptr, jint timeoutMillis) { NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); nativeMessageQueue-&gt;pollOnce(env, obj, timeoutMillis); } åœ¨ NativeMessageQueue çš„ pollOnce() æ–¹æ³•ä¸­ä¼šè°ƒç”¨ native å±‚çš„ Looper çš„ pollOnce()ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨ native å±‚ Looper çš„ pollInner() æ–¹æ³•ï¼š int Looper::pollInner(int timeoutMillis) { // ... æ ¹æ®ä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„äº‹ä»¶è°ƒæ•´è¶…æ—¶æ—¶é—´ int result = POLL_WAKE; mResponses.clear(); mResponseIndex = 0; mPolling = true; // å°†è¦ç©ºé—² struct epoll_event eventItems[EPOLL_MAX_EVENTS]; // å¾…å·²æ³¨å†Œä¹‹äº‹ä»¶è¢«è§¦å‘æˆ–è®¡æ—¶ç»ˆäº† int eventCount = epoll_wait(mEpollFd.get(), eventItems, EPOLL_MAX_EVENTS, timeoutMillis); mPolling = false; // ä¸å†ç©ºé—² mLock.lock(); // è¯·æ±‚é” if (mEpollRebuildRequired) { mEpollRebuildRequired = false; rebuildEpollLocked(); // æ ¹æ®éœ€è¦é‡å»º epoll goto Done; } // è¿›è¡Œæ£€æŸ¥ if (eventCount &lt; 0) { if (errno == EINTR) { goto Done; } result = POLL_ERROR; // é”™è¯¯ goto Done; } if (eventCount == 0) { result = POLL_TIMEOUT; // è¶…æ—¶ goto Done; } // å¤„ç†æ‰€æœ‰æ¶ˆæ¯ for (int i = 0; i &lt; eventCount; i++) { int fd = eventItems[i].data.fd; uint32_t epollEvents = eventItems[i].events; if (fd == mWakeEventFd.get()) { // å”¤é†’ fd æœ‰ååº” if (epollEvents &amp; EPOLLIN) { awoken(); // å·²ç»å”¤é†’äº†ï¼Œåˆ™è¯»å–å¹¶æ¸…ç©ºç®¡é“æ•°æ® } } else { // å…¶ä»– input fd å¤„ç†ï¼Œå…¶å®žå°±æ˜¯å°†æ´»åŠ¨ fd æ”¾å…¥åˆ° responses é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å¤„ç† ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &gt;= 0) { int events = 0; if (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT; if (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT; if (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR; if (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP; // å°†æ¶ˆæ¯æ”¾è¿› mResponses ä¸­ pushResponse(events, mRequests.valueAt(requestIndex)); } } } Done: ; // è§¦å‘æ‰€æœ‰çš„æ¶ˆæ¯å›žè°ƒï¼Œå¤„ç† Native å±‚çš„Message mNextMessageUptime = LLONG_MAX; while (mMessageEnvelopes.size() != 0) { nsecs_t now = systemTime(SYSTEM_TIME_MONOTONIC); const MessageEnvelope&amp; messageEnvelope = mMessageEnvelopes.itemAt(0); if (messageEnvelope.uptime &lt;= now) { { // èŽ·å– handler sp&lt;MessageHandler&gt; handler = messageEnvelope.handler; Message message = messageEnvelope.message; mMessageEnvelopes.removeAt(0); mSendingMessage = true; mLock.unlock(); handler-&gt;handleMessage(message); } // é‡Šæ”¾ handler mLock.lock(); mSendingMessage = false; result = POLL_CALLBACK; } else { // é˜Ÿåˆ—å¤´éƒ¨çš„æ¶ˆæ¯å†³å®šäº†ä¸‹ä¸ªå”¤é†’çš„æ—¶é—´ mNextMessageUptime = messageEnvelope.uptime; break; } } mLock.unlock(); // é‡Šæ”¾é” // è§¦å‘æ‰€æœ‰çš„å“åº”å›žè°ƒ for (size_t i = 0; i &lt; mResponses.size(); i++) { Response&amp; response = mResponses.editItemAt(i); if (response.request.ident == POLL_CALLBACK) { int fd = response.request.fd; int events = response.events; void* data = response.request.data; int callbackResult = response.request.callback-&gt;handleEvent(fd, events, data); if (callbackResult == 0) { removeFd(fd, response.request.seq); // ç§»é™¤æ–‡ä»¶æè¿°ç¬¦ } response.request.callback.clear(); result = POLL_CALLBACK; } } return result; } ä»Žä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡º Native å±‚çš„ pollInner() æ–¹æ³•é¦–å…ˆä¼šæ ¹æ® Java å±‚ä¼ å…¥çš„ timeoutMillis è°ƒç”¨ epoll_wait æ–¹æ³•æ¥è®©çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚å¦‚æžœ timeoutMillis ä¸ä¸º 0ï¼Œé‚£ä¹ˆçº¿ç¨‹å°†è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚å¦‚æžœæœ‰äº‹ä»¶è§¦å‘å‘ç”Ÿï¼Œwake æˆ–è€…å…¶ä»–å¤ç”¨ Looper çš„ eventï¼Œå¤„ç†eventï¼Œè¿™æ ·æ•´ä¸ª Native å±‚çš„ Looper å°†ä»Ž block çŠ¶æ€ä¸­è§£è„±å‡ºæ¥äº†ã€‚è¿™æ ·å›žåˆ° Java å±‚å°±å°†ç»§ç»­æ‰§è¡Œ MessageQueue ä¸­ä¸‹ä¸€æ¡è¯­å¥ã€‚è‡³äºŽ Native å±‚çš„ Looper ä½•æ—¶ä»Ž block çŠ¶æ€ä¸­é†’è¿‡æ¥ï¼Œå°±éœ€è¦æ ¹æ®æˆ‘ä»¬å…¥é˜Ÿçš„æ¶ˆæ¯æ¥å®šã€‚ä¹Ÿå°±ç”¨åˆ°äº† MessageQueue çš„ enqueueMessage() æ–¹æ³•çš„æœ€åŽå‡ è¡Œä»£ç ï¼š if (needWake) { nativeWake(mPtr); } å³ï¼šåªæœ‰å½“å½“å‰çš„å¤´ç»“ç‚¹æ¶ˆæ¯ä¹‹å‰å­˜åœ¨æ …æ  (barrier) å¹¶ä¸”æ–°æ’å…¥çš„æ¶ˆæ¯æ˜¯æœ€å…ˆè¦è¢«è§¦å‘çš„å¼‚æ­¥æ¶ˆæ¯å°±è¿›è¡Œå”¤é†’ã€‚ ä¸Šé¢ä¸»è¦æ˜¯ Native å±‚çš„ Looper çº¿ç¨‹ block çš„ç›¸å…³çš„é€»è¾‘ã€‚å³å½“æˆ‘ä»¬èŽ·å–æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸‹ä¸€æ¡æ¶ˆæ¯çš„æ—¶å€™ä¼šæ ¹æ®ä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶é—´æ¥å†³å®šçº¿ç¨‹ block çš„æ—¶é•¿ã€‚å½“æˆ‘ä»¬å°†ä¸€ä¸ªæ¶ˆæ¯åŠ å…¥åˆ°é˜Ÿåˆ—çš„æ—¶å€™ä¼šæ ¹æ®æ–°çš„æ¶ˆæ¯çš„æ—¶é—´é‡æ–°è°ƒæ•´çº¿ç¨‹ block çš„æ—¶é•¿ï¼Œå¦‚æžœéœ€è¦çš„è¯è¿˜éœ€è¦å”¤èµ· block çš„çº¿ç¨‹ã€‚å½“çº¿ç¨‹ä»Ž block çŠ¶æ€æ¢å¤å‡ºæ¥çš„æ—¶å€™ï¼ŒJava å±‚çš„ Looper å°±æ‹¿åˆ°äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œå¯¹è¯¥æ¶ˆæ¯è¿›è¡Œå¤„ç†å³å¯ã€‚ 3ã€æ€»ç»“åœ¨ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬ä»Ž Java å±‚åˆ° Native å±‚åˆ†æžäº† Handler çš„ä½œç”¨çš„åŽŸç†ã€‚è¿™é‡Œæˆ‘ä»¬å¯¹è¿™éƒ¨åˆ†å†…å®¹åšä¸€ä¸ªæ€»ç»“ã€‚ 3.1 Handlerã€MessageQueue å’Œ Looper ä¹‹é—´çš„å…³ç³»é¦–å…ˆæ˜¯ Handlerã€MessageQueue å’Œ Looper ä¹‹é—´çš„å…³ç³»ã€‚æˆ‘ä»¬ç”¨ä¸‹é¢çš„è¿™ä¸ªå›¾æ¥è¡¨ç¤ºï¼š ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸­å¯ä»¥å®šä¹‰å¤šä¸ª Handler å®žä¾‹ï¼Œä½†æ˜¯æ¯ä¸ª Handler å®žé™…ä¸Šå¼•ç”¨çš„æ˜¯åŒä¸€ä¸ª Looperã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è¦åœ¨åˆ›å»º Handler ä¹‹å‰å…ˆåˆ›å»º Looperã€‚è€Œæ¯ä¸ª Looper åˆåªå¯¹åº”ä¸€ä¸ª MessageQueueã€‚è¯¥ MessageQueue ä¼šåœ¨åˆ›å»º Looper çš„æ—¶å€™è¢«åˆ›å»ºã€‚åœ¨ MessageQueue ä¸­ä½¿ç”¨ Message å¯¹è±¡æ¥æ‹¼æŽ¥ä¸€ä¸ªå•å‘çš„é“¾è¡¨ç»“æž„ï¼Œä¾æ¬¡æ¥æž„æˆä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚æ¯ä¸ª Message æ˜¯é“¾è¡¨çš„ä¸€ä¸ªç»“ç‚¹ï¼Œå°è£…äº†æˆ‘ä»¬å‘é€çš„ä¿¡æ¯ã€‚ 3.2 Handler çš„æ¶ˆæ¯å‘é€è¿‡ç¨‹ç„¶åŽï¼Œæˆ‘ä»¬å†æ¥åˆ†æžä¸‹ Handler ä¸­çš„æ¶ˆæ¯æ˜¯å¦‚ä½•è¢«å‘é€çš„ã€‚åŒæ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå›¾æ¥è¿›è¡Œåˆ†æžï¼š æ ¹æ®ä¸Šæ–‡çš„å†…å®¹æˆ‘ä»¬å°† Handler å‘é€æ¶ˆæ¯çš„æ–¹æ³•åˆ†æˆ post å’Œ send ä¸¤ç§ç±»åž‹ã€‚post çš„ç”¨æ¥å‘é€ Runnable ç±»åž‹çš„æ•°æ®ï¼Œsend ç±»åž‹çš„ç”¨æ¥å‘é€ Message ç±»åž‹çš„æ•°æ®ã€‚ä½†ä¸è®ºå“ªç§ç±»åž‹æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ Handler çš„ sendMessageAtTime() æ–¹æ³•æ¥åŠ å…¥åˆ° MessageQueue çš„é˜Ÿåˆ—ä¸­ã€‚åŒºåˆ«åœ¨äºŽï¼Œpost ç±»åž‹çš„æ–¹æ³•éœ€è¦ç»è¿‡ Handler çš„ getPostMessage() åŒ…è£…æˆ Message ä¹‹åŽå†å‘é€ã€‚ 3.3 Looper çš„æ‰§è¡Œè¿‡ç¨‹å½“æ¶ˆæ¯è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¹‹åŽéœ€è¦æ‰§è¡Œæ¶ˆæ¯ï¼Œè¿™éƒ¨åˆ†å†…å®¹åœ¨ Looper çš„ loop() æ–¹æ³•ä¸­ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†å†…å®¹ç¨æ˜¾å¤æ‚ï¼Œå› ä¸ºæ¶‰åŠ Native å±‚çš„ä¸€äº›ä¸œè¥¿ã€‚æˆ‘ä»¬è¿™é‡Œä»ç„¶ä½¿ç”¨å›¾æ¥è¿›è¡Œæè¿°ï¼š å½“æˆ‘ä»¬è°ƒç”¨ Looper çš„ loop() æ–¹æ³•ä¹‹åŽæ•´ä¸ª Looper å¾ªçŽ¯å°±å¼€å§‹ä¸æ–­åœ°å¤„ç†æ¶ˆæ¯äº†ã€‚åœ¨ä¸Šå›¾ä¸­å°±æ˜¯æˆ‘ä»¬ç”¨ç»¿è‰²æ ‡è®°çš„ä¸€ä¸ªå¾ªçŽ¯ã€‚å½“æˆ‘ä»¬åœ¨å¾ªçŽ¯ä¸­è°ƒç”¨ MessageQueue çš„ next() æ–¹æ³•æ¥èŽ·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ nativePollOnce() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯èƒ½ä¼šé€ æˆçº¿ç¨‹é˜»å¡žå’Œéžé˜»å¡žï¼Œå½“çº¿ç¨‹ä¸ºéžé˜»å¡žçš„æ—¶å€™å°±ä¼šä»Ž Native å±‚å›žåˆ° Java å±‚ï¼Œä»Ž MessageQueuue ä¸­å–å¾—ä¸€ä¸ªæ¶ˆæ¯ä¹‹åŽç»™ Looper è¿›è¡Œå¤„ç†ã€‚å¦‚æžœèŽ·å–çš„æ—¶å€™é€ æˆçº¿ç¨‹é˜»å¡žï¼Œé‚£ä¹ˆæœ‰ä¸¤ç§æƒ…å†µä¼šå”¤é†’é˜»å¡žçš„çº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯å½“ä¸€ä¸ªæ–°çš„æ¶ˆæ¯è¢«åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”å°†ä¼šæ—©äºŽä¹‹å‰é˜Ÿåˆ—çš„æ‰€æœ‰æ¶ˆæ¯è¢«è§¦å‘ï¼Œé‚£ä¹ˆæ­¤æ—¶å°†ä¼šé‡æ–°è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚å¦‚æžœè¾¾åˆ°äº†è¶…æ—¶æ—¶é—´åŒæ ·å¯ä»¥ä»Žç¡çœ çŠ¶æ€ä¸­è¿”å›žï¼Œä¹Ÿå°±å›žåˆ°äº† Java å±‚ç»§ç»­å¤„ç†ã€‚æ‰€ä»¥ï¼ŒNative å±‚çš„ Looper çš„ä½œç”¨å°±æ˜¯é€šè¿‡é˜»å¡žæ¶ˆæ¯é˜Ÿåˆ—èŽ·å–æ¶ˆæ¯çš„è¿‡ç¨‹é˜»å¡ž Looperã€‚ 3.4 æœ€åŽå› ä¸ºæœ¬æ–‡ä¸­ä¸ä»…åˆ†æžäº† Java å±‚çš„ä»£ç ï¼ŒåŒæ—¶åˆ†æžäº† framework å±‚çš„ä»£ç ï¼Œæ‰€ä»¥æœ€å¥½èƒ½å¤Ÿç»“åˆä¸¤è¾¹çš„æºç ä¸€èµ·çœ‹ï¼Œè¿™æ ·æ›´æœ‰åŠ©äºŽè‡ªå·±çš„ç†è§£ã€‚åœ¨ä¸Šé¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç»™å‡ºäº†ä¸€äº›ç±»çš„åœ¨çº¿çš„ä»£ç é“¾æŽ¥ï¼Œåœ¨ Google Source ä¸Šé¢ï¼Œéœ€è¦ VPN æ‰èƒ½æµè§ˆã€‚å¦å¤–ï¼Œå› ä¸ºç¬”è€…æ°´å¹³æœ‰é™ï¼Œéš¾å…å­˜åœ¨æœ‰è¯¯å’Œä¸è¶³çš„åœ°æ–¹ï¼Œæ¬¢è¿Žæ‰¹è¯„æŒ‡æ­£ã€‚ æˆ‘æ˜¯ WngShhng. å¦‚æžœæ‚¨å–œæ¬¢æˆ‘çš„æ–‡ç« ï¼Œå¯ä»¥åœ¨ä»¥ä¸‹å¹³å°å…³æ³¨æˆ‘ï¼š ä¸ªäººä¸»é¡µï¼šhttps://shouheng88.github.io/ æŽ˜é‡‘ï¼šhttps://juejin.im/user/585555e11b69e6006c907a2a Githubï¼šhttps://github.com/Shouheng88 CSDNï¼šhttps://blog.csdn.net/github_35186068 å¾®åšï¼šhttps://weibo.com/u/5401152113]]></content>
      <categories>
        <category>Androidæ¶ˆæ¯æœºåˆ¶</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>æºç é˜…è¯»</tag>
        <tag>Framework</tag>
        <tag>Handler</tag>
        <tag>Looper</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åŠ¨æ€ä»£ç†åœ¨ Android ä¸­çš„åº”ç”¨ï¼šRetrofit æºç è§£æž]]></title>
    <url>%2F2018%2F10%2F20%2F%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%9C%A8%20Android%20%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%9ARetrofit%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%2F</url>
    <content type="text"><![CDATA[åœ¨ä¹‹å‰çš„æ–‡ç«  ã€ŠAndriod ç½‘ç»œæ¡†æž¶ OkHttp æºç è§£æžã€‹ ä¸­æˆ‘ä»¬åˆ†æžäº† OkHttp çš„æºä»£ç ã€‚çŽ°åœ¨æˆ‘ä»¬å°±æ¥åˆ†æžä¸€ä¸‹ OkHttp çš„å…„å¼Ÿæ¡†æž¶ Retrofitã€‚å…³äºŽ Retrofit çš„æ³¨è§£çš„ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒå…¶å®˜æ–¹æ–‡æ¡£ï¼šhttps://square.github.io/retrofit/ã€‚ Retrofit ä¹Ÿæ˜¯ Square å‘å¸ƒçš„ä¸€ä¸ªå¼€æºçš„åº“ï¼Œå®ƒæ˜¯ä¸€ä¸ªç±»åž‹å®‰å…¨çš„ Http å®¢æˆ·ç«¯ï¼Œé€‚ç”¨äºŽ Android å’Œ Javaã€‚æœ¬è´¨ä¸Šï¼ŒRetrofit ä½¿ç”¨äº† Java çš„åŠ¨æ€ä»£ç†ï¼Œå†…éƒ¨ä½¿ç”¨ OkHttp æ¥è¿›è¡Œç½‘ç»œè®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æŒ‡å®š â€œè¯·æ±‚é€‚é…å™¨â€ å’Œ â€œç±»åž‹è½¬æ¢å™¨â€ æ¥å®Œæˆæ–¹æ³•å‚æ•°åˆ° OkHttp çš„è¯·æ±‚çš„è½¬æ¢ï¼Œä»¥åŠ OkHttp å“åº”åˆ°ç”¨æˆ·æŒ‡å®šçš„å®žä½“ç±»åž‹çš„è½¬æ¢ã€‚ 1ã€åŸºæœ¬ä½¿ç”¨Retrofit è®¾è®¡çš„ä¸€ä¸ªå¥½çš„åœ°æ–¹å°±æ˜¯å®ƒæŠŠæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ â€œè¯·æ±‚é€‚é…å™¨â€ å’Œ â€œç±»åž‹è½¬æ¢å™¨â€ ä½¿ç”¨ç­–ç•¥æ¨¡å¼è§£è€¦å‡ºæ¥ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é€šè¿‡å®žçŽ°æŒ‡å®šçš„æŽ¥å£æ¥è‡ªå®šä¹‰è‡ªå·±çš„ç±»åž‹è½¬æ¢å™¨ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ Gson å’Œ RxJava2 è½¬æ¢å™¨çš„æ—¶å€™ï¼Œå°±éœ€è¦æŒ‡å®šä¸‹é¢ä¸‰ä¸ªä¾èµ–ï¼š api &apos;com.squareup.retrofit2:retrofit:2.4.0&apos; api &apos;com.squareup.retrofit2:converter-gson:2.4.0&apos; api &apos;com.squareup.retrofit2:adapter-rxjava2:2.4.0&apos; ç„¶åŽï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è‡ªå·±çš„ API æŽ¥å£çš„ä¿¡æ¯ï¼Œåœ¨ä»£ç é‡Œç”¨ä¸€ä¸ªæŽ¥å£æ¥å¯¹è¯¥ API æŽ¥å£è¿›è¡Œå£°æ˜Žï¼š public interface WXInfoService { @GET(&quot;/sns/userinfo&quot;) Observable&lt;WXUserInfo&gt; getWXUserInfo( @Query(&quot;access_token&quot;) String accessToken, @Query(&quot;openid&quot;) String openId); } è¿™é‡Œçš„ WXUserInfo æ˜¯ç”±è¯¥ API æŽ¥å£è¿”å›žçš„ Json ç”Ÿæˆçš„ Java å¯¹è±¡ã€‚ç„¶åŽï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·èŽ·å–ä¸€ä¸ªè¯¥æŽ¥å£çš„ä»£ç†å¯¹è±¡ï¼š WXInfoService wXInfoService = new Retrofit.Builder() .baseUrl(&quot;https://api.weixin.qq.com/&quot;) .addConverterFactory(GsonConverterFactory.create()) .addCallAdapterFactory(RxJava2CallAdapterFactory.create()) .client(okHttpClient) .build().create(WXInfoService.class); ç„¶åŽï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¯¥å¯¹è±¡å¹¶è°ƒç”¨å…¶æ–¹æ³•æ¥èŽ·å–æŽ¥å£è¿”å›žçš„ä¿¡æ¯äº†ï¼š Disposable disposable = wxInfoService.getWXUserInfo(accessToken, openId) .subscribeOn(Schedulers.io()) .observeOn(AndroidSchedulers.mainThread()) .subscribe(wxUserInfo -&gt; { /*...æ‹¿åˆ°ç»“æžœä¹‹åŽè¿›è¡Œå¤„ç†...*/ }); ä¸Šé¢æˆ‘ä»¬åªæ˜¯ä½¿ç”¨äº† Retrofit çš„æœ€åŸºç¡€çš„ GET æŽ¥å£ã€‚å½“ç„¶ï¼ŒRetrofit æœ¬èº«çš„åŠŸèƒ½è¿œæ¯”è¿™è¦ä¸°å¯Œå¾—å¤šï¼Œå…³äºŽå…¶æ›´å¤šçš„ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒå…¶å®˜æ–¹çš„æ–‡æ¡£ã€‚ 2ã€åŠ¨æ€ä»£ç†ï¼šé­”åŠ›å‘ç”Ÿçš„åœ°æ–¹ä¸Šé¢æˆ‘ä»¬ä½¿ç”¨ Retrofit è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œå®žé™…å…¶å†…éƒ¨ä½¿ç”¨ OkHttp æ¥å®Œæˆç½‘ç»œè¯·æ±‚çš„ï¼Œç„¶åŽï¼Œä½¿ç”¨æˆ‘ä»¬ä¼ å…¥çš„ â€œç±»åž‹è½¬æ¢å™¨â€ æŠŠå“åº”è½¬æ¢æˆæˆ‘ä»¬æŒ‡å®šçš„ç±»åž‹ã€‚å®šä¹‰äº†ä¸€ä¸ªæŽ¥å£å¹¶è°ƒç”¨äº†è¯¥æŽ¥å£çš„æ–¹æ³•ï¼Œç„¶åŽå°±æ‹¿åˆ°äº†è¯·æ±‚çš„ç»“æžœï¼Œè¿™çœ‹ä¸ŠåŽ»éžå¸¸ç®€æ´ï¼Œè€Œè¿™å…¶ä¸­çš„æœ€åŠŸä¸å¯æ²¡çš„å°±æ˜¯åŠ¨æ€ä»£ç†ã€‚ å½“æˆ‘ä»¬ä½¿ç”¨ Retrofit.Builder çš„ create() æ–¹æ³•èŽ·å–ä¸€ä¸ª WXInfoService å®žä¾‹çš„æ—¶å€™ï¼Œå®žé™…è¿”å›žçš„æ˜¯ç»è¿‡ä»£ç†ä¹‹åŽçš„å¯¹è±¡ã€‚è¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ Proxy çš„é™æ€æ–¹æ³• newProxyInstance() æ¥å¾—åˆ°ä¸€ä¸ªä»£ç†ä¹‹åŽçš„å®žä¾‹ã€‚ä¸ºäº†è¯´æ˜Žè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨ï¼Œæˆ‘ä»¬å†™äº†ä¸€ä¸ªä¾‹å­ï¼š public static void main(String...args) { Service service = getProxy(Service.class); String aJson = service.getAInfo(); System.out.println(aJson); String bJson = service.getBInfo(); System.out.println(bJson); } private static &lt;T&gt; T getProxy(final Class&lt;T&gt; service) { InvocationHandler h = (proxy, method, args) -&gt; { String json = &quot;{}&quot;; if (method.getName().equals(&quot;getAInfo&quot;)) { json = &quot;{Aè¯·æ±‚çš„ç»“æžœ}&quot;; } else if (method.getName().equals(&quot;getBInfo&quot;)) { json = &quot;{Bè¯·æ±‚çš„ç»“æžœ}&quot;; } return json; }; return (T) Proxy.newProxyInstance(service.getClassLoader(), new Class&lt;?&gt;[]{service}, h); } è¯¥ç¨‹åºçš„è¾“å‡ºç»“æžœæ˜¯ï¼š {Aè¯·æ±‚çš„ç»“æžœ} {Bè¯·æ±‚çš„ç»“æžœ} åœ¨ä¸Šé¢çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨ getProxy() èŽ·å–ä¸€ä¸ªä»£ç†ä¹‹åŽçš„å®žä¾‹ï¼Œç„¶åŽä¾æ¬¡è°ƒç”¨å®ƒçš„ getAInfo() å’Œ getBInfo() æ–¹æ³•ï¼Œæ¥æ¨¡æ‹Ÿè°ƒç”¨ A æŽ¥å£å’Œ B æŽ¥å£çš„æƒ…å½¢ï¼Œå¹¶ä¾æ¬¡å¾—åˆ°äº† A è¯·æ±‚çš„ç»“æžœå’Œ B è¯·æ±‚çš„ç»“æžœã€‚ä¸Šé¢çš„æ•ˆæžœè¿‘ä¼¼äºŽæˆ‘ä»¬ä½¿ç”¨ Retrofit è®¿é—®æŽ¥å£çš„è¿‡ç¨‹ã€‚ä¸ºäº†è¯´æ˜Žè¿™ä¸ªè¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸€ä¸‹è¿™é‡Œçš„ newProxyInstance() æ–¹æ³•ï¼š public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h) { // ... } è¯¥æ–¹æ³•æŽ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯ç±»åŠ è½½å™¨ï¼›ç¬¬äºŒä¸ªæ˜¯æŽ¥å£çš„ Class ç±»åž‹ï¼›ç¬¬ä¸‰ä¸ªæ˜¯ä¸€ä¸ªå¤„ç†å™¨ï¼Œä½ å¯ä»¥å°†å…¶çœ‹ä½œä¸€ä¸ªç”¨äºŽå›žè°ƒçš„æŽ¥å£ã€‚å½“æˆ‘ä»¬çš„ä»£ç†å®žä¾‹è§¦å‘äº†æŸä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¯¥å›žè°ƒæŽ¥å£çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚InvocationHandler æ˜¯ä¸€ä¸ªæŽ¥å£ï¼Œå®ƒå†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•å¦‚ä¸‹ï¼š public Object invoke(Object proxy, Method method, Object[] args) throws Throwable; è¯¥æ–¹æ³•ä¹ŸæŽ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯è§¦å‘è¯¥æ–¹æ³•çš„ä»£ç†å®žä¾‹ï¼›ç¬¬äºŒä¸ªæ˜¯ä»£ç†ç±»è§¦å‘çš„æ–¹æ³•ï¼›ç¬¬ä¸‰ä¸ªæ˜¯è§¦å‘çš„æ–¹æ³•çš„å‚æ•°ã€‚invoke() æ–¹æ³•çš„è¿”å›žç»“æžœä¼šä½œä¸ºä»£ç†ç±»çš„æ–¹æ³•æ‰§è¡Œçš„ç»“æžœã€‚ æ‰€ä»¥ï¼Œå½“äº†è§£äº† newProxyInstance() æ–¹æ³•çš„å®šä¹‰ä¹‹åŽï¼Œæˆ‘ä»¬å¯ä»¥åšå¦‚ä¸‹æ€»ç»“ï¼šå½“æˆ‘ä»¬ä½¿ç”¨ newProxyInstance() æ–¹æ³•èŽ·å–äº†ä¸€ä¸ªä»£ç†å®žä¾‹ service å¹¶è°ƒç”¨å…¶ getAInfo() æ–¹æ³•ä¹‹åŽï¼Œè¯¥æ–¹æ³•çš„ä¿¡æ¯å’Œå‚æ•°ä¿¡æ¯ä¼šåˆ†åˆ«é€šè¿‡ method å’Œ args ä¼ å…¥åˆ° h çš„ invoke() ä¸­ã€‚æ‰€ä»¥ï¼Œæœ€ç»ˆçš„æ•ˆæžœå°±æ˜¯ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ service çš„ getAInfo() æ—¶å€™ä¼šè§¦å‘ h çš„ invoke()ã€‚ç„¶åŽï¼Œåœ¨è¯¥æ–¹æ³•ä¸­æˆ‘ä»¬æ ¹æ® method å¾—çŸ¥è§¦å‘çš„æ–¹æ³•æ˜¯ getAInfoã€‚äºŽæ˜¯ï¼Œæˆ‘ä»¬æŠŠå®ƒå¯¹åº”çš„è¯·æ±‚ä»Ž invoke() æ–¹æ³•ä¸­è¿”å›žï¼Œå¹¶ä½œä¸º service.getAInfo() çš„è¿”å›žç»“æžœã€‚ æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ Retrofit çš„å¤§è‡´å·¥ä½œæµç¨‹ï¼šå½“æˆ‘ä»¬èŽ·å–äº†æŽ¥å£çš„ä»£ç†å®žä¾‹ï¼Œå¹¶è°ƒç”¨å®ƒçš„ getWXUserInfo() æ–¹æ³•ä¹‹åŽï¼Œè¯¥ API çš„è¯·æ±‚å‚æ•°ä¼šä¼ é€’åˆ°ä»£ç†ç±»çš„ InvocationHandler.invoke() æ–¹æ³•ä¸­ã€‚ç„¶åŽåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°†å…¶è½¬æ¢æˆ OkHttp çš„ Requestï¼Œç„¶åŽä½¿ç”¨ OkHttp è¿›è¡Œè®¿é—®ã€‚å½“æ‹¿åˆ°ç»“æžœä¹‹åŽï¼Œæˆ‘ä»¬ä½¿ç”¨ä¼ å…¥çš„ â€œè½¬æ¢å™¨â€ å°†å“åº”è½¬æ¢æˆæŽ¥å£æŒ‡å®šçš„ Java ç±»åž‹ã€‚ ä¸Šé¢æ˜¯ Retrofit è¯·æ±‚å¤„ç†çš„åŸºæœ¬æµç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ Retrofit çš„ä»£ç†æ–¹æ³•å†…éƒ¨ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆã€‚ 3ã€Retrofit çš„æºç è§£æž3.1 åˆ›å»º Retrofitæ ¹æ®ä¸Šé¢çš„ä¾‹å­ï¼Œå½“ä½¿ç”¨ Retrofit çš„æ—¶å€™ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨ Retrofit çš„æž„å»ºè€…æ¥åˆ›å»º Retrofit çš„å®žä¾‹ã€‚è¿™é‡Œæœ‰å‡ ä¸ªé‡è¦çš„æ–¹æ³•éœ€è¦æåŠä¸€ä¸‹ï¼š 3.1.1 addConverterFactory æ–¹æ³•è¯¥æ–¹æ³•ç”¨æ¥å‘ Retrofit ä¸­æ·»åŠ ä¸€ä¸ª Converter.Factoryã€‚Converter.Factoryï¼Œé¡¾åæ€ä¹‰æ˜¯ä¸€ç§å·¥åŽ‚æ¨¡å¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŽ¥å£éœ€è¦å®žçŽ°ä¸¤ä¸ªé‡è¦çš„æ–¹æ³•ã€‚æ¯ä¸ªæ–¹æ³•éœ€è¦è¿”å›žä¸€ä¸ªè½¬æ¢å™¨ï¼šä¸€ä¸ªæ˜¯æŸç§æ•°æ®ç±»åž‹åˆ°è¯·æ±‚ä½“çš„è½¬æ¢å™¨ï¼Œå¦ä¸€ä¸ªæ˜¯å“åº”ä½“åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®ç±»åž‹çš„è½¬æ¢å™¨ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ Gson æ¥å®Œæˆè¿™ä¸ªè½¬æ¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨ GsonConverterFactory.create() æ¥å¾—åˆ°ä¸€ä¸ªé€‚ç”¨äºŽ Gson çš„ Converter.Factoryã€‚ public Builder addConverterFactory(Converter.Factory factory) { converterFactories.add(checkNotNull(factory, &quot;factory == null&quot;)); return this; } 3.1.2 addCallAdapterFactory æ–¹æ³•CallAdapter.Factory ç”¨äºŽèŽ·å– CallAdapter å¯¹è±¡ï¼Œ CallAdapter å¯¹è±¡ç”¨äºŽæŠŠåŽŸç”Ÿçš„ OkHttp çš„ Call è½¬æ¢æˆæˆ‘ä»¬æŒ‡å®šçš„è¯·æ±‚ç±»åž‹ã€‚æ¯”å¦‚ï¼Œè½¬æ¢æˆ RxJava2 çš„ Observable ç±»åž‹ã€‚ä¸‹é¢æ˜¯è¯¥æ–¹æ³•çš„å®šä¹‰ï¼š public Builder addCallAdapterFactory(CallAdapter.Factory factory) { callAdapterFactories.add(checkNotNull(factory, &quot;factory == null&quot;)); return this; } 3.1.3 build æ–¹æ³•å½“æ ¹æ®ç”¨æˆ·çš„è‡ªå®šä¹‰è®¾ç½®å®Œäº†å‚æ•°ä¹‹åŽï¼Œå°±å¯ä»¥è°ƒç”¨ build() æ–¹æ³•ï¼Œæ¥èŽ·å–ä¸€ä¸ª Retrofit çš„å®žä¾‹ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ä¼šå°†ä¸Šè¿°çš„å·¥åŽ‚å®žä¾‹æ·»åŠ åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­ï¼Œç„¶åŽæ ¹æ®è¯·æ±‚ã€å“åº”çš„ç±»åž‹æ¥èŽ·å–å·¥åŽ‚å®žä¾‹ï¼Œç„¶åŽåˆ†åˆ«èŽ·å–ä¸€ä¸ªè½¬æ¢å™¨æˆ–è€…é€‚é…å™¨ã€‚ 3.1.4 å°ç»“ä¸ºäº†è¯´æ˜Žé€‚é…å™¨ CallAdapter å’Œè½¬æ¢å™¨ Converter çš„ä½œç”¨ï¼Œæˆ‘ä»¬ç»˜åˆ¶äº†ä¸‹å›¾ï¼š ä»Žä¸Šé¢æˆ‘ä»¬çœ‹å‡ºï¼ŒCallAdapter ä¸»è¦ç”¨æ¥å°†æŸä¸ªè¯·æ±‚è½¬æ¢æˆæˆ‘ä»¬æŒ‡å®šçš„ç±»åž‹ã€‚æ¯”å¦‚ï¼Œåœ¨æˆ‘ä»¬æœ€å¼€å§‹çš„ä¾‹å­ä¸­ï¼Œè¦å°†è¯·æ±‚è½¬æ¢æˆ Observable&lt;WXUserInfo&gt;ã€‚å¦‚æžœè½¬æ¢ä¹‹åŽçš„è¯·æ±‚æ˜¯ Observable ç±»åž‹çš„ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬å¯¹è½¬æ¢åŽçš„è¯·æ±‚è¿›è¡Œè®¢é˜…çš„æ—¶å€™ï¼Œå°±å¯åŠ¨äº† OkHttp çš„ç½‘ç»œè¯·æ±‚è¿‡ç¨‹ã€‚ åœ¨è¿›è¡Œç½‘ç»œè¯·æ±‚ä¹‹å‰ä¼šå…ˆä½¿ç”¨ Converter å°†è¯·æ±‚çš„å‚æ•°è½¬æ¢æˆä¸€ä¸ª RequestBodyã€‚è¿™é‡Œå°†å…¶ä½œä¸ºä¸€ä¸ªæŽ¥å£çš„å¥½å¤„æ˜¯ä¾¿äºŽè§£è€¦ã€‚æ¯”å¦‚ï¼Œä¸Šé¢æˆ‘ä»¬ç”¨ Gson æ¥å®Œæˆè½¬æ¢è¿‡ç¨‹ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡è‡ªå®šä¹‰è½¬æ¢å™¨æ¥ä½¿ç”¨å…¶ä»–çš„æ¡†æž¶ï¼Œæ¯”å¦‚ Moshi ç­‰ã€‚å½“æ‹¿åˆ°äº†å“åº”ä¹‹åŽï¼Œæˆ‘ä»¬åˆä¼šå†æ¬¡ä½¿ç”¨ Converter æ¥å°†å“åº”ä½“ ResponseBody è½¬æ¢æˆæˆ‘ä»¬è¦æ±‚çš„ç±»åž‹ã€‚æ¯”å¦‚ï¼Œä¸Šé¢çš„ä¾‹å­ä¸­åº”è¯¥è½¬æ¢ä¸º WXUserInfoã€‚ æœ€åŽï¼ŒOkHttp é‚£é‡Œå¾—åˆ°çš„å“åº”ä¼šåœ¨ CallAdapter æ–¹æ³•å†…éƒ¨è¢«åŒ…è£…æˆ Observable&lt;WXUserInfo&gt; å¹¶è¿”å›žç»™è§‚å¯Ÿè€…ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±æ‹¿åˆ°äº†è¿™ä¸ªè¯·æ±‚çš„ç»“æžœã€‚ ä»Žä¸Šé¢æˆ‘ä»¬çœ‹å‡ºï¼ŒRetrofit è®¾è®¡çš„éžå¸¸å¦™çš„åœ°æ–¹å°±åœ¨äºŽä¸Šé¢çš„ä¸¤ä¸ªè¿‡ç¨‹çš„è§£è€¦ï¼ˆç­–ç•¥æ¨¡å¼+å·¥åŽ‚æ¨¡å¼ï¼‰ã€‚ä¸€æ¬¡æ˜¯å°†è¯·æ±‚è½¬æ¢æˆ Observable çš„è¿‡ç¨‹ï¼Œä¸€æ¬¡æ˜¯å°†è¯·æ±‚ä½“å’Œå“åº”ä½“è½¬æ¢æˆ OkHttp è¦æ±‚çš„ RequestBody å’Œ ResponseBody çš„è¿‡ç¨‹ã€‚å¯¹äºŽå‰è€…ï¼Œä¸è®ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ RxJava 1 è¿˜æ˜¯ RxJava 2ï¼Œåªè¦ä¼ å…¥ä¸€ä¸ª CallAdapter å³å¯ã€‚å¯¹äºŽåŽè€…ï¼Œä¸è®ºæˆ‘ä»¬ä½¿ç”¨å“ªç§ Json è½¬æ¢æ¡†æž¶ï¼Œåªè¦å®žçŽ°äº† Converter æŽ¥å£çš†å¯ã€‚ 3.2 èŽ·å–ä»£ç†å®žä¾‹3.2.1 åˆ’åˆ†å¹³å°ï¼šPlatformåˆ›å»ºäº† Retrofit çš„å®žä¾‹ä¹‹åŽï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒçš„ create() æ–¹æ³•æ¥èŽ·å–ä»£ç†ä¹‹åŽçš„æœåŠ¡å®žä¾‹ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªæ–¹æ³•çš„å®šä¹‰ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¼šå…ˆæ ¹æ® validateEagerly å˜é‡æ¥åˆ¤æ–­æ˜¯å¦ç«‹å³å¯¹ä¼ å…¥çš„æœåŠ¡æŽ¥å£çš„æ–¹æ³•è¿›è¡Œè§£æžã€‚ç„¶åŽï¼Œæˆ‘ä»¬ä½¿ç”¨ Proxy çš„é™æ€æ–¹æ³•èŽ·å–ä¸€ä¸ªä»£ç†å®žä¾‹ã€‚ public &lt;T&gt; T create(final Class&lt;T&gt; service) { Utils.validateServiceInterface(service); // è¿™é‡Œçš„ validateEagerly åœ¨ Retrofit æž„å»ºçš„æ—¶å€™è®¾ç½® if (validateEagerly) { // æ˜¯å¦ç«‹å³å¯¹ Service æ–¹æ³•çš„å†…å®¹è¿›è¡Œè§£æž eagerlyValidateMethods(service); } // èŽ·å–ä»£ç†å®žä¾‹ return (T) Proxy.newProxyInstance(service.getClassLoader(), new Class&lt;?&gt;[] { service }, new InvocationHandler() { private final Platform platform = Platform.get(); @Override public Object invoke(Object proxy, Method method, @Nullable Object[] args) throws Throwable { // è¯¥æ–¹æ³•æ˜¯ Object çš„æ–¹æ³•ï¼Œç›´æŽ¥è§¦å‘è¯¥æ–¹æ³• if (method.getDeclaringClass() == Object.class) { return method.invoke(this, args); } // å¦‚æžœæ˜¯ default æ–¹æ³•ï¼Œé‚£ä¹ˆä½¿ç”¨è¯¥ Java8 å¹³å°çš„æ–¹æ³•æ‰§è¡Œ if (platform.isDefaultMethod(method)) { return platform.invokeDefaultMethod(method, service, proxy, args); } // èŽ·å–æœåŠ¡æ–¹æ³•çš„ä¿¡æ¯ï¼Œå¹¶å°†å…¶åŒ…è£…æˆ ServiceMethod ServiceMethod&lt;Object, Object&gt; serviceMethod = (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method); OkHttpCall&lt;Object&gt; okHttpCall = new OkHttpCall&lt;&gt;(serviceMethod, args); return serviceMethod.adapt(okHttpCall); } }); } è¿™é‡Œçš„ eagerlyValidateMethods() æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š private void eagerlyValidateMethods(Class&lt;?&gt; service) { // èŽ·å–ç¨‹åºå½“å‰è¿è¡Œçš„å¹³å° Platform platform = Platform.get(); for (Method method : service.getDeclaredMethods()) { // åˆ¤æ–­è¯¥æ–¹æ³•æ˜¯å¦æ˜¯ default æ–¹æ³• if (!platform.isDefaultMethod(method)) { loadServiceMethod(method); } } } å®ƒçš„ä½œç”¨æ˜¯ç«‹å³å¯¹æœåŠ¡æŽ¥å£çš„æ–¹æ³•è¿›è¡Œè§£æžï¼Œå¹¶å°†è§£æžä¹‹åŽçš„ç»“æžœæ”¾è¿›ä¸€ä¸ªç¼“å­˜ä¸­ã€‚è¿™æ ·ï¼Œå½“è¿™ä¸ªæœåŠ¡æ–¹æ³•è¢«è§¦å‘çš„æ—¶å€™ï¼Œç›´æŽ¥ä»Žç¼“å­˜å½“ä¸­èŽ·å–è§£æžä¹‹åŽçš„ ServiceMethod æ¥ä½¿ç”¨å³å¯ã€‚è¯¥æ–¹æ³•ä¼šå…ˆä¼šæ ¹æ®å½“å‰ç¨‹åºè¿è¡Œçš„å¹³å°æ¥å†³å®šæ˜¯å¦åº”è¯¥åŠ è½½æœåŠ¡çš„æ–¹æ³•ã€‚å› ä¸ºï¼ŒJava 8 ä¹‹åŽï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæŽ¥å£å¢žåŠ  default ç±»åž‹çš„æ–¹æ³•ï¼Œæ‰€ä»¥ï¼Œå¦‚æžœæ˜¯ default ç±»åž‹çš„è¯ï¼Œæˆ‘ä»¬ä¸ä¼šè°ƒç”¨ loadServiceMethod() è¿›è¡Œè§£æžï¼Œè€Œæ˜¯è°ƒç”¨ Java8 å¹³å°çš„ invokeDefaultMethod() æ¥å¤„ç†ã€‚åœ¨ invokeDefaultMethod() ä¸­ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„ä¿¡æ¯åˆ›å»ºä¸€ä¸ªå®žä¾‹å¹¶ä½¿ç”¨åå°„è§¦å‘å®ƒçš„æ–¹æ³•ã€‚æ­¤æ—¶ï¼Œå°±é—´æŽ¥åœ°è§¦å‘äº†è¯¥ default æ–¹æ³•ã€‚ åˆ¤æ–­å¹³å°çš„æ—¶å€™ï¼Œä½¿ç”¨äº†å¦‚ä¸‹è¿™æ®µä»£ç ï¼š platform.isDefaultMethod(Method) è¿™é‡Œçš„ platform æ˜¯è°ƒç”¨ Platform.get() çš„æ—¶å€™å¾—åˆ°çš„ã€‚å®ƒä¼šåœ¨ get() æ–¹æ³•ä¸­å°è¯•ä½¿ç”¨åå°„åŽ»èŽ·å–ä¸€ä¸ªåªæœ‰ Java8 å¹³å°æ‰å…·æœ‰çš„ç±»ï¼Œä»¥æ­¤æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ Java8 çš„çŽ¯å¢ƒã€‚åœ¨ Retrofit ä¸­ï¼Œæä¾›äº† Java8 å’Œ Android ä¸¤ä¸ªç±»æ¥åŒºåˆ†æ‰€åœ¨çš„å¹³å°ï¼Œå¹¶ä¼šæ ¹æ®è¿è¡ŒçŽ¯å¢ƒæ¥å†³å®šè¿”å›žå“ªä¸ªå®žä¾‹ã€‚ ä»Žä¸Šé¢æˆ‘ä»¬çœ‹å‡ºï¼ŒPlatform ç®—æ˜¯ä¸€ç§ç­–ç•¥çš„è®¾è®¡æ¨¡å¼ï¼Œä»¥æ ¹æ®å¹³å°çš„ä¸åŒåšä¸åŒçš„å¤„ç†ã€‚ä½†åœ¨å½“å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å¯¹ default ç±»åž‹çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚ 3.2.2 è§£æžæœåŠ¡æ–¹æ³•ï¼šServiceMethodä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡ loadServiceMethod() æ–¹æ³•ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨ï¼šé¦–å…ˆä¼šå°è¯•ä»Žç¼“å­˜å½“ä¸­èŽ·å–è¯¥æ–¹æ³•å¯¹åº”çš„ ServiceMethod å®žä¾‹ï¼Œå¦‚æžœå–åˆ°çš„è¯ï¼Œå°±å°†å…¶è¿”å›žï¼›å¦åˆ™ï¼Œå°±ä½¿ç”¨æž„å»ºè€…æ¨¡å¼åˆ›å»ºä¸€ä¸ªå¹¶æ”¾è¿›ç¼“å­˜ä¸­ï¼Œç„¶åŽå°†å…¶è¿”å›žã€‚ ServiceMethod&lt;?, ?&gt; loadServiceMethod(Method method) { // ä»Žç¼“å­˜ä¸­è¿›è¡ŒèŽ·å– ServiceMethod&lt;?, ?&gt; result = serviceMethodCache.get(method); if (result != null) return result; synchronized (serviceMethodCache) { result = serviceMethodCache.get(method); if (result == null) { // åˆ›å»ºServiceMethodå®žä¾‹ result = new ServiceMethod.Builder&lt;&gt;(this, method).build(); serviceMethodCache.put(method, result); } } return result; } ServiceMethod çš„æž„å»ºè¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦æŠŠå½“å‰çš„ Retrofit å®žä¾‹å’ŒæœåŠ¡æ–¹æ³• method ä¼ å…¥è¿›åŽ»ï¼Œç„¶åŽè°ƒç”¨å®ƒçš„ build() æ–¹æ³•å°±å®Œæˆäº†æ•´ä¸ªåˆ›å»ºè¿‡ç¨‹ã€‚åœ¨ build() æ–¹æ³•ä¸­ï¼Œä¼šå®Œæˆå¯¹ method çš„è§£æžï¼Œæ¯”å¦‚æ ¹æ®æ³¨è§£åˆ¤æ–­æ˜¯ä»€ä¹ˆç±»åž‹çš„è¯·æ±‚ï¼Œæ ¹æ®æ–¹æ³•çš„å‚æ•°æ¥è§£æžè¯·æ±‚çš„è¯·æ±‚ä½“ç­‰ç­‰ã€‚ServiceMethod å†…éƒ¨çš„å˜é‡ä¸»è¦æ˜¯ä¸Žè¯·æ±‚çš„ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒæ—¶å®ƒä¹Ÿæä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œç”¨äºŽèŽ·å– OkHttp çš„è¯·æ±‚å’Œå“åº”ã€‚ æ‰€ä»¥ï¼ŒServiceMethod çš„ä½œç”¨æ˜¯ç¼“å­˜æœåŠ¡æ–¹æ³•å¯¹åº”çš„è¯·æ±‚ä¿¡æ¯ï¼Œè¿™æ ·ä¸‹æ¬¡æˆ‘ä»¬å°±ä¸éœ€è¦å†æ¬¡è§£æžäº†ã€‚åŒæ—¶ï¼Œå®ƒæä¾›äº†ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼Œå®ƒä»¬çš„ä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥ä»Ž ServiceMethod ä¸­èŽ·å–è¯·æ±‚ç›¸å…³çš„ä¿¡æ¯ã€‚ toCall() ç”¨æ¥èŽ·å–ç”¨äºŽ OkHttp è¯·æ±‚çš„ Call å¯¹è±¡ï¼š okhttp3.Call toCall(@Nullable Object... args) throws IOException { RequestBuilder requestBuilder = new RequestBuilder(httpMethod, baseUrl, relativeUrl, headers, contentType, hasBody, isFormEncoded, isMultipart); // ... return callFactory.newCall(requestBuilder.build()); } toResponse(ResponseBody) ç”¨æ¥æŠŠ OkHttp å¾—åˆ°çš„å“åº”ä½“è½¬æ¢æˆ Java å¯¹è±¡ç­‰ï¼ˆåœ¨ç¤ºä¾‹ä¸­æ˜¯WXUserInfoï¼‰ï¼š R toResponse(ResponseBody body) throws IOException { return responseConverter.convert(body); } adapt(Call&lt;R&gt;) ç”¨æ¥å°† OkHttp çš„è¯·æ±‚è½¬æ¢æˆæˆ‘ä»¬çš„æœåŠ¡æ–¹æ³•çš„è¿”å›žç±»åž‹ï¼ˆåœ¨ç¤ºä¾‹ä¸­æ˜¯Observable&lt;WXUserInfo&gt;ï¼‰ï¼š T adapt(Call&lt;R&gt; call) { return callAdapter.adapt(call); } 3.2.3 è¯·æ±‚å°è£…ï¼šOkHttpCallè§£æžå®Œæ¯•æœåŠ¡æ–¹æ³•ä¹‹åŽï¼Œæˆ‘ä»¬å¾—åˆ°äº† ServiceMethod å®žä¾‹ã€‚ç„¶åŽï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒæ¥åˆ›å»º OkHttpCall å®žä¾‹ã€‚è¿™é‡Œçš„ OkHttpCall å®žçŽ°äº† Retrofit ä¸­å®šä¹‰çš„ Call æŽ¥å£ï¼Œä¼šåœ¨æ–¹æ³•å†…è°ƒç”¨ ServiceMethod çš„ toCall() æ–¹æ³•æ¥èŽ·å– OkHttp ä¸­çš„ Call å¯¹è±¡ï¼Œç„¶åŽä½¿ç”¨å®ƒè¿›è¡Œç½‘ç»œè®¿é—®ã€‚å½“æ‹¿åˆ°äº†è¯·æ±‚çš„ç»“æžœä¹‹åŽåˆä½¿ç”¨ ServiceMethod çš„ toResponse() æŠŠå“åº”è½¬æ¢æˆæˆ‘ä»¬æŒ‡å®šçš„ç±»åž‹ã€‚ä¸‹é¢æ˜¯è¯¥ç±»ä¸­çš„å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³•ï¼š execute() æ–¹æ³•ï¼Œç”¨æ¥åŒæ­¥æ‰§è¡Œç½‘ç»œè¯·æ±‚ï¼š 1234567891011121314151617181920212223@Overridepublic Response&lt;T&gt; execute() throws IOException &#123; okhttp3.Call call; synchronized (this) &#123; // ... call = rawCall; if (call == null) &#123; try &#123; // åˆ›å»º OkHttp çš„ Call å®žä¾‹ call = rawCall = createRawCall(); &#125; catch (IOException | RuntimeException | Error e) &#123; throwIfFatal(e); creationFailure = e; throw e; &#125; &#125; &#125; if (canceled) &#123; call.cancel(); &#125; // åŒæ­¥æ‰§è¡Œè¯·æ±‚ï¼Œå¹¶è§£æžç»“æžœ return parseResponse(call.execute());&#125; createRawCall() ç”¨æ¥åˆ›å»º OkHttp çš„ Call å®žä¾‹ï¼š 12345678// ä½¿ç”¨ serviceMethod çš„ toCall æ–¹æ³•èŽ·å– OkHttp çš„ Call å®žä¾‹private okhttp3.Call createRawCall() throws IOException &#123; okhttp3.Call call = serviceMethod.toCall(args); if (call == null) &#123; throw new NullPointerException(&quot;Call.Factory returned null.&quot;); &#125; return call;&#125; parseResponse() ç”¨æ¥å°† OkHttp çš„å“åº”è½¬æ¢æˆæˆ‘ä»¬æŽ¥å£ä¸­å®šä¹‰çš„ç±»åž‹ã€‚æ¯”å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿”å›žçš„æ˜¯ Observable&lt;WXUserInfo&gt;: 1234567891011121314151617// ä½¿ç”¨ serviceMethod çš„ toResponse æ–¹æ³•èŽ·å– OkHttp çš„ Response å®žä¾‹Response&lt;T&gt; parseResponse(okhttp3.Response rawResponse) throws IOException &#123; ResponseBody rawBody = rawResponse.body(); rawResponse = rawResponse.newBuilder() .body(new NoContentResponseBody(rawBody.contentType(), rawBody.contentLength())) .build(); // ... ExceptionCatchingRequestBody catchingBody = new ExceptionCatchingRequestBody(rawBody); try &#123; // ä½¿ç”¨ serviceMethod çš„ toResponse æ–¹æ³•èŽ·å– OkHttp çš„ Response å®žä¾‹ T body = serviceMethod.toResponse(catchingBody); return Response.success(body, rawResponse); &#125; catch (RuntimeException e) &#123; catchingBody.throwIfCaught(); throw e; &#125;&#125; 3.3 Retrofit çš„å·¥ä½œè¿‡ç¨‹ä¸Šé¢æ˜¯ Retrofit æ¡†æž¶è®¾è®¡ä¸­å‡ ä¸ªå…³é”®çš„éƒ¨åˆ†çš„åŠŸèƒ½çš„è§£æžã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å†æ¥å…·ä½“çœ‹ä¸€ä¸‹ï¼Œä»Žè§¦å‘ä»£ç†ç±»çš„æ–¹æ³•åˆ°æ‹¿åˆ°å“åº”çš„ç»“æžœï¼Œè¿™ä¸€æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œéƒ½æœ‰å“ªäº›ç±»çš„å“ªäº›æ–¹æ³•å‚ä¸Žï¼Œä»¥åŠå®ƒä»¬åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œæ‰®æ¼”ä»€ä¹ˆæ ·çš„è§’è‰²ã€‚è¿™é‡Œæˆ‘ä»¬ä»ç„¶ä½¿ç”¨æœ€åˆçš„ç¤ºä¾‹ï¼š ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å°† Retrofit çš„è¯·æ±‚çš„è¿‡ç¨‹åˆ†æˆä¸‰ä¸ªè¿‡ç¨‹æ¥è¿›è¡Œè¯´æ˜Žï¼š åˆ›å»ºä»£ç†å®žä¾‹çš„è¿‡ç¨‹ï¼šåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸»è¦æ˜¯è°ƒç”¨ Proxy.newProxyInstance() æ¥èŽ·å–ä¸€ä¸ªä»£ç†å®žä¾‹ã€‚ç›¸å…³çš„ä¸»è¦å‚æ•°æ˜¯ validateEagerlyï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨å®ƒæ¥å†³å®šæ˜¯å¦ç«‹å³å¯¹ä¼ å…¥çš„æŽ¥å£çš„æ–¹æ³•è¿›è¡Œè§£æžã€‚ä¸è®ºæˆ‘ä»¬ä»€ä¹ˆæ—¶å€™è¿›è¡Œè§£æžï¼Œéƒ½ä¼šæŠŠè§£æžçš„ç»“æžœç¼“å­˜èµ·æ¥ã€‚ è§¦å‘ä»£ç†æ–¹æ³•çš„è¿‡ç¨‹ï¼šè§¦å‘ä»£ç†æ–¹æ³•æ˜¯æ•´ä¸ªè¯·æ±‚çš„ç¬¬äºŒè¿‡ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨äº† WXInfoService ä»£ç†å®žä¾‹çš„ getWXUserInfo() æ–¹æ³•ã€‚æ­¤æ—¶ï¼Œä¼šè§¦å‘ InvocationHandler çš„ invoke() æ–¹æ³•ã€‚åœ¨è¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ ServiceMethod çš„æž„å»ºè€…æ¨¡å¼æ¥åˆ›å»º ServiceMethod å®žä¾‹ã€‚å½“è°ƒç”¨æž„å»ºè€…æ¨¡å¼çš„ build() æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå¯¹æ–¹æ³• getWXUserInfo() çš„ä¿¡æ¯è¿›è¡Œè§£æžã€‚ç„¶åŽï¼Œä½¿ç”¨ ServiceMethod å®žä¾‹åˆ›å»º OkHttpCallã€‚æœ€åŽï¼Œä½¿ç”¨ ServiceMethod å®žä¾‹çš„ adapt() æ–¹æ³•å°† OkHttpCall å®žä¾‹è½¬æ¢æˆ Observable&lt;WXUserInfo&gt;ã€‚æ­¤æ—¶ï¼Œä¼šä½¿ç”¨ CallAdapter çš„ adapt() æ–¹æ³•æ¥å®Œæˆé€‚é…è¿‡ç¨‹ã€‚ æ‰§è¡Œç½‘ç»œè¯·æ±‚çš„è¿‡ç¨‹ï¼šæ‹¿åˆ°äº† Observable&lt;WXUserInfo&gt; ä¹‹åŽï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œè®¢é˜…æ‰èƒ½è§¦å‘ç½‘ç»œè¯·æ±‚ã€‚ç›¸å…³çš„é€»è¾‘åœ¨ CallAdapter ä¸­å®Œæˆã€‚é¦–å…ˆï¼Œå®ƒä¼šæ ¹æ®ä½ ä½¿ç”¨åŒæ­¥è¿˜æ˜¯å¼‚æ­¥çš„æ¥å†³å®šä½¿ç”¨å“ªä¸ªæ‰§è¡Œå™¨ã€‚è¿™é‡Œå­˜åœ¨ä¸¤ä¸ªæ‰§è¡Œå™¨ï¼Œå®ƒä»¬çš„åŒºåˆ«æ˜¯ä¸€ä¸ªä¼šåœ¨å†…éƒ¨è°ƒç”¨ OkHttpCall çš„ enqueue()ï¼Œå¦ä¸€ä¸ªä¼šåœ¨æ‰§è¡Œå™¨ä¸­è°ƒç”¨ OkHttpCall çš„ execute() æ–¹æ³•ã€‚ä¸è®ºè°ƒç”¨ enqueue() è¿˜æ˜¯ execute()ï¼Œéƒ½ä¼šå…ˆä½¿ç”¨ OkHttpCall çš„ toCall() æ–¹æ³•èŽ·å–ä¸€ä¸ª Call è¯·æ±‚ã€‚èŽ·å–è¯·æ±‚çš„è¿‡ç¨‹ä¸­ä¼šä½¿ç”¨ Converter æ¥å°†æŸä¸ªå®žä¾‹è½¬æ¢æˆè¯·æ±‚ä½“ã€‚æ‹¿åˆ°äº†è¯·æ±‚ä¹‹åŽï¼Œä½¿ç”¨è¯¥è¯·æ±‚æ¥è¿›è¡Œç½‘ç»œè®¿é—®ã€‚å½“ä»Žç½‘ç»œä¸­æ‹¿åˆ°äº†å“åº”ä¹‹åŽï¼Œä¼šä½¿ç”¨ Converter æ¥å°†å“åº”ä½“è½¬æ¢æˆå¯¹è±¡ã€‚è¿™æ ·ï¼Œæ‹¿åˆ°äº†å®žé™…çš„ç»“æžœä¹‹åŽï¼Œå°±ä¼šè°ƒç”¨ Observer çš„ onNext() æ–¹æ³•æŠŠç»“æžœé€šçŸ¥ç»™è§‚å¯Ÿè€…ã€‚ 4ã€æ€»ç»“åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å…ˆç®€å•ä»‹ç»äº† Retrofit çš„ä½¿ç”¨ï¼Œç„¶åŽï¼Œå› ä¸º Retrofit å†…éƒ¨ä½¿ç”¨åŠ¨æ€ä»£ç†æ¥å®žçŽ°çš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯¹åŠ¨æ€ä»£ç†ç›¸å…³å†…å®¹è¿›è¡Œäº†ä»‹ç»ã€‚æœ€åŽï¼Œæˆ‘ä»¬å¯¹ Retrofit çš„æºç è¿›è¡Œäº†åˆ†æžï¼Œå…ˆä»Žè®¾è®¡æ€è·¯ï¼ŒåŽä»Žå„ä¸ªçŽ¯èŠ‚çš„æ‰§è¡Œè¿‡ç¨‹è¿›è¡Œäº†è¯´æ˜Žã€‚æœ€åŽçš„æœ€åŽï¼Œæˆ‘ä»¬å°†ä¸¤è€…ç»“åˆèµ·æ¥ç”¨ä¸€ä¸ªæ—¶åºå›¾åšäº†è¯´æ˜Žã€‚ ä»Žä¸Šæ–‡ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼ŒRetrofit è®¾è®¡çš„å‡ ä¸ªå€¼å¾—æˆ‘ä»¬å€Ÿé‰´çš„åœ°æ–¹ï¼š ä½¿ç”¨è¿è¡Œæ—¶æ³¨è§£å’Œåå°„ç®€åŒ–è¯·æ±‚æè¿°ï¼Œä½†æ˜¯è€ƒè™‘åˆ°åå°„çš„æ•ˆçŽ‡æ¯”è¾ƒä½Žï¼Œæ‰€ä»¥å°†ä¸€æ¬¡åå°„ä¹‹åŽçš„ç»“æžœç¼“å­˜èµ·æ¥ï¼Œä»¥ä¾¿äºŽä¸‹æ¬¡ä½¿ç”¨ã€‚ åŠ¨æ€ä»£ç†ï¼šä½¿ç”¨æŽ¥å£æè¿°è¯·æ±‚çš„å¥½å¤„æ˜¯å®ƒç®€æ´ï¼Œè€Œä¸” â€œæè¿°â€ æœ¬æ¥å°±æ˜¯å®ƒçš„è´£ä»»ã€‚ä½†æ˜¯ï¼Œä¸€èˆ¬æˆ‘ä»¬éœ€è¦åŽ»å®žçŽ°æŽ¥å£æ‰èƒ½ä½¿ç”¨ã€‚è€Œè¿™é‡Œå‘Šè¯‰æˆ‘ä»¬ï¼Œä½¿ç”¨åŠ¨æ€ä»£ç†ä¸€æ ·å¯ä»¥ä½¿ç”¨æŽ¥ã€‚ è§£è€¦ï¼šä»Žæˆ‘ä»¬ä¸Šé¢çš„å›¾ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼ŒRetrofit çš„è®¾è®¡çš„æ€è·¯æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚å®ƒå°†ä¸€ä¸ªè¯·æ±‚çš„å‡ ä¸ªè¿‡ç¨‹è§£è€¦å‡ºæ¥ã€‚é¦–å…ˆæ˜¯æˆ‘ä»¬ Observable åˆ°è¯·æ±‚çš„è½¬æ¢ï¼Œè¿™é‡Œä½¿ç”¨é€‚é…å™¨æ¥å®Œæˆï¼›ç„¶åŽæ˜¯è¯·æ±‚ä½“å’Œå“åº”ä½“çš„è½¬æ¢ï¼ŒåŸºæœ¬å°±æ˜¯ Json çš„è½¬æ¢ï¼Œä½¿ç”¨è½¬æ¢å™¨æ¥å®Œæˆã€‚è¿™æ ·ï¼Œä¸è®ºä½ ä½¿ç”¨ RxJava 1 è¿˜æ˜¯ RxJava 2ï¼Œä¸è®ºæ˜¯ Gson è¿˜æ˜¯ FastXml éƒ½å¯ä»¥å’Œ Retrifut é…åˆä½¿ç”¨ã€‚ ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬å¯¹ Retrofit çš„æºç çš„åˆ†æžã€‚]]></content>
      <categories>
        <category>Androidç½‘ç»œè®¿é—®</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Java</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
        <tag>OkHttp</tag>
        <tag>æºç é˜…è¯»</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Andriod ç½‘ç»œæ¡†æž¶ OkHttp æºç è§£æž]]></title>
    <url>%2F2018%2F10%2F17%2FAndriod%20%E7%BD%91%E7%BB%9C%E6%A1%86%E6%9E%B6%20OkHttp%20%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%2F</url>
    <content type="text"><![CDATA[1ã€OkHttp çš„åŸºæœ¬ä½¿ç”¨OkHttp æ˜¯ Square çš„ä¸€æ¬¾åº”ç”¨äºŽ Android å’Œ Java çš„ Http å’Œ Http/2 å®¢æˆ·ç«¯ã€‚ä½¿ç”¨çš„æ—¶å€™åªéœ€è¦åœ¨ Gradle é‡Œé¢åŠ å…¥ä¸‹é¢ä¸€è¡Œä¾èµ–å³å¯å¼•å…¥ï¼š implementation &apos;com.squareup.okhttp3:okhttp:3.11.0&apos; æˆ‘ä»¬çŸ¥é“ï¼ŒHttp è¯·æ±‚æœ‰å¤šç§ç±»åž‹ï¼Œå¸¸ç”¨çš„åˆ†ä¸º Get å’Œ Postï¼Œè€Œ POST åˆåˆ†ä¸º Form å’Œ Multiple ç­‰ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ Form ç±»åž‹çš„è¯·æ±‚ä¸ºä¾‹æ¥çœ‹ä¸‹ OkHttp çš„ API è®¾è®¡é€»è¾‘ï¼š OkHttpClient internalHttpClient = new OkHttpClient(); FormBody.Builder formBodyBuilder = new FormBody.Builder(); RequestBody body = formBodyBuilder.build(); Request.Builder builder = new Request.Builder().url(&quot;host:port/url&quot;).post(body); Request request = builder.build(); Response response = internalHttpClient.newCall(request).execute(); String retJson = response.body().string(); è¿™é‡Œæˆ‘ä»¬å…ˆç”¨äº† FormBody çš„æž„å»ºè€…æ¨¡å¼åˆ›å»º Form ç±»åž‹è¯·æ±‚çš„è¯·æ±‚ä½“ï¼Œç„¶åŽä½¿ç”¨ Request çš„æž„å»ºè€…åˆ›å»ºå®Œæ•´çš„ Form è¯·æ±‚ã€‚ä¹‹åŽï¼Œæˆ‘ä»¬ç”¨åˆ›å»ºå¥½çš„ OkHttp å®¢æˆ·ç«¯ internalHttpClient æ¥èŽ·å–ä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶ä»Žè¯·æ±‚çš„è¯·æ±‚ä½“ä¸­èŽ·å– Json æ•°æ®ã€‚ æ ¹æ® OkHttp çš„ APIï¼Œå¦‚æžœæˆ‘ä»¬å¸Œæœ›å‘é€ä¸€ä¸ª Multipart ç±»åž‹çš„è¯·æ±‚çš„æ—¶å€™å°±éœ€è¦ä½¿ç”¨ MultipartBody çš„æž„å»ºè€…åˆ›å»º Multipart è¯·æ±‚çš„è¯·æ±‚ä½“ã€‚ç„¶åŽåŒæ ·ä½¿ç”¨ Request çš„æž„å»ºè€…åˆ›å»ºå®Œæ•´çš„ Multipart è¯·æ±‚ï¼Œå‰©ä¸‹çš„é€»è¾‘ç›¸åŒã€‚ é™¤äº†ä½¿ç”¨ä¸Šé¢çš„ç›´æŽ¥å®žä¾‹åŒ–ä¸€ä¸ª OkHttp å®¢æˆ·ç«¯çš„æ–¹å¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ OkHttpClient çš„æž„å»ºè€… OkHttpClient.Builder æ¥åˆ›å»º OkHttp å®¢æˆ·ç«¯ã€‚ æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ï¼š OkHttp ä¸ºä¸åŒçš„è¯·æ±‚ç±»åž‹éƒ½æä¾›äº†ä¸€ä¸ªæž„å»ºè€…æ–¹æ³•ç”¨æ¥åˆ›å»ºè¯·æ±‚ä½“ RequestBodyï¼› å› ä¸ºè¯·æ±‚ä½“åªæ˜¯æ•´ä¸ªè¯·æ±‚çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ï¼Œåˆè¦ç”¨ Request.Builder æž„å»ºä¸€ä¸ªè¯·æ±‚å¯¹è±¡ Requestï¼› è¿™æ ·æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„ Http è¯·æ±‚ï¼Œç„¶åŽä½¿ç”¨ OkHttpClient å¯¹è±¡è¿›è¡Œç½‘ç»œè®¿é—®å¾—åˆ°å“åº”å¯¹è±¡ Responseã€‚ OkHttp æœ¬èº«çš„è®¾è®¡æ¯”è¾ƒå‹å¥½ï¼Œæ€è·¯éžå¸¸æ¸…æ™°ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ€è·¯æžæ‡‚äº†äººå®¶çš„ API è®¾è®¡é€»è¾‘ï¼Œè‡ªå·±å†åŸºäºŽ OkHttp å°è£…ä¸€ä¸ªåº“è‡ªç„¶é—®é¢˜ä¸å¤§ã€‚ 2ã€OkHttp æºç åˆ†æžä¸Šé¢æˆ‘ä»¬æåˆ°çš„ä¸€äº›æ˜¯åŸºç¡€çš„ API ç±»ï¼Œæ˜¯æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„ã€‚è¿™äº›ç±»çš„è®¾è®¡åªæ˜¯åŸºäºŽæž„å»ºè€…æ¨¡å¼ï¼Œéžå¸¸å®¹æ˜“ç†è§£ã€‚è¿™é‡Œæˆ‘ä»¬å…³æ³¨ç‚¹ä¹Ÿä¸åœ¨è¿™äº› API ç±»ä¸Šé¢ï¼Œè€Œæ˜¯ OkHttp å†…éƒ¨çš„è¯·æ±‚æ‰§è¡Œç›¸å…³çš„ç±»ã€‚ä¸‹é¢æˆ‘ä»¬å°±å¼€å§‹å¯¹ OkHttp çš„è¯·æ±‚è¿‡ç¨‹è¿›è¡Œæºç åˆ†æžï¼ˆæºç ç‰ˆæœ¬ï¼š3.10.0ï¼‰ã€‚ 2.1 ä¸€ä¸ªè¯·æ±‚çš„å¤§è‡´æµç¨‹å‚è€ƒä¹‹å‰çš„ç¤ºä¾‹ç¨‹åºï¼ŒæŠ›å¼ƒæž„å»ºè¯·æ±‚çš„è¿‡ç¨‹ä¸è®²ï¼Œå•ä»Žè¯·æ±‚çš„å‘é€è¿‡ç¨‹æ¥çœ‹ï¼Œæˆ‘ä»¬çš„çº¿ç´¢åº”è¯¥ä»Ž OkHttpClient.newCall(Request) å¼€å§‹ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªæ–¹æ³•çš„å®šä¹‰ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ª RealCall å¯¹è±¡ï¼Œå¹¶æŠŠ OkHttpClient å¯¹è±¡å’Œ Request å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ å…¥è¿›åŽ»ï¼š @Override public Call newCall(Request request) { return RealCall.newRealCall(this, request, false /* for web socket */); } ç„¶åŽï¼ŒRealCall è°ƒç”¨å†…éƒ¨çš„é™æ€æ–¹æ³• newRealCall åœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ª RealCall å®žä¾‹å¹¶å°†å…¶è¿”å›žï¼š static RealCall newRealCall(OkHttpClient client, Request originalRequest, boolean forWebSocket) { RealCall call = new RealCall(client, originalRequest, forWebSocket); call.eventListener = client.eventListenerFactory().create(call); return call; } ç„¶åŽï¼Œå½“è¿”å›žäº† RealCall ä¹‹åŽï¼Œæˆ‘ä»¬åˆä¼šè°ƒç”¨å®ƒçš„ execute() æ–¹æ³•æ¥èŽ·å–å“åº”ç»“æžœï¼Œä¸‹é¢æ˜¯è¿™ä¸ªæ–¹æ³•çš„å®šä¹‰ï¼š @Override public Response execute() throws IOException { synchronized (this) { if (executed) throw new IllegalStateException(&quot;Already Executed&quot;); executed = true; } captureCallStackTrace(); eventListener.callStart(this); try { // åŠ å…¥åˆ°ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ä¸­ client.dispatcher().executed(this); // ä»Žè¿™é‡Œæ‹¿çš„å“åº”Response Response result = getResponseWithInterceptorChain(); if (result == null) throw new IOException(&quot;Canceled&quot;); return result; } catch (IOException e) { eventListener.callFailed(this, e); throw e; } finally { client.dispatcher().finished(this); } } è¿™é‡Œæˆ‘ä»¬ä¼šç”¨ client å¯¹è±¡ï¼ˆå®žé™…ä¹Ÿå°±æ˜¯ä¸Šé¢åˆ›å»º RealCall çš„æ—¶å€™ä¼ å…¥çš„ OkHttpClientï¼‰çš„ dispatcher() æ–¹æ³•æ¥èŽ·å–ä¸€ä¸ª Dispatcher å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å®ƒçš„ executed() æ–¹æ³•æ¥å°†å½“å‰çš„ RealCall åŠ å…¥åˆ°ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ä¸­ï¼Œä¸‹é¢æ˜¯ executed(RealCall) æ–¹æ³•çš„å®šä¹‰ï¼Œè¿™é‡Œçš„ runningSyncCalls çš„ç±»åž‹æ˜¯ Deque&lt;RealCall&gt;ï¼š synchronized void executed(RealCall call) { runningSyncCalls.add(call); } è®©æˆ‘ä»¬å›žåˆ°ä¸Šé¢çš„ execute() æ–¹æ³•ï¼Œåœ¨æŠŠ RealCall åŠ å…¥åˆ°åŒç«¯é˜Ÿåˆ—ä¹‹åŽï¼Œæˆ‘ä»¬åˆè°ƒç”¨äº† getResponseWithInterceptorChain() æ–¹æ³•ï¼Œä¸‹é¢å°±æ˜¯è¯¥æ–¹æ³•çš„å®šä¹‰ã€‚ Response getResponseWithInterceptorChain() throws IOException { // æ·»åŠ ä¸€ç³»åˆ—æ‹¦æˆªå™¨ï¼Œæ³¨æ„æ·»åŠ çš„é¡ºåº List&lt;Interceptor&gt; interceptors = new ArrayList&lt;&gt;(); interceptors.addAll(client.interceptors()); interceptors.add(retryAndFollowUpInterceptor); // æ¡¥æ‹¦æˆªå™¨ interceptors.add(new BridgeInterceptor(client.cookieJar())); // ç¼“å­˜æ‹¦æˆªå™¨ï¼šä»Žç¼“å­˜ä¸­æ‹¿æ•°æ® interceptors.add(new CacheInterceptor(client.internalCache())); // ç½‘ç»œè¿žæŽ¥æ‹¦æˆªå™¨ï¼šå»ºç«‹ç½‘ç»œè¿žæŽ¥ interceptors.add(new ConnectInterceptor(client)); if (!forWebSocket) { interceptors.addAll(client.networkInterceptors()); } // æœåŠ¡å™¨è¯·æ±‚æ‹¦æˆªå™¨ï¼šå‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚èŽ·å–æ•°æ® interceptors.add(new CallServerInterceptor(forWebSocket)); // æž„å»ºä¸€æ¡è´£ä»»é“¾ Interceptor.Chain chain = new RealInterceptorChain(interceptors, null, null, null, 0, originalRequest, this, eventListener, client.connectTimeoutMillis(), client.readTimeoutMillis(), client.writeTimeoutMillis()); // å¤„ç†è´£ä»»é“¾ return chain.proceed(originalRequest); } è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåˆ—è¡¨å¯¹è±¡ä¹‹åŽæŠŠ client ä¸­çš„æ‹¦æˆªå™¨ã€é‡è¿žæ‹¦æˆªå™¨ã€æ¡¥æ‹¦æˆªå™¨ã€ç¼“å­˜æ‹¦æˆªå™¨ã€ç½‘ç»œè¿žæŽ¥æ‹¦æˆªå™¨å’ŒæœåŠ¡å™¨è¯·æ±‚æ‹¦æˆªå™¨ç­‰ä¾æ¬¡åŠ å…¥åˆ°åˆ—è¡¨ä¸­ã€‚ç„¶åŽï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªåˆ—è¡¨åˆ›å»ºäº†ä¸€ä¸ªæ‹¦æˆªå™¨é“¾ã€‚è¿™é‡Œä½¿ç”¨äº†è´£ä»»é“¾è®¾è®¡æ¨¡å¼ï¼Œæ¯å½“ä¸€ä¸ªæ‹¦æˆªå™¨æ‰§è¡Œå®Œæ¯•ä¹‹åŽä¼šè°ƒç”¨ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨æˆ–è€…ä¸è°ƒç”¨å¹¶è¿”å›žç»“æžœã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬æœ€ç»ˆæ‹¿åˆ°çš„å“åº”å°±æ˜¯è¿™ä¸ªé“¾æ¡æ‰§è¡Œä¹‹åŽè¿”å›žçš„ç»“æžœã€‚å½“æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªæ‹¦æˆªå™¨çš„æ—¶å€™ï¼Œä¹Ÿä¼šè¢«åŠ å…¥åˆ°è¿™ä¸ªæ‹¦æˆªå™¨é“¾æ¡é‡Œã€‚ è¿™é‡Œæˆ‘ä»¬é‡åˆ°äº†å¾ˆå¤šçš„æ–°ç±»ï¼Œæ¯”å¦‚ RealCallã€Dispatcher ä»¥åŠè´£ä»»é“¾ç­‰ã€‚ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šå¯¹è¿™äº›ç±»ä¹‹é—´çš„å…³ç³»ä»¥åŠè´£ä»»é“¾ä¸­çš„çŽ¯èŠ‚åšä¸€ä¸ªåˆ†æžï¼Œè€Œè¿™é‡Œæˆ‘ä»¬å…ˆå¯¹æ•´ä¸ªè¯·æ±‚çš„æµç¨‹åšä¸€ä¸ªå¤§è‡´çš„æ¢³ç†ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªè¿‡ç¨‹å¤§è‡´çš„æ—¶åºå›¾ï¼š 2.2 åˆ†å‘å™¨ Dispatcherä¸Šé¢æˆ‘ä»¬æåˆ°äº† Dispatcher è¿™ä¸ªç±»ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¯¹è¯·æ±‚è¿›è¡Œåˆ†å‘ã€‚ä»¥æœ€å¼€å§‹çš„ç¤ºä¾‹ä»£ç ä¸ºä¾‹ï¼Œåœ¨ä½¿ç”¨ OkHttp çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª RealCall å¹¶å°†å…¶åŠ å…¥åˆ°åŒç«¯é˜Ÿåˆ—ä¸­ã€‚ä½†æ˜¯è¯·æ³¨æ„è¿™é‡Œçš„åŒç«¯é˜Ÿåˆ—çš„åç§°æ˜¯ runningSyncCallsï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ç§è¯·æ±‚æ˜¯åŒæ­¥è¯·æ±‚ï¼Œä¼šåœ¨å½“å‰çš„çº¿ç¨‹ä¸­ç«‹å³è¢«æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œä¸‹é¢çš„ getResponseWithInterceptorChain() å°±æ˜¯è¿™ä¸ªåŒæ­¥çš„æ‰§è¡Œè¿‡ç¨‹ã€‚è€Œå½“æˆ‘ä»¬æ‰§è¡Œå®Œæ¯•çš„æ—¶å€™ï¼Œåˆä¼šè°ƒç”¨ Dispatcher çš„ finished(RealCall) æ–¹æ³•æŠŠè¯¥è¯·æ±‚ä»Žé˜Ÿåˆ—ä¸­ç§»é™¤ã€‚æ‰€ä»¥ï¼Œè¿™ç§åŒæ­¥çš„è¯·æ±‚æ— æ³•ä½“çŽ°åˆ†å‘å™¨çš„â€œåˆ†å‘â€åŠŸèƒ½ã€‚ é™¤äº†åŒæ­¥çš„è¯·æ±‚ï¼Œè¿˜æœ‰å¼‚æ­¥ç±»åž‹çš„è¯·æ±‚ï¼šå½“æˆ‘ä»¬æ‹¿åˆ°äº† RealCall çš„æ—¶å€™ï¼Œè°ƒç”¨å®ƒçš„ enqueue(Callback responseCallback) æ–¹æ³•å¹¶è®¾ç½®ä¸€ä¸ªå›žè°ƒå³å¯ã€‚è¯¥æ–¹æ³•ä¼šæ‰§è¡Œä¸‹é¢è¿™è¡Œä»£ç ï¼š client.dispatcher().enqueue(new AsyncCall(responseCallback)); å³ä½¿ç”¨ä¸Šé¢çš„å›žè°ƒåˆ›å»ºä¸€ä¸ª AsyncCall å¹¶è°ƒç”¨ enqueue(AsyncCall)ã€‚è¿™é‡Œçš„ AsyncCall é—´æŽ¥ç»§æ‰¿è‡ª Runnableï¼Œæ˜¯ä¸€ä¸ªå¯æ‰§è¡Œçš„å¯¹è±¡ï¼Œå¹¶ä¸”ä¼šåœ¨ Runnable çš„ run() æ–¹æ³•é‡Œé¢è°ƒç”¨ AsyncCall çš„ execute() æ–¹æ³•ã€‚AsyncCall çš„ execute() æ–¹æ³•ä¸Ž RealCall çš„ execute() æ–¹æ³•ç±»ä¼¼ï¼Œéƒ½ä½¿ç”¨è´£ä»»é“¾æ¥å®Œæˆä¸€ä¸ªç½‘ç»œè¯·æ±‚ã€‚åªæ˜¯åŽè€…å¯ä»¥æ”¾åœ¨ä¸€ä¸ªå¼‚æ­¥çš„çº¿ç¨‹ä¸­è¿›è¡Œæ‰§è¡Œã€‚ å½“æˆ‘ä»¬è°ƒç”¨äº† Dispatcher çš„ enqueue(AsyncCall) æ–¹æ³•çš„æ—¶å€™ä¹Ÿä¼šå°† AsyncCall åŠ å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¼šåœ¨è¯·æ±‚æ‰§è¡Œå®Œæ¯•çš„æ—¶å€™ä»Žè¯¥é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œåªæ˜¯è¿™é‡Œçš„é˜Ÿåˆ—æ˜¯ runningAsyncCalls æˆ–è€… readyAsyncCallsã€‚å®ƒä»¬éƒ½æ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼Œå¹¶ç”¨æ¥å­˜å‚¨å¼‚æ­¥ç±»åž‹çš„è¯·æ±‚ã€‚å®ƒä»¬çš„åŒºåˆ«æ˜¯ï¼ŒrunningAsyncCalls æ˜¯æ­£åœ¨æ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œå½“æ­£åœ¨æ‰§è¡Œçš„é˜Ÿåˆ—è¾¾åˆ°äº†é™åˆ¶çš„æ—¶å€™ï¼Œå°±ä¼šå°†å…¶æ”¾ç½®åˆ°å°±ç»ªé˜Ÿåˆ— readyAsyncCalls ä¸­ï¼š synchronized void enqueue(AsyncCall call) { if (runningAsyncCalls.size() &lt; maxRequests &amp;&amp; runningCallsForHost(call) &lt; maxRequestsPerHost) { runningAsyncCalls.add(call); executorService().execute(call); } else { readyAsyncCalls.add(call); } } å½“æŠŠè¯¥è¯·æ±‚åŠ å…¥åˆ°äº†æ­£åœ¨æ‰§è¡Œçš„é˜Ÿåˆ—ä¹‹åŽï¼Œæˆ‘ä»¬ä¼šç«‹å³ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ± æ¥æ‰§è¡Œè¯¥ AsyncCallã€‚è¿™æ ·è¿™ä¸ªè¯·æ±‚çš„è´£ä»»é“¾å°±ä¼šåœ¨ä¸€ä¸ªçº¿ç¨‹æ± å½“ä¸­è¢«å¼‚æ­¥åœ°æ‰§è¡Œäº†ã€‚è¿™é‡Œçš„çº¿ç¨‹æ± ç”± executorService() æ–¹æ³•è¿”å›žï¼š public synchronized ExecutorService executorService() { if (executorService == null) { executorService = new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(&quot;OkHttp Dispatcher&quot;, false)); } return executorService; } æ˜¾ç„¶ï¼Œå½“çº¿ç¨‹æ± ä¸å­˜åœ¨çš„æ—¶å€™ä¼šåŽ»åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ã€‚é™¤äº†ä¸Šé¢çš„è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨æž„å»º OkHttpClient çš„æ—¶å€™ï¼Œè‡ªå®šä¹‰ä¸€ä¸ª Dispacherï¼Œå¹¶åœ¨å…¶æž„é€ æ–¹æ³•ä¸­ä¸ºå…¶æŒ‡å®šä¸€ä¸ªçº¿ç¨‹æ± ã€‚ä¸‹é¢æˆ‘ä»¬ç±»æ¯” OkHttp çš„åŒæ­¥è¯·æ±‚ç»˜åˆ¶äº†ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚çš„æ—¶åºå›¾ã€‚ä½ å¯ä»¥é€šè¿‡å°†ä¸¤ä¸ªå›¾å¯¹æ¯”æ¥äº†è§£ä¸¤ç§å®žçŽ°æ–¹å¼çš„ä¸åŒï¼š ä»¥ä¸Šå°±æ˜¯åˆ†å‘å™¨ Dispacher çš„é€»è¾‘ï¼Œçœ‹ä¸ŠåŽ»å¹¶æ²¡æœ‰é‚£ä¹ˆå¤æ‚ã€‚å¹¶ä¸”ä»Žä¸Šé¢çš„åˆ†æžä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºå®žé™…è¯·æ±‚çš„æ‰§è¡Œè¿‡ç¨‹å¹¶ä¸æ˜¯åœ¨è¿™é‡Œå®Œæˆçš„ï¼Œè¿™é‡Œåªèƒ½å†³å®šåœ¨å“ªä¸ªçº¿ç¨‹å½“ä¸­æ‰§è¡Œè¯·æ±‚å¹¶æŠŠè¯·æ±‚ç”¨åŒç«¯é˜Ÿåˆ—ç¼“å­˜ä¸‹æ¥ï¼Œè€Œå®žé™…çš„è¯·æ±‚æ‰§è¡Œè¿‡ç¨‹æ˜¯åœ¨è´£ä»»é“¾ä¸­å®Œæˆçš„ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æžä¸€ä¸‹ OkHttp é‡Œçš„è´£ä»»é“¾çš„æ‰§è¡Œè¿‡ç¨‹ã€‚ 2.3 è´£ä»»é“¾çš„æ‰§è¡Œè¿‡ç¨‹åœ¨å…¸åž‹çš„è´£ä»»é“¾è®¾è®¡æ¨¡å¼é‡Œï¼Œå¾ˆå¤šå¯¹è±¡ç”±æ¯ä¸€ä¸ªå¯¹è±¡å¯¹å…¶ä¸‹çº§çš„å¼•ç”¨è€Œè¿žæŽ¥èµ·æ¥å½¢æˆä¸€æ¡é“¾ã€‚è¯·æ±‚åœ¨è¿™ä¸ªé“¾ä¸Šä¼ é€’ï¼Œç›´åˆ°é“¾ä¸Šçš„æŸä¸€ä¸ªå¯¹è±¡å†³å®šå¤„ç†æ­¤è¯·æ±‚ã€‚å‘å‡ºè¿™ä¸ªè¯·æ±‚çš„å®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“é“¾ä¸Šçš„å“ªä¸€ä¸ªå¯¹è±¡æœ€ç»ˆå¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œè¿™ä½¿å¾—ç³»ç»Ÿå¯ä»¥åœ¨ä¸å½±å“å®¢æˆ·ç«¯çš„æƒ…å†µä¸‹åŠ¨æ€åœ°é‡æ–°ç»„ç»‡å’Œåˆ†é…è´£ä»»ã€‚è´£ä»»é“¾åœ¨çŽ°å®žç”Ÿæ´»ä¸­çš„ä¸€ç§åœºæ™¯å°±æ˜¯é¢è¯•ï¼Œå½“æŸè½®é¢è¯•å®˜è§‰å¾—ä½ æ²¡æœ‰èµ„æ ¼è¿›å…¥ä¸‹ä¸€è½®çš„æ—¶å€™å¯ä»¥å¦å®šä½ ï¼Œä¸ç„¶ä¼šè®©ä¸‹ä¸€è½®çš„é¢è¯•å®˜ç»§ç»­é¢è¯•ã€‚ åœ¨ OkHttp é‡Œé¢ï¼Œè´£ä»»é“¾çš„æ‰§è¡Œæ¨¡å¼ä¸Žä¹‹ç¨æœ‰ä¸åŒã€‚è¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥åˆ†æžä¸€ä¸‹åœ¨ OkHttp é‡Œé¢ï¼Œè´£ä»»é“¾æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Œè‡³äºŽæ¯ä¸ªé“¾æ¡é‡Œé¢çš„å…·ä½“é€»è¾‘ï¼Œæˆ‘ä»¬ä¼šåœ¨éšåŽä¸€ä¸€è¯´æ˜Žã€‚ å›žåˆ° 2.1 çš„ä»£ç ï¼Œæœ‰ä¸¤ä¸ªåœ°æ–¹éœ€è¦æˆ‘ä»¬æ³¨æ„ï¼š æ˜¯å½“åˆ›å»ºä¸€ä¸ªè´£ä»»é“¾ RealInterceptorChain çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼ å…¥çš„ç¬¬ 5 ä¸ªå‚æ•°æ˜¯ 0ã€‚è¯¥å‚æ•°åä¸º indexï¼Œä¼šè¢«èµ‹å€¼ç»™ RealInterceptorChain å®žä¾‹å†…éƒ¨çš„åŒåå…¨å±€å˜é‡ã€‚ å½“å¯ç”¨è´£ä»»é“¾çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨å®ƒçš„ proceed(Request) æ–¹æ³•ã€‚ ä¸‹é¢æ˜¯ proceed(Request) æ–¹æ³•çš„å®šä¹‰ï¼š @Override public Response proceed(Request request) throws IOException { return proceed(request, streamAllocation, httpCodec, connection); } è¿™é‡Œåˆè°ƒç”¨äº†å†…éƒ¨çš„é‡è½½çš„ proceed() æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬å¯¹è¯¥æ–¹æ³•è¿›è¡Œäº†ç®€åŒ–ï¼š public Response proceed(Request request, StreamAllocation streamAllocation, HttpCodec httpCodec, RealConnection connection) throws IOException { if (index &gt;= interceptors.size()) throw new AssertionError(); // ... // è°ƒç”¨è´£ä»»é“¾çš„ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ RealInterceptorChain next = new RealInterceptorChain(interceptors, streamAllocation, httpCodec, connection, index + 1, request, call, eventListener, connectTimeout, readTimeout, writeTimeout); Interceptor interceptor = interceptors.get(index); Response response = interceptor.intercept(next); // ... return response; } æ³¨æ„åˆ°è¿™é‡Œä½¿ç”¨è´£ä»»é“¾è¿›è¡Œå¤„ç†çš„æ—¶å€™ï¼Œä¼šæ–°å»ºä¸‹ä¸€ä¸ªè´£ä»»é“¾å¹¶æŠŠ index+! ä½œä¸ºä¸‹ä¸€ä¸ªè´£ä»»é“¾çš„ indexã€‚ç„¶åŽï¼Œæˆ‘ä»¬ä½¿ç”¨ index ä»Žæ‹¦æˆªå™¨åˆ—è¡¨ä¸­å–å‡ºä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œè°ƒç”¨å®ƒçš„ intercept() æ–¹æ³•ï¼Œå¹¶æŠŠä¸‹ä¸€ä¸ªæ‰§è¡Œé“¾ä½œä¸ºå‚æ•°ä¼ é€’è¿›åŽ»ã€‚ è¿™æ ·ï¼Œå½“ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨å¸Œæœ›è‡ªå·±çš„ä¸‹ä¸€çº§ç»§ç»­å¤„ç†è¿™ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œå¯ä»¥è°ƒç”¨ä¼ å…¥çš„è´£ä»»é“¾çš„ proceed() æ–¹æ³•ï¼›å¦‚æžœè‡ªå·±å¤„ç†å®Œæ¯•ä¹‹åŽï¼Œä¸‹ä¸€çº§ä¸éœ€è¦ç»§ç»­å¤„ç†ï¼Œé‚£ä¹ˆå°±ç›´æŽ¥è¿”å›žä¸€ä¸ª Response å®žä¾‹å³å¯ã€‚å› ä¸ºï¼Œæ¯æ¬¡éƒ½æ˜¯åœ¨å½“å‰çš„ index åŸºç¡€ä¸Šé¢åŠ  1ï¼Œæ‰€ä»¥èƒ½åœ¨è°ƒç”¨ proceed() çš„æ—¶å€™å‡†ç¡®åœ°ä»Žæ‹¦æˆªå™¨åˆ—è¡¨ä¸­å–å‡ºä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨è¿›è¡Œå¤„ç†ã€‚ æˆ‘ä»¬è¿˜è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ä¹‹å‰æåˆ°è¿‡é‡è¯•æ‹¦æˆªå™¨ï¼Œè¿™ç§æ‹¦æˆªå™¨ä¼šåœ¨å†…éƒ¨å¯åŠ¨ä¸€ä¸ª while å¾ªçŽ¯ï¼Œå¹¶åœ¨å¾ªçŽ¯ä½“ä¸­è°ƒç”¨æ‰§è¡Œé“¾çš„ proceed() æ–¹æ³•æ¥å®žçŽ°è¯·æ±‚çš„ä¸æ–­é‡è¯•ã€‚è¿™æ˜¯å› ä¸ºåœ¨å®ƒé‚£é‡Œçš„æ‹¦æˆªå™¨é“¾çš„ index æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥èƒ½å¤Ÿæ¯æ¬¡è°ƒç”¨ proceed() çš„æ—¶å€™ï¼Œéƒ½èƒ½å¤Ÿä»Žè‡ªå·±çš„ä¸‹ä¸€çº§æ‰§è¡Œä¸€éé“¾æ¡ã€‚ä¸‹é¢å°±æ˜¯è¿™ä¸ªè´£ä»»é“¾çš„æ‰§è¡Œè¿‡ç¨‹ï¼š æ¸…æ¥šäº† OkHttp çš„æ‹¦æˆªå™¨é“¾çš„æ‰§è¡Œè¿‡ç¨‹ä¹‹åŽï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å„ä¸ªæ‹¦æˆªå™¨åšäº†ä»€ä¹ˆé€»è¾‘ã€‚ 2.3 é‡è¯•å’Œé‡å®šå‘ï¼šRetryAndFollowUpInterceptorRetryAndFollowUpInterceptor ä¸»è¦ç”¨æ¥å½“è¯·æ±‚å¤±è´¥çš„æ—¶å€™è¿›è¡Œé‡è¯•ï¼Œä»¥åŠåœ¨éœ€è¦çš„æƒ…å†µä¸‹è¿›è¡Œé‡å®šå‘ã€‚æˆ‘ä»¬ä¸Šé¢è¯´ï¼Œè´£ä»»é“¾ä¼šåœ¨è¿›è¡Œå¤„ç†çš„æ—¶å€™è°ƒç”¨ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨çš„ intercept() æ–¹æ³•ã€‚å¦‚æžœæˆ‘ä»¬åœ¨åˆ›å»º OkHttp å®¢æˆ·ç«¯çš„æ—¶å€™æ²¡æœ‰åŠ å…¥è‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼Œé‚£ä¹ˆRetryAndFollowUpInterceptor å°±æ˜¯æˆ‘ä»¬çš„è´£ä»»é“¾ä¸­æœ€å…ˆè¢«è°ƒç”¨çš„æ‹¦æˆªå™¨ã€‚ @Override public Response intercept(Chain chain) throws IOException { // ... // æ³¨æ„è¿™é‡Œæˆ‘ä»¬åˆå§‹åŒ–äº†ä¸€ä¸ª StreamAllocation å¹¶èµ‹å€¼ç»™å…¨å±€å˜é‡ï¼Œå®ƒçš„ä½œç”¨æˆ‘ä»¬åŽé¢ä¼šæåˆ° StreamAllocation streamAllocation = new StreamAllocation(client.connectionPool(), createAddress(request.url()), call, eventListener, callStackTrace); this.streamAllocation = streamAllocation; // ç”¨æ¥è®°å½•é‡å®šå‘çš„æ¬¡æ•° int followUpCount = 0; Response priorResponse = null; while (true) { if (canceled) { streamAllocation.release(); throw new IOException(&quot;Canceled&quot;); } Response response; boolean releaseConnection = true; try { // è¿™é‡Œä»Žå½“å‰çš„è´£ä»»é“¾å¼€å§‹æ‰§è¡Œä¸€éè´£ä»»é“¾ï¼Œæ˜¯ä¸€ç§é‡è¯•çš„é€»è¾‘ response = realChain.proceed(request, streamAllocation, null, null); releaseConnection = false; } catch (RouteException e) { // è°ƒç”¨ recover æ–¹æ³•ä»Žå¤±è´¥ä¸­è¿›è¡Œæ¢å¤ï¼Œå¦‚æžœå¯ä»¥æ¢å¤å°±è¿”å›žtrueï¼Œå¦åˆ™è¿”å›žfalse if (!recover(e.getLastConnectException(), streamAllocation, false, request)) { throw e.getLastConnectException(); } releaseConnection = false; continue; } catch (IOException e) { // é‡è¯•ä¸ŽæœåŠ¡å™¨è¿›è¡Œè¿žæŽ¥ boolean requestSendStarted = !(e instanceof ConnectionShutdownException); if (!recover(e, streamAllocation, requestSendStarted, request)) throw e; releaseConnection = false; continue; } finally { // å¦‚æžœ releaseConnection ä¸º true åˆ™è¡¨æ˜Žä¸­é—´å‡ºçŽ°äº†å¼‚å¸¸ï¼Œéœ€è¦é‡Šæ”¾èµ„æº if (releaseConnection) { streamAllocation.streamFailed(null); streamAllocation.release(); } } // ä½¿ç”¨ä¹‹å‰çš„å“åº” priorResponse æž„å»ºä¸€ä¸ªå“åº”ï¼Œè¿™ç§å“åº”çš„å“åº”ä½“ body ä¸ºç©º if (priorResponse != null) { response = response.newBuilder() .priorResponse(priorResponse.newBuilder().body(null).build()) .build(); } // æ ¹æ®å¾—åˆ°çš„å“åº”è¿›è¡Œå¤„ç†ï¼Œå¯èƒ½ä¼šå¢žåŠ ä¸€äº›è®¤è¯ä¿¡æ¯ã€é‡å®šå‘æˆ–è€…å¤„ç†è¶…æ—¶è¯·æ±‚ // å¦‚æžœè¯¥è¯·æ±‚æ— æ³•ç»§ç»­è¢«å¤„ç†æˆ–è€…å‡ºçŽ°çš„é”™è¯¯ä¸éœ€è¦ç»§ç»­å¤„ç†ï¼Œå°†ä¼šè¿”å›ž null Request followUp = followUpRequest(response, streamAllocation.route()); // æ— æ³•é‡å®šå‘ï¼Œç›´æŽ¥è¿”å›žä¹‹å‰çš„å“åº” if (followUp == null) { if (!forWebSocket) { streamAllocation.release(); } return response; } // å…³é—­èµ„æº closeQuietly(response.body()); // è¾¾åˆ°äº†é‡å®šå‘çš„æœ€å¤§æ¬¡æ•°ï¼Œå°±æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ if (++followUpCount &gt; MAX_FOLLOW_UPS) { streamAllocation.release(); throw new ProtocolException(&quot;Too many follow-up requests: &quot; + followUpCount); } if (followUp.body() instanceof UnrepeatableRequestBody) { streamAllocation.release(); throw new HttpRetryException(&quot;Cannot retry streamed HTTP body&quot;, response.code()); } // è¿™é‡Œåˆ¤æ–­æ–°çš„è¯·æ±‚æ˜¯å¦èƒ½å¤Ÿå¤ç”¨ä¹‹å‰çš„è¿žæŽ¥ï¼Œå¦‚æžœæ— æ³•å¤ç”¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„è¿žæŽ¥ if (!sameConnection(response, followUp.url())) { streamAllocation.release(); streamAllocation = new StreamAllocation(client.connectionPool(), createAddress(followUp.url()), call, eventListener, callStackTrace); this.streamAllocation = streamAllocation; } else if (streamAllocation.codec() != null) { throw new IllegalStateException(&quot;Closing the body of &quot; + response + &quot; didn&apos;t close its backing stream. Bad interceptor?&quot;); } request = followUp; priorResponse = response; } } ä»¥ä¸Šçš„ä»£ç ä¸»è¦ç”¨æ¥æ ¹æ®é”™è¯¯çš„ä¿¡æ¯åšä¸€äº›å¤„ç†ï¼Œä¼šæ ¹æ®æœåŠ¡å™¨è¿”å›žçš„ä¿¡æ¯åˆ¤æ–­è¿™ä¸ªè¯·æ±‚æ˜¯å¦å¯ä»¥é‡å®šå‘ï¼Œæˆ–è€…æ˜¯å¦æœ‰å¿…è¦è¿›è¡Œé‡è¯•ã€‚å¦‚æžœå€¼å¾—åŽ»é‡è¯•å°±ä¼šæ–°å»ºæˆ–è€…å¤ç”¨ä¹‹å‰çš„è¿žæŽ¥åœ¨ä¸‹ä¸€æ¬¡å¾ªçŽ¯ä¸­è¿›è¡Œè¯·æ±‚é‡è¯•ï¼Œå¦åˆ™å°±å°†å¾—åˆ°çš„è¯·æ±‚åŒ…è£…ä¹‹åŽè¿”å›žç»™ç”¨æˆ·ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬æåˆ°äº† StreamAllocation å¯¹è±¡ï¼Œå®ƒç›¸å½“äºŽä¸€ä¸ªç®¡ç†ç±»ï¼Œç»´æŠ¤äº†æœåŠ¡å™¨è¿žæŽ¥ã€å¹¶å‘æµå’Œè¯·æ±‚ä¹‹é—´çš„å…³ç³»ï¼Œè¯¥ç±»è¿˜ä¼šåˆå§‹åŒ–ä¸€ä¸ª Socket è¿žæŽ¥å¯¹è±¡ï¼ŒèŽ·å–è¾“å…¥/è¾“å‡ºæµå¯¹è±¡ã€‚åŒæ—¶ï¼Œè¿˜è¦æ³¨æ„è¿™é‡Œæˆ‘ä»¬é€šè¿‡ client.connectionPool() ä¼ å…¥äº†ä¸€ä¸ªè¿žæŽ¥æ± å¯¹è±¡ ConnectionPoolã€‚è¿™é‡Œæˆ‘ä»¬åªæ˜¯åˆå§‹åŒ–äº†è¿™äº›ç±»ï¼Œä½†å®žé™…åœ¨å½“å‰çš„æ–¹æ³•ä¸­å¹¶æ²¡æœ‰çœŸæ­£ç”¨åˆ°è¿™äº›ç±»ï¼Œè€Œæ˜¯æŠŠå®ƒä»¬ä¼ é€’åˆ°ä¸‹é¢çš„æ‹¦æˆªå™¨é‡Œæ¥ä»ŽæœåŠ¡å™¨ä¸­èŽ·å–è¯·æ±‚çš„å“åº”ã€‚ç¨åŽï¼Œæˆ‘ä»¬ä¼šè¯´æ˜Žè¿™äº›ç±»çš„ç”¨é€”ï¼Œä»¥åŠä¹‹é—´çš„å…³ç³»ã€‚ 2.4 BridgeInterceptoræ¡¥æ‹¦æˆªå™¨ BridgeInterceptor ç”¨äºŽä»Žç”¨æˆ·çš„è¯·æ±‚ä¸­æž„å»ºç½‘ç»œè¯·æ±‚ï¼Œç„¶åŽä½¿ç”¨è¯¥è¯·æ±‚è®¿é—®ç½‘ç»œï¼Œæœ€åŽä»Žç½‘ç»œå“åº”å½“ä¸­æž„å»ºç”¨æˆ·å“åº”ã€‚ç›¸å¯¹æ¥è¯´è¿™ä¸ªæ‹¦æˆªå™¨çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯ç”¨æ¥å¯¹è¯·æ±‚è¿›è¡ŒåŒ…è£…ï¼Œå¹¶å°†æœåŠ¡å™¨å“åº”è½¬æ¢æˆç”¨æˆ·å‹å¥½çš„å“åº”ï¼š public final class BridgeInterceptor implements Interceptor { @Override public Response intercept(Chain chain) throws IOException { Request userRequest = chain.request(); // ä»Žç”¨æˆ·è¯·æ±‚ä¸­èŽ·å–ç½‘ç»œè¯·æ±‚æž„å»ºè€… Request.Builder requestBuilder = userRequest.newBuilder(); // ... // æ‰§è¡Œç½‘ç»œè¯·æ±‚ Response networkResponse = chain.proceed(requestBuilder.build()); // ... // ä»Žç½‘ç»œå“åº”ä¸­èŽ·å–ç”¨æˆ·å“åº”æž„å»ºè€… Response.Builder responseBuilder = networkResponse.newBuilder().request(userRequest); // ... // è¿”å›žç”¨æˆ·å“åº” return responseBuilder.build(); } } 2.5 ä½¿ç”¨ç¼“å­˜ï¼šCacheInterceptorç¼“å­˜æ‹¦æˆªå™¨ä¼šæ ¹æ®è¯·æ±‚çš„ä¿¡æ¯å’Œç¼“å­˜çš„å“åº”çš„ä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç¼“å­˜å¯ç”¨ï¼Œå¦‚æžœæœ‰å¯ä»¥ä½¿ç”¨çš„ç¼“å­˜ï¼Œé‚£ä¹ˆå°±è¿”å›žè¯¥ç¼“å­˜è¯¥ç”¨æˆ·ï¼Œå¦åˆ™å°±ç»§ç»­è´£ä»»é“¾æ¥ä»ŽæœåŠ¡å™¨ä¸­èŽ·å–å“åº”ã€‚å½“èŽ·å–åˆ°å“åº”çš„æ—¶å€™ï¼Œåˆä¼šæŠŠå“åº”ç¼“å­˜åˆ°ç£ç›˜ä¸Šé¢ã€‚ä»¥ä¸‹æ˜¯è¿™éƒ¨åˆ†çš„é€»è¾‘ï¼š public final class CacheInterceptor implements Interceptor { @Override public Response intercept(Chain chain) throws IOException { Response cacheCandidate = cache != null ? cache.get(chain.request()) : null; long now = System.currentTimeMillis(); // æ ¹æ®è¯·æ±‚å’Œç¼“å­˜çš„å“åº”ä¸­çš„ä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç¼“å­˜å¯ç”¨ CacheStrategy strategy = new CacheStrategy.Factory(now, chain.request(), cacheCandidate).get(); Request networkRequest = strategy.networkRequest; // å¦‚æžœè¯¥è¯·æ±‚æ²¡æœ‰ä½¿ç”¨ç½‘ç»œå°±ä¸ºç©º Response cacheResponse = strategy.cacheResponse; // å¦‚æžœè¯¥è¯·æ±‚æ²¡æœ‰ä½¿ç”¨ç¼“å­˜å°±ä¸ºç©º if (cache != null) { cache.trackResponse(strategy); } if (cacheCandidate != null &amp;&amp; cacheResponse == null) { closeQuietly(cacheCandidate.body()); } // è¯·æ±‚ä¸ä½¿ç”¨ç½‘ç»œå¹¶ä¸”ä¸ä½¿ç”¨ç¼“å­˜ï¼Œç›¸å½“äºŽåœ¨è¿™é‡Œå°±æ‹¦æˆªäº†ï¼Œæ²¡å¿…è¦äº¤ç»™ä¸‹ä¸€çº§ï¼ˆç½‘ç»œè¯·æ±‚æ‹¦æˆªå™¨ï¼‰æ¥æ‰§è¡Œ if (networkRequest == null &amp;&amp; cacheResponse == null) { return new Response.Builder() .request(chain.request()) .protocol(Protocol.HTTP_1_1) .code(504) .message(&quot;Unsatisfiable Request (only-if-cached)&quot;) .body(Util.EMPTY_RESPONSE) .sentRequestAtMillis(-1L) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); } // è¯¥è¯·æ±‚ä½¿ç”¨ç¼“å­˜ï¼Œä½†æ˜¯ä¸ä½¿ç”¨ç½‘ç»œï¼šä»Žç¼“å­˜ä¸­æ‹¿ç»“æžœï¼Œæ²¡å¿…è¦äº¤ç»™ä¸‹ä¸€çº§ï¼ˆç½‘ç»œè¯·æ±‚æ‹¦æˆªå™¨ï¼‰æ‰§è¡Œ if (networkRequest == null) { return cacheResponse.newBuilder().cacheResponse(stripBody(cacheResponse)).build(); } Response networkResponse = null; try { // è¿™é‡Œè°ƒç”¨äº†æ‰§è¡Œé“¾çš„å¤„ç†æ–¹æ³•ï¼Œå®žé™…å°±æ˜¯äº¤ç»™è‡ªå·±çš„ä¸‹ä¸€çº§æ¥æ‰§è¡Œäº† networkResponse = chain.proceed(networkRequest); } finally { if (networkResponse == null &amp;&amp; cacheCandidate != null) { closeQuietly(cacheCandidate.body()); } } // è¿™é‡Œå½“æ‹¿åˆ°äº†ç½‘ç»œè¯·æ±‚ä¹‹åŽè°ƒç”¨ï¼Œä¸‹ä¸€çº§æ‰§è¡Œå®Œæ¯•ä¼šäº¤ç»™å®ƒç»§ç»­æ‰§è¡Œï¼Œå¦‚æžœä½¿ç”¨äº†ç¼“å­˜å°±æŠŠè¯·æ±‚ç»“æžœæ›´æ–°åˆ°ç¼“å­˜é‡Œ if (cacheResponse != null) { // æœåŠ¡å™¨è¿”å›žçš„ç»“æžœæ˜¯304ï¼Œè¿”å›žç¼“å­˜ä¸­çš„ç»“æžœ if (networkResponse.code() == HTTP_NOT_MODIFIED) { Response response = cacheResponse.newBuilder() .headers(combine(cacheResponse.headers(), networkResponse.headers())) .sentRequestAtMillis(networkResponse.sentRequestAtMillis()) .receivedResponseAtMillis(networkResponse.receivedResponseAtMillis()) .cacheResponse(stripBody(cacheResponse)) .networkResponse(stripBody(networkResponse)) .build(); networkResponse.body().close(); cache.trackConditionalCacheHit(); // æ›´æ–°ç¼“å­˜ cache.update(cacheResponse, response); return response; } else { closeQuietly(cacheResponse.body()); } } Response response = networkResponse.newBuilder() .cacheResponse(stripBody(cacheResponse)) .networkResponse(stripBody(networkResponse)) .build(); // æŠŠè¯·æ±‚çš„ç»“æžœæ”¾è¿›ç¼“å­˜é‡Œ if (cache != null) { if (HttpHeaders.hasBody(response) &amp;&amp; CacheStrategy.isCacheable(response, networkRequest)) { CacheRequest cacheRequest = cache.put(response); return cacheWritingResponse(cacheRequest, response); } if (HttpMethod.invalidatesCache(networkRequest.method())) { try { cache.remove(networkRequest); } catch (IOException ignored) { // The cache cannot be written. } } } return response; } } å¯¹ç¼“å­˜ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å…¨å±€å˜é‡ cacheï¼Œå®ƒæ˜¯ InternalCache ç±»åž‹çš„å˜é‡ã€‚InternalCache æ˜¯ä¸€ä¸ªæŽ¥å£ï¼Œåœ¨ OkHttp ä¸­åªæœ‰ä¸€ä¸ªå®žçŽ°ç±» Cacheã€‚åœ¨ Cache å†…éƒ¨ï¼Œä½¿ç”¨äº† DiskLruCache æ¥å°†ç¼“å­˜çš„æ•°æ®å­˜åˆ°ç£ç›˜ä¸Šã€‚DiskLruCache ä»¥åŠ LruCache æ˜¯ Android ä¸Šå¸¸ç”¨çš„ä¸¤ç§ç¼“å­˜ç­–ç•¥ã€‚å‰è€…æ˜¯åŸºäºŽç£ç›˜æ¥è¿›è¡Œç¼“å­˜çš„ï¼ŒåŽè€…æ˜¯åŸºäºŽå†…å­˜æ¥è¿›è¡Œç¼“å­˜çš„ï¼Œå®ƒä»¬çš„æ ¸å¿ƒæ€æƒ³éƒ½æ˜¯ Least Recently Usedï¼Œå³æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ã€‚æˆ‘ä»¬ä¼šåœ¨ä»¥åŽçš„æ–‡ç« ä¸­è¯¦ç»†ä»‹ç»è¿™ä¸¤ç§ç¼“å­˜æ¡†æž¶ï¼Œä¹Ÿè¯·ç»§ç»­å…³æ³¨æˆ‘ä»¬çš„æ–‡ç« ã€‚ å¦å¤–ï¼Œä¸Šé¢æˆ‘ä»¬æ ¹æ®è¯·æ±‚å’Œç¼“å­˜çš„å“åº”ä¸­çš„ä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç¼“å­˜å¯ç”¨çš„æ—¶å€™ç”¨åˆ°äº† CacheStrategy çš„ä¸¤ä¸ªå­—æ®µï¼Œå¾—åˆ°è¿™ä¸¤ä¸ªå­—æ®µçš„æ—¶å€™ä½¿ç”¨äº†éžå¸¸å¤šçš„åˆ¤æ–­ï¼Œå…¶ä¸­æ¶‰åŠ Http ç¼“å­˜ç›¸å…³çš„çŸ¥è¯†ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥è‡ªå·±å‚è€ƒæºä»£ç ã€‚ 2.6 è¿žæŽ¥å¤ç”¨ï¼šConnectInterceptorè¿žæŽ¥æ‹¦æˆªå™¨ ConnectInterceptor ç”¨æ¥æ‰“å¼€åˆ°æŒ‡å®šæœåŠ¡å™¨çš„ç½‘ç»œè¿žæŽ¥ï¼Œå¹¶äº¤ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨å¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬åªæ‰“å¼€äº†ä¸€ä¸ªç½‘ç»œè¿žæŽ¥ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨ã€‚ä»ŽæœåŠ¡å™¨èŽ·å–æ•°æ®çš„é€»è¾‘äº¤ç»™ä¸‹ä¸€çº§çš„æ‹¦æˆªå™¨æ¥æ‰§è¡Œã€‚è™½ç„¶ï¼Œè¿™é‡Œå¹¶æ²¡æœ‰çœŸæ­£åœ°ä»Žç½‘ç»œä¸­èŽ·å–æ•°æ®ï¼Œè€Œä»…ä»…æ˜¯æ‰“å¼€ä¸€ä¸ªè¿žæŽ¥ï¼Œä½†è¿™é‡Œæœ‰ä¸å°‘çš„å†…å®¹å€¼å¾—æˆ‘ä»¬åŽ»å…³æ³¨ã€‚å› ä¸ºåœ¨èŽ·å–è¿žæŽ¥å¯¹è±¡çš„æ—¶å€™ï¼Œä½¿ç”¨äº†è¿žæŽ¥æ±  ConnectionPool æ¥å¤ç”¨è¿žæŽ¥ã€‚ public final class ConnectInterceptor implements Interceptor { @Override public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain) chain; Request request = realChain.request(); StreamAllocation streamAllocation = realChain.streamAllocation(); boolean doExtensiveHealthChecks = !request.method().equals(&quot;GET&quot;); HttpCodec httpCodec = streamAllocation.newStream(client, chain, doExtensiveHealthChecks); RealConnection connection = streamAllocation.connection(); return realChain.proceed(request, streamAllocation, httpCodec, connection); } } è¿™é‡Œçš„ HttpCodec ç”¨æ¥ç¼–ç è¯·æ±‚å¹¶è§£ç å“åº”ï¼ŒRealConnection ç”¨æ¥å‘æœåŠ¡å™¨å‘èµ·è¿žæŽ¥ã€‚å®ƒä»¬ä¼šåœ¨ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­è¢«ç”¨æ¥ä»ŽæœåŠ¡å™¨ä¸­èŽ·å–å“åº”ä¿¡æ¯ã€‚ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨çš„é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œè¿™é‡Œä¸‡äº‹å…·å¤‡ä¹‹åŽï¼Œåªè¦å®ƒæ¥ä»ŽæœåŠ¡å™¨ä¸­è¯»å–æ•°æ®å³å¯ã€‚å¯ä»¥è¯´ï¼ŒOkHttp ä¸­çš„æ ¸å¿ƒéƒ¨åˆ†å¤§æ¦‚å°±åœ¨è¿™é‡Œï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å°±å…ˆå¥½å¥½åˆ†æžä¸€ä¸‹ï¼Œè¿™é‡Œåœ¨åˆ›å»ºè¿žæŽ¥çš„æ—¶å€™å¦‚ä½•å€ŸåŠ©è¿žæŽ¥æ± æ¥å®žçŽ°è¿žæŽ¥å¤ç”¨çš„ã€‚ æ ¹æ®ä¸Šé¢çš„ä»£ç ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ streamAllocation çš„ newStream() æ–¹æ³•çš„æ—¶å€™ï¼Œæœ€ç»ˆä¼šç»è¿‡ä¸€ç³»åˆ—çš„åˆ¤æ–­åˆ°è¾¾ StreamAllocation ä¸­çš„ findConnection() æ–¹æ³•ã€‚ private RealConnection findConnection(int connectTimeout, int readTimeout, int writeTimeout, int pingIntervalMillis, boolean connectionRetryEnabled) throws IOException { // ... synchronized (connectionPool) { // ... // å°è¯•ä½¿ç”¨å·²åˆ†é…çš„è¿žæŽ¥ï¼Œå·²ç»åˆ†é…çš„è¿žæŽ¥å¯èƒ½å·²ç»è¢«é™åˆ¶åˆ›å»ºæ–°çš„æµ releasedConnection = this.connection; // é‡Šæ”¾å½“å‰è¿žæŽ¥çš„èµ„æºï¼Œå¦‚æžœè¯¥è¿žæŽ¥å·²ç»è¢«é™åˆ¶åˆ›å»ºæ–°çš„æµï¼Œå°±è¿”å›žä¸€ä¸ªSocketä»¥å…³é—­è¿žæŽ¥ toClose = releaseIfNoNewStreams(); if (this.connection != null) { // å·²åˆ†é…è¿žæŽ¥ï¼Œå¹¶ä¸”è¯¥è¿žæŽ¥å¯ç”¨ result = this.connection; releasedConnection = null; } if (!reportedAcquired) { // å¦‚æžœè¯¥è¿žæŽ¥ä»Žæœªè¢«æ ‡è®°ä¸ºèŽ·å¾—ï¼Œä¸è¦æ ‡è®°ä¸ºå‘å¸ƒçŠ¶æ€ï¼ŒreportedAcquired é€šè¿‡ acquire() æ–¹æ³•ä¿®æ”¹ releasedConnection = null; } if (result == null) { // å°è¯•ä¾›è¿žæŽ¥æ± ä¸­èŽ·å–ä¸€ä¸ªè¿žæŽ¥ Internal.instance.get(connectionPool, address, this, null); if (connection != null) { foundPooledConnection = true; result = connection; } else { selectedRoute = route; } } } // å…³é—­è¿žæŽ¥ closeQuietly(toClose); if (releasedConnection != null) { eventListener.connectionReleased(call, releasedConnection); } if (foundPooledConnection) { eventListener.connectionAcquired(call, result); } if (result != null) { // å¦‚æžœå·²ç»ä»Žè¿žæŽ¥æ± ä¸­èŽ·å–åˆ°äº†ä¸€ä¸ªè¿žæŽ¥ï¼Œå°±å°†å…¶è¿”å›ž return result; } boolean newRouteSelection = false; if (selectedRoute == null &amp;&amp; (routeSelection == null || !routeSelection.hasNext())) { newRouteSelection = true; routeSelection = routeSelector.next(); } synchronized (connectionPool) { if (canceled) throw new IOException(&quot;Canceled&quot;); if (newRouteSelection) { // æ ¹æ®ä¸€ç³»åˆ—çš„ IP åœ°å€ä»Žè¿žæŽ¥æ± ä¸­èŽ·å–ä¸€ä¸ªé“¾æŽ¥ List&lt;Route&gt; routes = routeSelection.getAll(); for (int i = 0, size = routes.size(); i &lt; size; i++) { Route route = routes.get(i); // ä»Žè¿žæŽ¥æ± ä¸­èŽ·å–ä¸€ä¸ªè¿žæŽ¥ Internal.instance.get(connectionPool, address, this, route); if (connection != null) { foundPooledConnection = true; result = connection; this.route = route; break; } } } if (!foundPooledConnection) { if (selectedRoute == null) { selectedRoute = routeSelection.next(); } // åˆ›å»ºä¸€ä¸ªæ–°çš„è¿žæŽ¥ï¼Œå¹¶å°†å…¶åˆ†é…ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨æ¡æ‰‹ä¹‹å‰è¿›è¡Œç»ˆç«¯ route = selectedRoute; refusedStreamCount = 0; result = new RealConnection(connectionPool, selectedRoute); acquire(result, false); } } // å¦‚æžœæˆ‘ä»¬åœ¨ç¬¬äºŒæ¬¡çš„æ—¶å€™å‘çŽ°äº†ä¸€ä¸ªæ± è¿žæŽ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å°†å…¶è¿”å›ž if (foundPooledConnection) { eventListener.connectionAcquired(call, result); return result; } // è¿›è¡Œ TCP å’Œ TLS æ¡æ‰‹ result.connect(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis, connectionRetryEnabled, call, eventListener); routeDatabase().connected(result.route()); Socket socket = null; synchronized (connectionPool) { reportedAcquired = true; // å°†è¯¥è¿žæŽ¥æ”¾è¿›è¿žæŽ¥æ± ä¸­ Internal.instance.put(connectionPool, result); // å¦‚æžœåŒæ—¶åˆ›å»ºäº†å¦ä¸€ä¸ªåˆ°åŒä¸€åœ°å€çš„å¤šè·¯å¤ç”¨è¿žæŽ¥ï¼Œé‡Šæ”¾è¿™ä¸ªè¿žæŽ¥å¹¶èŽ·å–é‚£ä¸ªè¿žæŽ¥ if (result.isMultiplexed()) { socket = Internal.instance.deduplicate(connectionPool, address, this); result = connection; } } closeQuietly(socket); eventListener.connectionAcquired(call, result); return result; } è¯¥æ–¹æ³•ä¼šè¢«æ”¾ç½®åœ¨ä¸€ä¸ªå¾ªçŽ¯å½“ä¸­è¢«ä¸åœåœ°è°ƒç”¨ä»¥å¾—åˆ°ä¸€ä¸ªå¯ç”¨çš„è¿žæŽ¥ã€‚å®ƒä¼˜å…ˆä½¿ç”¨å½“å‰å·²ç»å­˜åœ¨çš„è¿žæŽ¥ï¼Œä¸ç„¶å°±ä½¿ç”¨è¿žæŽ¥æ± ä¸­å­˜åœ¨çš„è¿žæŽ¥ï¼Œå†ä¸è¡Œçš„è¯ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„è¿žæŽ¥ã€‚æ‰€ä»¥ï¼Œä¸Šé¢çš„ä»£ç å¤§è‡´åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼š åˆ¤æ–­å½“å‰çš„è¿žæŽ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨ï¼šæµæ˜¯å¦å·²ç»è¢«å…³é—­ï¼Œå¹¶ä¸”å·²ç»è¢«é™åˆ¶åˆ›å»ºæ–°çš„æµï¼› å¦‚æžœå½“å‰çš„è¿žæŽ¥æ— æ³•ä½¿ç”¨ï¼Œå°±ä»Žè¿žæŽ¥æ± ä¸­èŽ·å–ä¸€ä¸ªè¿žæŽ¥ï¼› è¿žæŽ¥æ± ä¸­ä¹Ÿæ²¡æœ‰å‘çŽ°å¯ç”¨çš„è¿žæŽ¥ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„è¿žæŽ¥ï¼Œå¹¶è¿›è¡Œæ¡æ‰‹ï¼Œç„¶åŽå°†å…¶æ”¾åˆ°è¿žæŽ¥æ± ä¸­ã€‚ åœ¨ä»Žè¿žæŽ¥æ± ä¸­èŽ·å–ä¸€ä¸ªè¿žæŽ¥çš„æ—¶å€™ï¼Œä½¿ç”¨äº† Internal çš„ get() æ–¹æ³•ã€‚Internal æœ‰ä¸€ä¸ªé™æ€çš„å®žä¾‹ï¼Œä¼šåœ¨ OkHttpClient çš„é™æ€ä»£ç å¿«ä¸­è¢«åˆå§‹åŒ–ã€‚æˆ‘ä»¬ä¼šåœ¨ Internal çš„ get() ä¸­è°ƒç”¨è¿žæŽ¥æ± çš„ get() æ–¹æ³•æ¥å¾—åˆ°ä¸€ä¸ªè¿žæŽ¥ã€‚ ä»Žä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå®žé™…ä¸Šï¼Œæˆ‘ä»¬ä½¿ç”¨è¿žæŽ¥å¤ç”¨çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯çœåŽ»äº†è¿›è¡Œ TCP å’Œ TLS æ¡æ‰‹çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚å› ä¸ºå»ºç«‹è¿žæŽ¥æœ¬èº«ä¹Ÿæ˜¯éœ€è¦æ¶ˆè€—ä¸€äº›æ—¶é—´çš„ï¼Œè¿žæŽ¥è¢«å¤ç”¨ä¹‹åŽå¯ä»¥æå‡æˆ‘ä»¬ç½‘ç»œè®¿é—®çš„æ•ˆçŽ‡ã€‚é‚£ä¹ˆè¿™äº›è¿žæŽ¥è¢«æ”¾ç½®åœ¨è¿žæŽ¥æ± ä¹‹åŽæ˜¯å¦‚ä½•è¿›è¡Œç®¡ç†çš„å‘¢ï¼Ÿæˆ‘ä»¬ä¼šåœ¨ä¸‹æ–‡ä¸­åˆ†æž OkHttp çš„ ConnectionPool ä¸­æ˜¯å¦‚ä½•ç®¡ç†è¿™äº›è¿žæŽ¥çš„ã€‚ 2.7 CallServerInterceptoræœåŠ¡å™¨è¯·æ±‚æ‹¦æˆªå™¨ CallServerInterceptor ç”¨æ¥å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚å¹¶èŽ·å–æ•°æ®ã€‚è¿™æ˜¯æ•´ä¸ªè´£ä»»é“¾çš„æœ€åŽä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œè¿™é‡Œæ²¡æœ‰å†ç»§ç»­è°ƒç”¨æ‰§è¡Œé“¾çš„å¤„ç†æ–¹æ³•ï¼Œè€Œæ˜¯æŠŠæ‹¿åˆ°çš„å“åº”å¤„ç†ä¹‹åŽç›´æŽ¥è¿”å›žç»™äº†ä¸Šä¸€çº§çš„æ‹¦æˆªå™¨ï¼š public final class CallServerInterceptor implements Interceptor { @Override public Response intercept(Chain chain) throws IOException { RealInterceptorChain realChain = (RealInterceptorChain) chain; // èŽ·å– ConnectInterceptor ä¸­åˆå§‹åŒ–çš„ HttpCodec HttpCodec httpCodec = realChain.httpStream(); // èŽ·å– RetryAndFollowUpInterceptor ä¸­åˆå§‹åŒ–çš„ StreamAllocation StreamAllocation streamAllocation = realChain.streamAllocation(); // èŽ·å– ConnectInterceptor ä¸­åˆå§‹åŒ–çš„ RealConnection RealConnection connection = (RealConnection) realChain.connection(); Request request = realChain.request(); long sentRequestMillis = System.currentTimeMillis(); realChain.eventListener().requestHeadersStart(realChain.call()); // åœ¨è¿™é‡Œå†™å…¥è¯·æ±‚å¤´ httpCodec.writeRequestHeaders(request); realChain.eventListener().requestHeadersEnd(realChain.call(), request); Response.Builder responseBuilder = null; if (HttpMethod.permitsRequestBody(request.method()) &amp;&amp; request.body() != null) { if (&quot;100-continue&quot;.equalsIgnoreCase(request.header(&quot;Expect&quot;))) { httpCodec.flushRequest(); realChain.eventListener().responseHeadersStart(realChain.call()); responseBuilder = httpCodec.readResponseHeaders(true); } // åœ¨è¿™é‡Œå†™å…¥è¯·æ±‚ä½“ if (responseBuilder == null) { realChain.eventListener().requestBodyStart(realChain.call()); long contentLength = request.body().contentLength(); CountingSink requestBodyOut = new CountingSink(httpCodec.createRequestBody(request, contentLength)); BufferedSink bufferedRequestBody = Okio.buffer(requestBodyOut); // å†™å…¥è¯·æ±‚ä½“ request.body().writeTo(bufferedRequestBody); bufferedRequestBody.close(); realChain.eventListener() .requestBodyEnd(realChain.call(), requestBodyOut.successfulCount); } else if (!connection.isMultiplexed()) { streamAllocation.noNewStreams(); } } httpCodec.finishRequest(); if (responseBuilder == null) { realChain.eventListener().responseHeadersStart(realChain.call()); // è¯»å–å“åº”å¤´ responseBuilder = httpCodec.readResponseHeaders(false); } Response response = responseBuilder .request(request) .handshake(streamAllocation.connection().handshake()) .sentRequestAtMillis(sentRequestMillis) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); // è¯»å–å“åº”ä½“ int code = response.code(); if (code == 100) { responseBuilder = httpCodec.readResponseHeaders(false); response = responseBuilder .request(request) .handshake(streamAllocation.connection().handshake()) .sentRequestAtMillis(sentRequestMillis) .receivedResponseAtMillis(System.currentTimeMillis()) .build(); code = response.code(); } realChain.eventListener().responseHeadersEnd(realChain.call(), response); if (forWebSocket &amp;&amp; code == 101) { response = response.newBuilder() .body(Util.EMPTY_RESPONSE) .build(); } else { response = response.newBuilder() .body(httpCodec.openResponseBody(response)) .build(); } // ... return response; } } 2.8 è¿žæŽ¥ç®¡ç†ï¼šConnectionPoolä¸Žè¯·æ±‚çš„ç¼“å­˜ç±»ä¼¼ï¼ŒOkHttp çš„è¿žæŽ¥æ± ä¹Ÿä½¿ç”¨ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—æ¥ç¼“å­˜å·²ç»åˆ›å»ºçš„è¿žæŽ¥ï¼š private final Deque&lt;RealConnection&gt; connections = new ArrayDeque&lt;&gt;(); OkHttp çš„ç¼“å­˜ç®¡ç†åˆ†æˆä¸¤ä¸ªæ­¥éª¤ï¼Œä¸€è¾¹å½“æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„è¿žæŽ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦æŠŠå®ƒæ”¾è¿›ç¼“å­˜é‡Œé¢ï¼›å¦ä¸€è¾¹ï¼Œæˆ‘ä»¬è¿˜è¦æ¥å¯¹ç¼“å­˜è¿›è¡Œæ¸…ç†ã€‚åœ¨ ConnectionPool ä¸­ï¼Œå½“æˆ‘ä»¬å‘è¿žæŽ¥æ± ä¸­ç¼“å­˜ä¸€ä¸ªè¿žæŽ¥çš„æ—¶å€™ï¼Œåªè¦è°ƒç”¨åŒç«¯é˜Ÿåˆ—çš„ add() æ–¹æ³•ï¼Œå°†å…¶åŠ å…¥åˆ°åŒç«¯é˜Ÿåˆ—å³å¯ï¼Œè€Œæ¸…ç†è¿žæŽ¥ç¼“å­˜çš„æ“ä½œåˆ™äº¤ç»™çº¿ç¨‹æ± æ¥å®šæ—¶æ‰§è¡Œã€‚ åœ¨ ConnectionPool ä¸­å­˜åœ¨ä¸€ä¸ªé™æ€çš„çº¿ç¨‹æ± ï¼š private static final Executor executor = new ThreadPoolExecutor(0 /* corePoolSize */, Integer.MAX_VALUE /* maximumPoolSize */, 60L /* keepAliveTime */, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(&quot;OkHttp ConnectionPool&quot;, true)); æ¯å½“æˆ‘ä»¬å‘è¿žæŽ¥æ± ä¸­æ’å…¥ä¸€ä¸ªè¿žæŽ¥çš„æ—¶å€™å°±ä¼šè°ƒç”¨ä¸‹é¢çš„æ–¹æ³•ï¼Œå°†è¿žæŽ¥æ’å…¥åˆ°åŒç«¯é˜Ÿåˆ—çš„åŒæ—¶ï¼Œä¼šè°ƒç”¨ä¸Šé¢çš„çº¿ç¨‹æ± æ¥æ‰§è¡Œæ¸…ç†ç¼“å­˜çš„ä»»åŠ¡ï¼š void put(RealConnection connection) { assert (Thread.holdsLock(this)); if (!cleanupRunning) { cleanupRunning = true; // ä½¿ç”¨çº¿ç¨‹æ± æ‰§è¡Œæ¸…ç†ä»»åŠ¡ executor.execute(cleanupRunnable); } // å°†æ–°å»ºçš„è¿žæŽ¥æ’å…¥åˆ°åŒç«¯é˜Ÿåˆ—ä¸­ connections.add(connection); } è¿™é‡Œçš„æ¸…ç†ä»»åŠ¡æ˜¯ cleanupRunnableï¼Œæ˜¯ä¸€ä¸ª Runnable ç±»åž‹çš„å®žä¾‹ã€‚å®ƒä¼šåœ¨æ–¹æ³•å†…éƒ¨è°ƒç”¨ cleanup() æ–¹æ³•æ¥æ¸…ç†æ— æ•ˆçš„è¿žæŽ¥ï¼š private final Runnable cleanupRunnable = new Runnable() { @Override public void run() { while (true) { long waitNanos = cleanup(System.nanoTime()); if (waitNanos == -1) return; if (waitNanos &gt; 0) { long waitMillis = waitNanos / 1000000L; waitNanos -= (waitMillis * 1000000L); synchronized (ConnectionPool.this) { try { ConnectionPool.this.wait(waitMillis, (int) waitNanos); } catch (InterruptedException ignored) { } } } } } }; ä¸‹é¢æ˜¯ cleanup() æ–¹æ³•ï¼š long cleanup(long now) { int inUseConnectionCount = 0; int idleConnectionCount = 0; RealConnection longestIdleConnection = null; long longestIdleDurationNs = Long.MIN_VALUE; synchronized (this) { // éåŽ†æ‰€æœ‰çš„è¿žæŽ¥ for (Iterator&lt;RealConnection&gt; i = connections.iterator(); i.hasNext(); ) { RealConnection connection = i.next(); // å½“å‰çš„è¿žæŽ¥æ­£åœ¨ä½¿ç”¨ä¸­ if (pruneAndGetAllocationCount(connection, now) &gt; 0) { inUseConnectionCount++; continue; } idleConnectionCount++; // å¦‚æžœæ‰¾åˆ°äº†ä¸€ä¸ªå¯ä»¥è¢«æ¸…ç†çš„è¿žæŽ¥ï¼Œä¼šå°è¯•åŽ»å¯»æ‰¾é—²ç½®æ—¶é—´æœ€ä¹…çš„è¿žæŽ¥æ¥é‡Šæ”¾ long idleDurationNs = now - connection.idleAtNanos; if (idleDurationNs &gt; longestIdleDurationNs) { longestIdleDurationNs = idleDurationNs; longestIdleConnection = connection; } } if (longestIdleDurationNs &gt;= this.keepAliveDurationNs || idleConnectionCount &gt; this.maxIdleConnections) { // è¯¥è¿žæŽ¥çš„æ—¶é•¿è¶…å‡ºäº†æœ€å¤§çš„æ´»è·ƒæ—¶é•¿æˆ–è€…é—²ç½®çš„è¿žæŽ¥æ•°é‡è¶…å‡ºäº†æœ€å¤§å…è®¸çš„èŒƒå›´ï¼Œç›´æŽ¥ç§»é™¤ connections.remove(longestIdleConnection); } else if (idleConnectionCount &gt; 0) { // é—²ç½®çš„è¿žæŽ¥çš„æ•°é‡å¤§äºŽ0ï¼Œåœé¡¿æŒ‡å®šçš„æ—¶é—´ï¼ˆç­‰ä¼šå„¿ä¼šå°†å…¶æ¸…ç†æŽ‰ï¼ŒçŽ°åœ¨è¿˜ä¸æ˜¯æ—¶å€™ï¼‰ return keepAliveDurationNs - longestIdleDurationNs; } else if (inUseConnectionCount &gt; 0) { // æ‰€æœ‰çš„è¿žæŽ¥éƒ½åœ¨ä½¿ç”¨ä¸­ï¼Œ5åˆ†é’ŸåŽå†æ¸…ç† return keepAliveDurationNs; } else { // æ²¡æœ‰è¿žæŽ¥ cleanupRunning = false; return -1; } } closeQuietly(longestIdleConnection.socket()); return 0; } åœ¨ä»Žç¼“å­˜çš„è¿žæŽ¥ä¸­å–å‡ºè¿žæŽ¥æ¥åˆ¤æ–­æ˜¯å¦åº”è¯¥å°†å…¶é‡Šæ”¾çš„æ—¶å€™ä½¿ç”¨åˆ°äº†ä¸¤ä¸ªå˜é‡ maxIdleConnections å’Œ keepAliveDurationNsï¼Œåˆ†åˆ«è¡¨ç¤ºæœ€å¤§å…è®¸çš„é—²ç½®çš„è¿žæŽ¥çš„æ•°é‡å’Œè¿žæŽ¥å…è®¸å­˜æ´»çš„æœ€é•¿çš„æ—¶é—´ã€‚é»˜è®¤ç©ºé—²è¿žæŽ¥æœ€å¤§æ•°ç›®ä¸º5ä¸ªï¼Œkeepalive æ—¶é—´æœ€é•¿ä¸º5åˆ†é’Ÿã€‚ ä¸Šé¢çš„æ–¹æ³•ä¼šå¯¹ç¼“å­˜ä¸­çš„è¿žæŽ¥è¿›è¡ŒéåŽ†ï¼Œä»¥å¯»æ‰¾ä¸€ä¸ªé—²ç½®æ—¶é—´æœ€é•¿çš„è¿žæŽ¥ï¼Œç„¶åŽæ ¹æ®è¯¥è¿žæŽ¥çš„é—²ç½®æ—¶é•¿å’Œæœ€å¤§å…è®¸çš„è¿žæŽ¥æ•°é‡ç­‰å‚æ•°æ¥å†³å®šæ˜¯å¦åº”è¯¥æ¸…ç†è¯¥è¿žæŽ¥ã€‚åŒæ—¶æ³¨æ„ä¸Šé¢çš„æ–¹æ³•çš„è¿”å›žå€¼æ˜¯ä¸€ä¸ªæ—¶é—´ï¼Œå¦‚æžœé—²ç½®æ—¶é—´æœ€é•¿çš„è¿žæŽ¥ä»ç„¶éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½è¢«æ¸…ç†çš„æ—¶å€™ï¼Œä¼šè¿”å›žè¿™æ®µæ—¶é—´çš„æ—¶é—´å·®ï¼Œç„¶åŽä¼šåœ¨è¿™æ®µæ—¶é—´ä¹‹åŽå†æ¬¡å¯¹è¿žæŽ¥æ± è¿›è¡Œæ¸…ç†ã€‚ æ€»ç»“ï¼šä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬å¯¹ OkHttp å†…éƒ¨ç½‘ç»œè®¿é—®çš„æºç çš„åˆ†æžã€‚å½“æˆ‘ä»¬å‘èµ·ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ä¼šåˆå§‹åŒ–ä¸€ä¸ª Call çš„å®žä¾‹ï¼Œç„¶åŽæ ¹æ®åŒæ­¥å’Œå¼‚æ­¥çš„ä¸åŒï¼Œåˆ†åˆ«è°ƒç”¨å®ƒçš„ execute() å’Œ enqueue() æ–¹æ³•ã€‚è™½ç„¶ï¼Œä¸¤ä¸ªæ–¹æ³•ä¸€ä¸ªä¼šåœ¨å½“å‰çš„çº¿ç¨‹ä¸­è¢«ç«‹å³æ‰§è¡Œï¼Œä¸€ä¸ªä¼šåœ¨çº¿ç¨‹æ± å½“ä¸­æ‰§è¡Œï¼Œä½†æ˜¯å®ƒä»¬è¿›è¡Œç½‘ç»œè®¿é—®çš„é€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼šé€šè¿‡æ‹¦æˆªå™¨ç»„æˆçš„è´£ä»»é“¾ï¼Œä¾æ¬¡ç»è¿‡é‡è¯•ã€æ¡¥æŽ¥ã€ç¼“å­˜ã€è¿žæŽ¥å’Œè®¿é—®æœåŠ¡å™¨ç­‰è¿‡ç¨‹ï¼Œæ¥èŽ·å–åˆ°ä¸€ä¸ªå“åº”å¹¶äº¤ç»™ç”¨æˆ·ã€‚å…¶ä¸­ï¼Œç¼“å­˜å’Œè¿žæŽ¥ä¸¤éƒ¨åˆ†å†…å®¹æ˜¯é‡ç‚¹ï¼Œå› ä¸ºå‰è€…æ¶‰åŠåˆ°äº†ä¸€äº›è®¡ç®—æœºç½‘ç»œæ–¹é¢çš„çŸ¥è¯†ï¼ŒåŽè€…åˆ™æ˜¯ OkHttp æ•ˆçŽ‡å’Œæ¡†æž¶çš„æ ¸å¿ƒã€‚]]></content>
      <categories>
        <category>Androidç½‘ç»œè®¿é—®</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Java</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
        <tag>OkHttp</tag>
        <tag>æºç é˜…è¯»</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[View ä½“ç³»è¯¦è§£ï¼šåæ ‡ç³»ã€æ»‘åŠ¨äº‹ä»¶å’Œåˆ†å‘æœºåˆ¶]]></title>
    <url>%2F2018%2F10%2F14%2FView%20%E4%BD%93%E7%B3%BB%E8%AF%A6%E8%A7%A3%EF%BC%9A%E5%9D%90%E6%A0%87%E7%B3%BB%E3%80%81%E6%BB%91%E5%8A%A8%E4%BA%8B%E4%BB%B6%E5%92%8C%E5%88%86%E5%8F%91%E6%9C%BA%E5%88%B6%2F</url>
    <content type="text"><![CDATA[1ã€ä½ç½®1.1 åæ ‡ç³»ä¸‹é¢æ˜¯ Android ä¸­çš„ View åæ ‡ç³»çš„åŸºæœ¬å›¾ã€‚è¦èŽ·å¾—ä¸€ä¸ª View çš„ä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯ View ï¼Œä¸€ä¸ªæ˜¯ MotionEventã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„ä¸€äº›æ–¹æ³•çš„ä½ç½®çš„å«ä¹‰ï¼š åœ¨ View ä¸­å…±æœ‰ mLeft, mRight, mTop å’Œ mBottom å››ä¸ªå˜é‡åŒ…å« View çš„åæ ‡ä¿¡æ¯ï¼Œä½ å¯ä»¥åœ¨æºç ä¸­èŽ·å–å®ƒä»¬çš„å«ä¹‰ï¼š mLeftï¼šæŒ‡å®šæŽ§ä»¶çš„å·¦è¾¹ç¼˜è·ç¦»å…¶çˆ¶æŽ§ä»¶å·¦è¾¹ç¼˜çš„ä½ç½®ï¼Œå•ä½ï¼šåƒç´ ï¼› mRightï¼šæŒ‡å®šæŽ§ä»¶çš„å³è¾¹ç¼˜è·ç¦»å…¶çˆ¶æŽ§ä»¶å·¦è¾¹ç¼˜çš„ä½ç½®ï¼Œå•ä½ï¼šåƒç´ ï¼› mTopï¼šæŒ‡å®šæŽ§ä»¶çš„ä¸Šè¾¹ç¼˜è·ç¦»å…¶çˆ¶æŽ§ä»¶ä¸Šè¾¹ç¼˜çš„ä½ç½®ï¼Œå•ä½ï¼šåƒç´ ï¼› mBottomï¼šæŒ‡å®šæŽ§ä»¶çš„ä¸‹è¾¹ç¼˜è·ç¦»å…¶çˆ¶æŽ§ä»¶ä¸Šè¾¹ç¼˜çš„ä½ç½®ï¼Œå•ä½ï¼šåƒç´ ã€‚ æ­¤å¤–ï¼ŒView ä¸­è¿˜æœ‰å‡ ä¸ªæ–¹æ³•ç”¨æ¥èŽ·å–æŽ§ä»¶çš„ä½ç½®ç­‰ä¿¡æ¯ï¼Œå®žé™…ä¸Šå°±æ˜¯ä¸Šé¢å››ä¸ªå˜é‡çš„ getter æ–¹æ³•ï¼š getLeft()ï¼šå³ mLeftï¼› getRight()ï¼šå³ mRightï¼› getTop()ï¼šå³ mTopï¼› getBottom()ï¼šå³ mBottomï¼› æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸¤ä¸ªèŽ·å– View é«˜åº¦å’Œå®½åº¦ä¿¡æ¯çš„æ–¹æ³•ï¼š getHeight()ï¼šå³ mBottom - mTopï¼› getWidth()ï¼šå³ mRight - mLeftï¼› å¦å¤–ï¼Œå°±æ˜¯ View ä¸­çš„ getX() å’Œ getY() ä¸¤ä¸ªæ–¹æ³•ï¼Œä½ éœ€è¦æ³¨æ„å°†å…¶ä¸Ž MotionEvent ä¸­çš„åŒåæ–¹æ³•è¿›è¡ŒåŒºåˆ†ã€‚åœ¨æ²¡æœ‰å¯¹æŽ§ä»¶è¿›è¡Œå¹³ç§»çš„æ—¶å€™ï¼ŒgetX() ä¸Ž getLeft() è¿”å›žç»“æžœç›¸åŒï¼Œåªæ˜¯å‰è€…ä¼šåœ¨åŽè€…çš„åŸºç¡€ä¸ŠåŠ ä¸Šå¹³ç§»çš„è·ç¦»ï¼š getX()ï¼šå³ mLeft + getTranslationX()ï¼Œå³æŽ§ä»¶çš„å·¦è¾¹ç¼˜åŠ ä¸Š X æ–¹å‘å¹³ç§»çš„è·ç¦»ï¼› getY()ï¼šå³ mTop + getTranslationY()ï¼Œå³æŽ§ä»¶çš„ä¸Šè¾¹ç¼˜åŠ ä¸Š Y æ–¹å‘å¹³ç§»çš„è·ç¦»ï¼› ä»¥ä¸Šæ˜¯æˆ‘ä»¬å¯¹ View ä¸­èŽ·å–æŽ§ä»¶ä½ç½®çš„æ–¹æ³•çš„æ¢³ç†ï¼Œä½ å¯ä»¥åˆ°æºç ä¸­æŸ¥çœ‹å®ƒä»¬æ›´åŠ ç›¸è¯¦å°½çš„å®šä¹‰ï¼Œé‚£æ›´æœ‰åŠ©äºŽè‡ªå·±çš„ç†è§£ã€‚ 1.2 MotionEventé€šå¸¸å½“ä½ å¯¹æŽ§ä»¶è¿›è¡Œè§¦æ‘¸ç›‘å¬çš„æ—¶å€™ä¼šç”¨åˆ° MotionEvent ï¼Œå®ƒå°ä½äº†è§¦æ‘¸çš„ä½ç½®ç­‰ä¿¡æ¯ã€‚ä¸‹é¢æˆ‘ä»¬å¯¹ MotionEvent ä¸­çš„èŽ·å–ç‚¹å‡»äº‹ä»¶çš„ä½ç½®çš„æ–¹æ³•è¿›è¡Œæ¢³ç†ï¼Œå®ƒä¸»è¦æ¶‰åŠä¸‹é¢å››ä¸ªæ–¹æ³•ï¼š MotionEvent.getX()ï¼šèŽ·å–ç‚¹å‡»äº‹ä»¶è·ç¦»æŽ§ä»¶å·¦è¾¹ç¼˜çš„è·ç¦»ï¼Œå•ä½ï¼šåƒç´ ï¼› MotionEvent.getY()ï¼šèŽ·å–ç‚¹å‡»äº‹ä»¶è·ç¦»æŽ§ä»¶ä¸Šè¾¹ç¼˜çš„è·ç¦»ï¼Œå•ä½ï¼šåƒç´ ï¼› MotionEvent.getRawX()ï¼šèŽ·å–ç‚¹å‡»äº‹ä»¶è·ç¦»å±å¹•å·¦è¾¹ç¼˜çš„è·ç¦»ï¼Œå•ä½ï¼šåƒç´ ï¼› MotionEvent.getRawY()ï¼šèŽ·å–ç‚¹å‡»äº‹ä»¶è·ç¦»å±å¹•ä¸Šè¾¹ç¼˜çš„è·ç¦»ï¼Œå•ä½ï¼šåƒç´ ã€‚ å¦å¤–æ˜¯è§¦æ‘¸äº‹ä»¶ä¸­çš„ä¸‰ç§å…¸åž‹çš„è¡Œä¸ºï¼ŒæŒ‰ä¸‹ã€ç§»åŠ¨å’ŒæŠ¬èµ·ã€‚æŽ¥ä¸‹æ¥çš„ä»£ç ç¤ºä¾‹ä¸­æˆ‘ä»¬ä¼šç”¨åˆ°å®ƒä»¬æ¥åˆ¤æ–­æ‰‹æŒ‡çš„è¡Œä¸ºï¼Œå¹¶å¯¹å…¶åšå“åº”çš„å¤„ç†ï¼š MotionEvent.ACTION_DOWNï¼šæŒ‰ä¸‹çš„è¡Œä¸ºï¼› MotionEvent.ACTION_MOVEï¼šæ‰‹æŒ‡åœ¨å±å¹•ä¸Šç§»åŠ¨çš„è¡Œä¸ºï¼› MotionEvent.ACTION_UPï¼šæ‰‹æŒ‡æŠ¬èµ·çš„è¡Œä¸ºã€‚ 2ã€æ»‘åŠ¨æˆ‘ä»¬æœ‰å‡ ç§æ–¹å¼å®žçŽ° View çš„æ»‘åŠ¨ï¼š 2.1 layout() æ–¹æ³•è°ƒç”¨æŽ§ä»¶çš„ layout() æ–¹æ³•è¿›è¡Œæ»‘åŠ¨ï¼Œä¸‹é¢æ˜¯è¯¥æ–¹æ³•çš„å®šä¹‰ï¼š 1public void layout(int l, int t, int r, int b) &#123; /*...*/ &#125; å…¶ä¸­çš„å››ä¸ªå‚æ•° l, t, r, båˆ†åˆ«è¡¨ç¤ºæŽ§ä»¶ç›¸å¯¹äºŽçˆ¶æŽ§ä»¶çš„å·¦ã€ä¸Šã€å³ã€ä¸‹çš„è·ç¦»ï¼Œåˆ†åˆ«å¯¹åº”äºŽä¸Šé¢çš„ mLeft, mTop, mRight å’Œ mBottomã€‚æ‰€ä»¥ï¼Œè°ƒç”¨è¯¥æ–¹æ³•åŒæ—¶å¯ä»¥æ”¹å˜æŽ§ä»¶çš„é«˜åº¦å’Œå®½åº¦ï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬ä¸éœ€è¦æ”¹å˜æŽ§ä»¶çš„é«˜åº¦å’Œå®½åº¦ï¼Œåªè¦ç§»åŠ¨å…¶ä½ç½®å³å¯ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åˆæœ‰æ–¹æ³• offsetLeftAndRight() å’Œ offsetTopAndBottom() å¯ä»¥ä½¿ç”¨ï¼ŒåŽè€…åªä¼šå¯¹æŽ§ä»¶çš„ä½ç½®è¿›è¡Œå¹³ç§»ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œå¦‚ä¸‹çš„ä»£ç æµ‹è¯•ï¼š private int lastX, lastY; private void layoutMove(MotionEvent event) { int x = (int) event.getX(), y = (int) event.getY(); switch (event.getAction()) { case MotionEvent.ACTION_DOWN: lastX = x; lastY = y; break; case MotionEvent.ACTION_MOVE: int offsetX = x - lastX, offsetY = y - lastY; getBinding().v.layout(getBinding().v.getLeft() + offsetX, getBinding().v.getTop() + offsetY, getBinding().v.getRight() + offsetX, getBinding().v.getBottom() + offsetY); break; case MotionEvent.ACTION_UP: break; } } ä¸Šé¢çš„ä»£ç çš„æ•ˆæžœæ˜¯æŒ‡å®šçš„æŽ§ä»¶ä¼šéšç€æ‰‹æŒ‡çš„ç§»åŠ¨è€Œç§»åŠ¨ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆè®°å½•ä¸‹æŒ‰ä¸‹çš„ä½ç½®ï¼Œç„¶åŽæ‰‹æŒ‡ç§»åŠ¨çš„æ—¶å€™è®°å½•ä¸‹å¹³ç§»çš„ä½ç½®ï¼Œæœ€åŽè°ƒç”¨ layout() å³å¯ã€‚ 2.2 offsetLeftAndRight() å’Œ offsetTopAndBottom()ä¸Šé¢å·²ç»æåˆ°è¿‡è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå®ƒä»¬åªæ”¹å˜æŽ§ä»¶çš„ä½ç½®ï¼Œæ— æ³•æ”¹å˜å¤§å°ã€‚æˆ‘ä»¬åªéœ€è¦å¯¹ä¸Šè¿°ä»£ç åšå°‘é‡ä¿®æ”¹å°±å¯ä»¥å®žçŽ°åŒæ ·çš„æ•ˆæžœï¼š getBinding().v.offsetLeftAndRight(offsetX); getBinding().v.offsetTopAndBottom(offsetY); 2.3 æ”¹å˜å¸ƒå±€å‚æ•°é€šè¿‡èŽ·å–å¹¶ä¿®æ”¹æŽ§ä»¶çš„ LayoutParamsï¼Œæˆ‘ä»¬ä¸€æ ·å¯ä»¥è¾¾åˆ°ä¿®æ”¹æŽ§ä»¶çš„ä½ç½®çš„ç›®çš„ã€‚æ¯•ç«Ÿï¼Œæœ¬èº«è¿™ä¸ªå¯¹è±¡å°±ä»£è¡¨ç€æŽ§ä»¶çš„å¸ƒå±€ï¼š FrameLayout.LayoutParams lp = (FrameLayout.LayoutParams) getBinding().v.getLayoutParams(); lp.leftMargin = getBinding().v.getLeft() + offsetX; lp.topMargin = getBinding().v.getTop() + offsetY; getBinding().v.setLayoutParams(lp); 2.4 åŠ¨ç”»ä½¿ç”¨åŠ¨ç”»æˆ‘ä»¬ä¹Ÿå¯ä»¥å®žçŽ°æŽ§ä»¶ç§»åŠ¨çš„æ•ˆæžœï¼Œè¿™é‡Œæ‰€è°“çš„åŠ¨ç”»ä¸»è¦æ˜¯æ“ä½œ View çš„ transitionX å’Œ transitionY å±žæ€§ï¼š getBinding().v.animate().translationX(5f); getBinding().v.animate().translationY(5f); å…³äºŽåŠ¨ç”»çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¼šåœ¨åŽé¢è¯¦ç»†ä»‹ç»ã€‚ 2.5 scrollTo() å’Œ scrollBy()scrollBy() æ–¹æ³•å†…éƒ¨è°ƒç”¨äº† scrollTo()ï¼Œä»¥ä¸‹æ˜¯è¿™éƒ¨åˆ†çš„æºç ã€‚scrollBy() è¡¨ç¤ºåœ¨å½“å‰çš„ä½ç½®ä¸Šé¢è¿›è¡Œå¹³ç§»ï¼Œè€Œ scrollTo() è¡¨ç¤ºå¹³ç§»åˆ°æŒ‡å®šçš„ä½ç½®ï¼š public void scrollBy(int x, int y) { scrollTo(mScrollX + x, mScrollY + y); } åŒæ ·å¯¹ä¸Šè¿°ä»£ç è¿›è¡Œä¿®æ”¹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®žçŽ°ä¹‹å‰çš„æ•ˆæžœï¼š ((View) getBinding().v.getParent()).scrollBy(-offsetX, -offsetY); æˆ–è€… View parent = ((View) getBinding().v.getParent()); parent.scrollTo(parent.getScrollX()-offsetX, parent.getScrollY()-offsetY); æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼šä¸Žä¸Šé¢çš„ offsetLeftAndRight() å’Œ offsetTopAndBottom() ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨äº†å¹³ç§»çš„å€¼çš„ç›¸åæ•°ã€‚åŽŸå› å¾ˆç®€å•ï¼Œå› ä¸ºæˆ‘ä»¬è¦ä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™éœ€è¦å¯¹æŒ‡å®šçš„æŽ§ä»¶æ‰€åœ¨çš„çˆ¶å®¹å™¨è¿›è¡Œè°ƒç”¨ï¼ˆæ­£å¦‚ä¸Šé¢æ˜¯å…ˆèŽ·å–çˆ¶æŽ§ä»¶ï¼‰ã€‚å½“æˆ‘ä»¬å¸Œæœ›æŽ§ä»¶ç›¸å¯¹äºŽä¹‹å‰çš„ä½ç½®å‘å³ä¸‹æ–¹å‘ç§»åŠ¨ï¼Œå°±åº”è¯¥è®©çˆ¶å®¹å™¨ç›¸å¯¹äºŽä¹‹å‰çš„ä½ç½®å‘å·¦ä¸Šæ–¹å‘ç§»åŠ¨ã€‚å› ä¸ºå®žé™…ä¸Šè¯¥æŽ§ä»¶ç›¸å¯¹äºŽçˆ¶æŽ§ä»¶çš„ä½ç½®æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå˜åŒ–çš„æ˜¯çˆ¶æŽ§ä»¶çš„ä½ç½®ã€‚ï¼ˆå‚è€ƒçš„åæ ‡ç³»ä¸åŒï¼‰ 2.6 Scrollerä¸Šé¢ï¼Œæˆ‘ä»¬çš„æµ‹è¯•ä»£ç æ˜¯è®©æŒ‡å®šçš„æŽ§ä»¶éšç€æ‰‹æŒ‡ç§»åŠ¨ï¼Œä½†æ˜¯å‡å¦‚æˆ‘ä»¬å¸Œæœ›æŽ§ä»¶ä»Žä¸€ä¸ªä½ç½®ç§»åŠ¨åˆ°å¦ä¸€ä¸ªä½ç½®å‘¢ï¼Ÿå½“ç„¶ï¼Œå®ƒä»¬ä¹Ÿå¯ä»¥å®žçŽ°ï¼Œä½†æ˜¯è¿™å‡ ä¹Žå°±æ˜¯åœ¨çž¬é—´å®Œæˆäº†æ•´ä¸ªæ“ä½œï¼Œå®žé™…çš„UIæ•ˆæžœè‚¯å®šä¸ä¼šå¥½ã€‚æ‰€ä»¥ï¼Œä¸ºäº†è®©æ»‘åŠ¨çš„è¿‡ç¨‹çœ‹èµ·æ¥æ›´åŠ æµç•…ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© Scroller æ¥å®žçŽ°ã€‚ åœ¨ä½¿ç”¨ Scroller ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå®žä¾‹åŒ–ä¸€ä¸ª Scroller ï¼š private Scroller scroller = new Scroller(getContext()); ç„¶åŽï¼Œæˆ‘ä»¬éœ€è¦è¦†å†™è‡ªå®šä¹‰æŽ§ä»¶çš„ computeScroll() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåœ¨ç»˜åˆ¶ View çš„æ—¶å€™è¢«è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œçš„å«ä¹‰å°±æ˜¯ï¼Œå½“ View é‡ç»˜çš„æ—¶å€™ä¼šè°ƒç”¨ computeScroll() æ–¹æ³•ï¼Œè€Œ computeScroll() æ–¹æ³•ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­æ»šåŠ¨ï¼Œå¦‚æžœéœ€è¦ç»§ç»­æ»šåŠ¨çš„æ—¶å€™å°±è°ƒç”¨ invalidate() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå¯¼è‡´ View è¿›ä¸€æ­¥é‡ç»˜ã€‚æ‰€ä»¥ï¼Œä¹Ÿå°±æ˜¯é ç€è¿™ç§ä¸æ–­è¿›è¡Œé‡ç»˜çš„æ–¹å¼å®žçŽ°äº†æ»šåŠ¨çš„æ•ˆæžœã€‚ æ»‘åŠ¨æ•ˆæžœæœ€ç»ˆç»“æŸçš„åˆ¤æ–­æ˜¯é€šè¿‡ Scroller çš„ computeScrollOffset() æ–¹æ³•å®žçŽ°çš„ï¼Œå½“æ»šåŠ¨åœæ­¢çš„æ—¶å€™ï¼Œè¯¥æ–¹æ³•å°±ä¼šè¿”å›ž falseï¼Œè¿™æ ·ä¸ä¼šç»§ç»­è°ƒç”¨ invalidate() æ–¹æ³•ï¼Œå› è€Œä¹Ÿå°±ä¸ä¼šç»§ç»­ç»˜åˆ¶äº†ã€‚ä¸‹é¢æ˜¯è¯¥æ–¹æ³•å…¸åž‹çš„è¦†å†™æ–¹å¼ï¼š @Override public void computeScroll() { super.computeScroll(); if (scroller.computeScrollOffset()) { ((View) getParent()).scrollTo(scroller.getCurrX(), scroller.getCurrY()); invalidate(); } } ç„¶åŽï¼Œæˆ‘ä»¬å†åŠ å…¥ä¸€ä¸ªæ»šåŠ¨åˆ°æŒ‡å®šä½ç½®çš„æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•å†…éƒ¨æˆ‘ä»¬ä½¿ç”¨äº† 2000ms æ¥æŒ‡å®šå®Œæˆæ•´ä¸ªæ»‘åŠ¨æ‰€éœ€è¦çš„æ—¶é—´ï¼š public void smoothScrollTo(int descX, int descY) { scroller.startScroll(getScrollX(), getScrollY(), descX - getScrollX(), descY - getScrollY(), 2000); invalidate(); } è¿™æ ·å®šä¹‰äº†ä¹‹åŽï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨éœ€è¦æ»šåŠ¨çš„æ—¶å€™è°ƒç”¨è‡ªå®šä¹‰ View çš„ smoothScrollTo() æ–¹æ³•å³å¯ã€‚ 3ã€æ‰‹åŠ¿3.1 ViewConfigurationåœ¨ç±» ViewConfiguration ä¸­å®šä¹‰äº†ä¸€äº›åˆ—çš„å¸¸é‡ç”¨æ¥æ ‡å¿—æŒ‡å®šçš„è¡Œä¸ºï¼Œæ¯”å¦‚ï¼ŒTouchSlop å°±æ˜¯æ»‘åŠ¨çš„æœ€å°çš„è·ç¦»ã€‚ä½ å¯ä»¥é€šè¿‡ ViewConfiguration.get(context) æ¥èŽ·å– ViewConfiguration å®žä¾‹ï¼Œç„¶åŽé€šè¿‡å®ƒçš„ getter æ–¹æ³•æ¥èŽ·å–è¿™äº›å¸¸é‡çš„å®šä¹‰ã€‚ 3.2 VelocityTrackerVelocityTracker ç”¨æ¥æ£€æµ‹æ‰‹æŒ‡æ»‘åŠ¨çš„é€ŸçŽ‡ï¼Œå®ƒçš„ä½¿ç”¨éžå¸¸ç®€å•ã€‚åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨å®ƒçš„é™æ€æ–¹æ³• obtain() èŽ·å–ä¸€ä¸ªå®žä¾‹ï¼Œç„¶åŽåœ¨ onTouch() æ–¹æ³•ä¸­è°ƒç”¨å®ƒçš„ addMovement(MotionEvent) æ–¹æ³•ï¼š velocityTracker = VelocityTracker.obtain(); éšåŽï¼Œå½“æˆ‘ä»¬æƒ³è¦èŽ·å¾—é€ŸçŽ‡çš„æ—¶å€™ï¼Œå…ˆè°ƒç”¨ computeCurrentVelocity(int) ä¼ å…¥ä¸€ä¸ªæ—¶é—´ç‰‡æ®µï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œç„¶åŽè°ƒç”¨ getXVelocity() å’Œ getYVelocity() åˆ†åˆ«èŽ·å¾—åœ¨æ°´å¹³å’Œç«–ç›´æ–¹å‘ä¸Šçš„é€ŸçŽ‡å³å¯ï¼š velocityTracker.computeCurrentVelocity((int) duration); getBinding().tvVelocity.setText(&quot;X:&quot; + velocityTracker.getXVelocity() + &quot;\n&quot; + &quot;Y:&quot; + velocityTracker.getYVelocity()); æœ¬è´¨ä¸Šï¼Œè®¡ç®—é€ŸçŽ‡çš„æ—¶å€™æ˜¯ç”¨æŒ‡å®šæ—¶é—´çš„é•¿åº¦å˜åŒ–é™¤ä»¥æˆ‘ä»¬ä¼ å…¥çš„æ—¶é—´ç‰‡ã€‚å½“æˆ‘ä»¬ä½¿ç”¨å®Œäº† VelocityTracker ä¹‹åŽï¼Œéœ€è¦å›žæ”¶èµ„æºï¼š velocityTracker.clear(); velocityTracker.recycle(); 3.3 GestureDectectorGestureDectector ç”¨æ¥æ£€æµ‹æ‰‹æŒ‡çš„æ‰‹åŠ¿ã€‚åœ¨ä½¿ç”¨å®ƒä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆèŽ·å–ä¸€ä¸ª GestureDetector çš„å®žä¾‹ï¼š mGestureDetector = new GestureDetector(getContext(), new MyOnGestureListener()); è¿™é‡Œæˆ‘ä»¬ç”¨äº† GestureDetector çš„æž„é€ æ–¹æ³•ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ª OnGestureListener å¯¹è±¡ã€‚è¿™é‡Œæˆ‘ä»¬ç”¨äº† MyOnGestureListener å®žä¾‹ã€‚ MyOnGestureListener æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ç±»ï¼Œå®žçŽ°äº† OnGestureListener æŽ¥å£ï¼š private class MyOnGestureListener extends GestureDetector.SimpleOnGestureListener { @Override public boolean onSingleTapUp(MotionEvent e) { ToastUtils.makeToast(&quot;Click detected&quot;); return false; } @Override public void onLongPress(MotionEvent e) { LogUtils.d(&quot;Long press detected&quot;); } @Override public boolean onDoubleTap(MotionEvent e) { LogUtils.d(&quot;Double tab detected&quot;); return true; } @Override public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY) { LogUtils.d(&quot;Fling detected&quot;); return true; } } åœ¨ MyOnGestureListener ä¸­ï¼Œæˆ‘ä»¬è¦†å†™äº†å®ƒçš„ä¸€äº›æ–¹æ³•ã€‚æ¯”å¦‚ï¼Œå•å‡»ã€åŒå‡»å’Œé•¿æŒ‰ç­‰ç­‰ï¼Œå½“æ£€æµ‹åˆ°ç›¸åº”çš„æ‰‹åŠ¿çš„æ—¶å€™è¿™äº›æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ã€‚ ç„¶åŽï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ä½¿ç”¨ GestureDetectorï¼Œåªè¦åœ¨æŽ§ä»¶çš„è§¦æ‘¸äº‹ä»¶å›žè°ƒä¸­è°ƒç”¨å³å¯ï¼š getBinding().vg.setOnTouchListener((v, event) -&gt; { mGestureDetector.onTouchEvent(event); return true; }); 4ã€äº‹ä»¶åˆ†å‘æœºåˆ¶4.1 äº‹ä»¶ä¼ é€’çš„è¿‡ç¨‹å½“è®¨è®ºäº‹ä»¶åˆ†å‘æœºåˆ¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬é¦–å…ˆè¦äº†è§£ Android ä¸­ View çš„ç»„æˆç»“æž„ã€‚åœ¨ Android ä¸­ï¼Œä¸€ä¸ª Activity åŒ…å«ä¸€ä¸ª PhoneWindowï¼Œå½“æˆ‘ä»¬åœ¨ Activity ä¸­è°ƒç”¨ setContentView() æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨è¯¥ PhoneWindow çš„ setContentView() æ–¹æ³•ï¼Œå¹¶åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ç”Ÿæˆä¸€ä¸ª DecorView ä½œä¸º Activity çš„è·Ÿ Viewã€‚ æ ¹æ®ä¸Šé¢çš„åˆ†æžï¼Œå½“ä¸€ä¸ªç‚¹å‡»äº‹ä»¶è¢«è§¦å‘çš„æ—¶å€™ï¼Œé¦–å…ˆæŽ¥æ”¶åˆ°è¯¥äº‹ä»¶çš„æ˜¯ Activityã€‚å› ä¸ºï¼ŒActivity è¦†ç›–äº†æ•´ä¸ªå±å¹•ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè®©å®ƒæŽ¥æ”¶äº‹ä»¶ï¼Œç„¶åŽå®ƒæŠŠäº‹ä»¶ä¼ é€’ç»™æ ¹ View ä¹‹åŽï¼Œå†ç”±æ ¹ View å‘ä¸‹ç»§ç»­ä¼ é€’ã€‚è¿™æ ·ä¸æ–­ç¼©å°æœç´¢çš„èŒƒå›´ï¼Œç›´åˆ°æœ€é¡¶å±‚çš„ Viewã€‚å½“ç„¶ï¼Œä»»ä½•çš„çˆ¶å®¹å™¨éƒ½å¯ä»¥å†³å®šè¿™ä¸ªäº‹ä»¶æ˜¯ä¸æ˜¯è¦ç»§ç»­å‘ä¸‹ä¼ é€’ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¤§è‡´å¾—åˆ°ä¸‹é¢è¿™ä¸ªäº‹ä»¶ä¼ é€’çš„å›¾ï¼š å·¦è¾¹çš„å›¾æ˜¯ä¸€ä¸ª Activity å†…éƒ¨çš„ View å’Œ Window çš„ç»„ç»‡ç»“æž„ã€‚å³é¢çš„å›¾å¯ä»¥çœ‹ä½œå®ƒçš„åˆ‡é¢å›¾ï¼Œå…¶ä¸­çš„é»‘è‰²ç®­å¤´è¡¨ç¤ºäº‹ä»¶çš„ä¼ é€’è¿‡ç¨‹ã€‚è¿™é‡Œäº‹ä»¶ä¼ é€’çš„è¿‡ç¨‹æ˜¯å…ˆä»Žä¸‹åˆ°ä¸Šï¼Œç„¶åŽå†ä»Žä¸Šåˆ°ä¸‹ã€‚ä¹Ÿå°±æ˜¯ä»Žå¤§åˆ°å°ï¼Œä¸æ–­å®šä½åˆ°è§¦æ‘¸çš„æŽ§ä»¶ï¼Œå…¶ä¸­æ¯ä¸ªçˆ¶å®¹å™¨å¯ä»¥å†³å®šæ˜¯å¦å°†äº‹ä»¶ä¼ é€’ä¸‹åŽ»ã€‚ï¼ˆéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œå¦‚æžœä¸€ä¸ªçˆ¶å®¹å™¨æœ‰å¤šä¸ªå­å…ƒç´ çš„è¯ï¼Œé‚£ä¹ˆåœ¨è¿™äº›å­å…ƒç´ ä¸­è¿›è¡ŒéåŽ†çš„æ—¶å€™ï¼Œé¡ºåºæ˜¯ä»Žä¸Šå¾€ä¸‹çš„ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§å±•ç¤ºçš„é¡ºåºï¼‰ã€‚ ä¸Šé¢æˆ‘ä»¬åˆ†æžäº† Android äº‹ä»¶ä¼ é€’çš„è¿‡ç¨‹ï¼Œç›¸ä¿¡ä½ æœ‰äº†ä¸€ä¸ªå¤§è‡´çš„äº†è§£ã€‚ä½†æ˜¯ï¼Œæƒ³è¦äº†è§£æ•´ä¸ªäº‹ä»¶ä¼ é€’è¿‡ç¨‹å…·ä½“æ¶‰åŠäº†å“ªäº›æ–¹æ³•ã€å¦‚ä½•ä½œç”¨ç­‰ï¼Œè¿˜éœ€è¦æˆ‘ä»¬å¯¹æºç è¿›è¡Œåˆ†æžã€‚ 4.2 äº‹ä»¶ä¼ é€’çš„åŽŸç†å½“è§¦æ‘¸äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œé¦–å…ˆä¼šè¢« Activity æŽ¥æ”¶åˆ°ï¼Œç„¶åŽè¯¥ Activity ä¼šé€šè¿‡å…¶å†…éƒ¨çš„ dispatchTouchEvent(MotionEvent) å°†äº‹ä»¶ä¼ é€’ç»™å†…éƒ¨çš„ PhoneWindowï¼›æŽ¥ç€ PhoneWindow ä¼šæŠŠäº‹ä»¶äº¤ç»™ DecorViewï¼Œå†ç”± DecorView äº¤ç»™æ ¹ ViewGroupã€‚å‰©ä¸‹çš„äº‹ä»¶ä¼ é€’å°±åªåœ¨ ViewGroup å’Œ View ä¹‹é—´è¿›è¡Œã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¦†å†™ Activity çš„ dispatchTouchEvent(MotionEvent) æ¥é˜»æ­¢æŠŠäº‹ä»¶ä¼ é€’ç»™ PhoneWindowã€‚å®žé™…ä¸Šï¼Œåœ¨æˆ‘ä»¬å¼€å‘çš„æ—¶å€™ä¸ä¼šå¯¹ Window çš„äº‹ä»¶ä¼ é€’æ–¹æ³•è¿›è¡Œé‡å†™ï¼Œä¸€èˆ¬æ˜¯å¯¹ ViewGroup æˆ–è€… Viewã€‚æ‰€ä»¥ï¼Œä¸‹é¢æˆ‘ä»¬çš„åˆ†æžåªåœ¨è¿™ä¸¤ç§æŽ§ä»¶ä¹‹é—´è¿›è¡Œã€‚ å½“è®¨è®º View çš„äº‹ä»¶åˆ†å‘æœºåˆ¶çš„æ—¶å€™ï¼Œæ— å¤–ä¹Žä¸‹é¢ä¸‰ä¸ªæ–¹æ³•ï¼š boolean onInterceptTouchEvent(MotionEvent ev)ï¼šç”¨æ¥å¯¹äº‹ä»¶è¿›è¡Œæ‹¦æˆªï¼Œè¯¥æ–¹æ³•åªå­˜åœ¨äºŽ ViewGroup ä¸­ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¼šé€šè¿‡è¦†å†™è¯¥æ–¹æ³•æ¥æ‹¦æˆªè§¦æ‘¸äº‹ä»¶ï¼Œä½¿å…¶ä¸å†ç»§ç»­ä¼ é€’ç»™å­ Viewã€‚ boolean dispatchTouchEvent(MotionEvent event)ï¼šç”¨æ¥åˆ†å‘è§¦æ‘¸äº‹ä»¶ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¸è¦†å†™è¯¥æ–¹æ³•ï¼Œè¿”å›ž true åˆ™è¡¨ç¤ºäº‹ä»¶è¢«å¤„ç†äº†ã€‚åœ¨ View ä¸­ï¼Œå®ƒè´Ÿè´£æ ¹æ®æ‰‹åŠ¿çš„ç±»åž‹å’ŒæŽ§ä»¶çš„çŠ¶æ€å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œä¼šå›žè°ƒæˆ‘ä»¬çš„ OnTouchListener æˆ–è€… OnClickListenerï¼›åœ¨ ViewGroup ä¸­ï¼Œè¯¥æ–¹æ³•è¢«è¦†å†™ï¼Œå®ƒçš„è´£ä»»æ˜¯å¯¹äº‹ä»¶è¿›è¡Œåˆ†å‘ï¼Œä¼šå¯¹æ‰€æœ‰çš„å­ View è¿›è¡ŒéåŽ†ï¼Œå†³å®šæ˜¯å¦å°†äº‹ä»¶åˆ†å‘ç»™æŒ‡å®šçš„ Viewã€‚ boolean onTouchEvent(MotionEvent event)ï¼šç”¨äºŽå¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œè¿”å›ž true è¡¨ç¤ºè§¦æ‘¸äº‹ä»¶è¢«å¤„ç†äº†ã€‚ViewGroup æ²¡æœ‰è¦†å†™è¯¥æ–¹æ³•ï¼Œæ•…åœ¨ ViewGroup ä¸­ä¸Ž View ä¸­çš„åŠŸèƒ½æ˜¯ä¸€æ ·çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æžœæˆ‘ä»¬ä¸ºæŽ§ä»¶è®¾ç½®äº† OnTouchListener å¹¶ä¸”åœ¨æˆ–è€…ä¸­è¿”å›žäº† trueï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¸ä¼šè¢«è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯ OnTouchListener æ¯”è¯¥æ–¹æ³•çš„ä¼˜å…ˆçº§è¾ƒé«˜ã€‚å¯¹æˆ‘ä»¬å¼€å‘æ¥è¯´ï¼Œå°±æ˜¯ OnTouchListener æ¯” OnClickListener å’Œ OnLongClickListener çš„ä¼˜å…ˆçº§è¦é«˜ã€‚ äºŽæ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ä¼ªä»£ç ã€‚è¿™æ®µä»£ç æ˜¯å­˜åœ¨äºŽ ViewGroup ä¸­çš„ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶åˆ†å‘æœºåˆ¶çš„æ ¸å¿ƒä»£ç ï¼š boolean dispatchTouchEvent(MotionEvent e) { boolean result; if (onInterceptTouchEvent(e)) { result = super.dispatchTouchEvent(e); } else { result = child.dispatchTouchEvent(e); } return result; } æŒ‰ç…§ä¸Šè¿°åˆ†æžï¼Œè§¦æ‘¸äº‹ä»¶ç»è¿‡ Activity ä¼ é€’ç»™æ ¹ ViewGroup ä¹‹åŽï¼š å¦‚æžœ ViewGourp è¦†å†™äº† onInterceptTouchEvent() å¹¶ä¸”è¿”å›žäº† true å°±è¡¨ç¤ºå¸Œæœ›æ‹¦æˆªè¯¥æ–¹æ³•ï¼ŒäºŽæ˜¯å°±æŠŠè§¦æ‘¸äº‹ä»¶äº¤ç»™å½“å‰ ViewGroup è¿›è¡Œå¤„ç†ï¼ˆè§¦å‘ OnTouchListener æˆ–è€… OnClickListener ç­‰ï¼‰ï¼›å¦åˆ™ï¼Œä¼šäº¤ç»™å­å…ƒç´ çš„ç»§ç»­åˆ†å‘ã€‚å¦‚æžœè¯¥å­å…ƒç´ æ˜¯ ViewGroup çš„è¯ï¼Œå°±ä¼šåœ¨è¯¥å­ View ä¸­æ‰§è¡Œä¸€éä¸Šè¿°é€»è¾‘ï¼Œå¦åˆ™ä¼šåœ¨å½“å‰çš„å­å…ƒç´ ä¸­å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆè§¦å‘ OnTouchListener æˆ–è€… OnClickListener ç­‰ï¼‰â€¦â€¦å°±è¿™æ ·ä¸€å±‚å±‚åœ°éåŽ†ä¸‹åŽ»ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ·±åº¦ä¼˜å…ˆçš„æœç´¢ç®—æ³•ã€‚ è¿™é‡Œæˆ‘ä»¬å¯¹æ•´ä¸ªäº‹ä»¶åˆ†å‘æœºåˆ¶çš„æ•´ä½“åšäº†ä¸€ä¸ªç´ æï¼Œåœ¨æŽ¥ä¸‹æ¥çš„æ–‡ç« ä¸­æˆ‘ä»¬ä¼šå¯¹å„ä¸ªæ–¹æ³•çš„ç»†èŠ‚è¿›è¡Œæºç åˆ†æžï¼Œä¸ºäº†é˜²æ­¢æ‚¨åœ¨æŽ¥ä¸‹æ¥çš„è¡Œæ–‡ä¸­è¿·è·¯ï¼Œæˆ‘ä»¬å…ˆæŠŠè¿™ä¸ªæ•´ä½“é€»è¾‘æŒ‰ä¸‹å›¾è¿›è¡Œæè¿°ï¼š 4.3 äº‹ä»¶ä¼ é€’çš„æºç åˆ†æžä¸Šè¿°æˆ‘ä»¬åˆ†æžäº†äº‹ä»¶åˆ†å‘æœºåˆ¶çš„åŽŸç†ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡æºä»£ç æ¥æ›´å…·ä½“åœ°äº†è§£è¿™å—æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚åŒæ ·ï¼Œæˆ‘ä»¬çš„ç„¦ç‚¹ä¹Ÿåªåœ¨é‚£ä¸‰ä¸ªéœ€è¦é‡ç‚¹å…³æ³¨çš„æ–¹æ³•ã€‚ 4.3.1 å†³å®šæ˜¯å¦æ‹¦æˆªäº‹ä»¶é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ ViewGroup ä¸­çš„ dispatchTouchEvent(MotionEvent) æ–¹æ³•ï¼Œæˆ‘ä»¬èŠ‚é€‰äº†å…¶ä¸€éƒ¨åˆ†ï¼š @Override public boolean dispatchTouchEvent(MotionEvent ev) { // ... boolean handled = false; if (onFilterTouchEventForSecurity(ev)) { final int action = ev.getAction(); final int actionMasked = action &amp; MotionEvent.ACTION_MASK; if (actionMasked == MotionEvent.ACTION_DOWN) { // 1 // è¿™é‡Œè¡¨ç¤ºå¦‚æžœæ˜¯ä¸€ä¸ªæ–°çš„è§¦æ‘¸äº‹ä»¶å°±è¦é‡ç½®æ‰€æœ‰çš„çŠ¶æ€ï¼Œå…¶ä¸­åŒ…æ‹¬å°† mFirstTouchTarget ç½®ä¸º null cancelAndClearTouchTargets(ev); resetTouchState(); } // åœ¨è¿™é‡Œæ£€æŸ¥æ˜¯å¦æ‹¦æˆªäº†äº‹ä»¶ï¼ŒmFirstTouchTarget æ˜¯ä¹‹å‰å¤„ç†è§¦æ‘¸äº‹ä»¶çš„ View çš„å°è£… final boolean intercepted; if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { // è¿™é‡Œåˆ¤æ–­è¯¥ ViewGroup æ˜¯å¦ç¦ç”¨äº†æ‹¦æˆªï¼Œç”± requestDisallowInterceptTouchEvent è®¾ç½® final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { intercepted = onInterceptTouchEvent(ev); ev.setAction(action); } else { intercepted = false; } } else { // éžæŒ‰ä¸‹äº‹ä»¶å¹¶ä¸” mFirstTouchTarget ä¸º nullï¼Œè¯´æ˜Žåˆ¤æ–­è¿‡æ‹¦æˆªçš„é€»è¾‘å¹¶ä¸”å¯ç”¨äº†æ‹¦æˆª intercepted = true; } // ... } // ... return handled; } ä¸Šé¢ä»£ç æ˜¯æˆ‘ä»¬èŠ‚é€‰çš„ ViewGroup æ‹¦æˆªäº‹ä»¶çš„éƒ¨åˆ†ä»£ç ï¼Œè¿™é‡Œçš„é€»è¾‘æ˜¾ç„¶æ¯”ä¼ªä»£ç å¤æ‚çš„å¤šã€‚ä¸è¿‡ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œè¿™äº›ä»£ç ç¡®å®žå¿…ä¸å¯å°‘çš„ã€‚å› ä¸ºï¼Œå½“æˆ‘ä»¬è¦åŽ»åˆ¤æ–­æ˜¯å¦æ‹¦æˆªä¸€ä¸ªè§¦æ‘¸äº‹ä»¶çš„æ—¶å€™ï¼Œæ­¤æ—¶è§¦æ‘¸çš„äº‹ä»¶ä»ç„¶åœ¨ç»§ç»­ï¼Œè¿™æ„å‘³ç€è¿™ä¸ªæ–¹æ³•ä¼šè¢«æŒç»­è°ƒç”¨ï¼›æŠ¬èµ·çš„æ—¶å€™å†æŒ‰ä¸‹ï¼Œåˆæ˜¯å¦ä¸€æ¬¡è°ƒç”¨ã€‚è€ƒè™‘åˆ°è¿™ä¸ªè¿žç»­æ€§ï¼Œæˆ‘ä»¬éœ€è¦å¤šåšä¸€äº›é€»è¾‘ã€‚ è¿™é‡Œæˆ‘ä»¬é¦–å…ˆåœ¨ 1 å¤„é€šè¿‡è¡Œä¸ºæ˜¯å¦æ˜¯â€œæŒ‰ä¸‹â€çš„æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€æ¬¡æ–°çš„è§¦æ‘¸äº‹ä»¶ï¼Œå¦‚æžœæ˜¯çš„è¯æˆ‘ä»¬éœ€è¦é‡ç½®å½“å‰çš„è§¦æ‘¸çŠ¶æ€ã€‚å…¶æ¬¡ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®äº‹ä»¶çš„ç±»åž‹æ¥å†³å®šæ˜¯å¦åº”è¯¥è°ƒç”¨ onInterceptTouchEvent()ï¼Œå› ä¸ºå¯¹ä¸€æ¬¡è§¦æ‘¸äº‹ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨â€œæŒ‰ä¸‹â€çš„æ—¶å€™åˆ¤æ–­ä¸€æ¬¡å°±å¤Ÿäº†ã€‚æ‰€ä»¥ï¼Œæ˜¾ç„¶æˆ‘ä»¬éœ€è¦å°† MotionEvent.ACTION_DOWN ä½œä¸ºä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ã€‚ç„¶åŽï¼Œæˆ‘ä»¬ä½¿ç”¨ mFirstTouchTarget è¿™ä¸ªå…¨å±€çš„å˜é‡æ¥è®°å½•ä¸Šæ¬¡æ‹¦æˆªçš„ç»“æžœâ€”â€”å¦‚æžœä¹‹å‰çš„äº‹ä»¶äº¤ç»™è¿‡å­å…ƒç´ å¤„ç†ï¼Œé‚£ä¹ˆå®ƒå°±ä¸ä¸ºç©ºã€‚ é™¤äº† mFirstTouchTargetï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç”¨ mGroupFlags çš„ FLAG_DISALLOW_INTERCEPT æ ‡å¿—ä½æ¥åˆ¤æ–­è¯¥ ViewGroup æ˜¯å¦ç¦ç”¨äº†æ‹¦æˆªã€‚è¿™ä¸ªæ ‡å¿—ä½å¯ä»¥é€šè¿‡ ViewGroup çš„ requestDisallowInterceptTouchEvent(boolean) æ¥è®¾ç½®ã€‚åªæœ‰æ²¡æœ‰ç¦ç”¨æ‹¦æˆªäº‹ä»¶çš„æ—¶å€™æˆ‘ä»¬æ‰éœ€è¦è°ƒç”¨ onInterceptTouchEvent() åˆ¤æ–­æ˜¯å¦å¼€å¯äº†æ‹¦æˆªã€‚ 4.3.2 åˆ†å‘äº‹ä»¶ç»™å­å…ƒç´ å¦‚æžœåœ¨ä¸Šé¢çš„æ“ä½œä¸­äº‹ä»¶æ²¡æœ‰è¢«æ‹¦æˆªå¹¶ä¸”æ²¡æœ‰è¢«å–æ¶ˆï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥ä¸‹é¢çš„é€»è¾‘ã€‚è¿™éƒ¨åˆ†ä»£ç å¤„åœ¨ dispatchTouchEvent() ä¸­ã€‚åœ¨ä¸‹é¢çš„é€»è¾‘ä¸­ä¼šæ ¹æ®å­å…ƒç´ çš„çŠ¶æ€å°†äº‹ä»¶ä¼ é€’ç»™å­å…ƒç´ ï¼š // å¯¹å­å…ƒç´ è¿›è¡Œå€’åºéåŽ†ï¼Œå³ä»Žä¸Šåˆ°ä¸‹è¿›è¡ŒéåŽ† final View[] children = mChildren; for (int i = childrenCount - 1; i &gt;= 0; i--) { final int childIndex = getAndVerifyPreorderedIndex(childrenCount, i, customOrder); final View child = getAndVerifyPreorderedView(preorderedList, children, childIndex); // ... // åˆ¤æ–­å­å…ƒç´ æ˜¯å¦èƒ½æŽ¥æ”¶è§¦æ‘¸äº‹ä»¶ï¼šèƒ½æŽ¥æ”¶äº‹ä»¶å¹¶ä¸”ä¸æ˜¯æ­£åœ¨è¿›è¡ŒåŠ¨ç”»çš„çŠ¶æ€ if (!canViewReceivePointerEvents(child) || !isTransformedTouchPointInView(x, y, child, null)) { ev.setTargetAccessibilityFocus(false); continue; } // ... // åœ¨è¿™é‡Œè°ƒç”¨äº† dispatchTransformedTouchEvent() æ–¹æ³•å°†äº‹ä»¶ä¼ é€’ç»™å­å…ƒç´  if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) { // ... è®°å½•ä¸€äº›çŠ¶æ€ä¿¡æ¯ // åœ¨è¿™é‡Œå®Œæˆå¯¹ mFirstTouchTarget çš„èµ‹å€¼ï¼Œè¡¨ç¤ºè§¦æ‘¸äº‹ä»¶è¢«å­å…ƒç´ å¤„ç† newTouchTarget = addTouchTarget(child, idBitsToAssign); alreadyDispatchedToNewTouchTarget = true; // ç»“æŸå¾ªçŽ¯ï¼Œå®Œæˆå­å…ƒç´ çš„éåŽ† break; } // æ˜¾ç„¶ï¼Œå¦‚æžœåˆ°äº†è¿™ä¸€æ­¥ï¼Œé‚£ä¹ˆå­å…ƒç´ çš„éåŽ†ä»å°†ç»§ç»­ } å½“åˆ¤æ–­äº†æŒ‡å®šçš„ View å¯ä»¥æŽ¥æ”¶è§¦æ‘¸äº‹ä»¶ä¹‹åŽä¼šè°ƒç”¨ dispatchTransformedTouchEvent() æ–¹æ³•åˆ†å‘äº‹ä»¶ã€‚å…¶å®šä¹‰çš„èŠ‚é€‰å¦‚ä¸‹ï¼š private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel, View child, int desiredPointerIdBits) { final boolean handled; // ... if (child == null) { // æœ¬è´¨ä¸Šé€»è¾‘ä¸Ž View çš„ dispatchTouchEvent() ä¸€è‡´ handled = super.dispatchTouchEvent(transformedEvent); } else { // ... // äº¤ç»™å­å…ƒç´ ç»§ç»­åˆ†å‘äº‹ä»¶ handled = child.dispatchTouchEvent(transformedEvent); } return handled; } dispatchTransformedTouchEvent() ä¼šæ ¹æ®ä¼ å…¥çš„ child æ˜¯å¦ä¸º null åˆ†æˆä¸¤ç§è°ƒç”¨çš„æƒ…å½¢ï¼šäº‹ä»¶æ²¡æœ‰è¢«æ‹¦æˆªçš„æ—¶å€™ï¼Œè®©å­å…ƒç´ ç»§ç»­åˆ†å‘äº‹ä»¶ï¼›å¦ä¸€ç§æ˜¯å½“äº‹ä»¶è¢«æ‹¦æˆªçš„æ—¶å€™ï¼Œè°ƒç”¨å½“å‰çš„ ViewGroup çš„ super.dispatchTouchEvent(transformedEvent) å¤„ç†äº‹ä»¶ã€‚ 4.3.3 View ä¸­çš„ dispatchTouchEventä¸Šé¢æˆ‘ä»¬åˆ†æžçš„ dispatchTouchEvent(MotionEvent) æ˜¯ ViewGroup ä¸­é‡å†™ä¹‹åŽçš„æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œæ­£å¦‚æˆ‘ä»¬ä¸Šé¢çš„åˆ†æžï¼Œé‡å†™ä¹‹å‰çš„æ–¹æ³•æ€»æ˜¯ä¼šè¢«è°ƒç”¨ï¼Œåªæ˜¯å¯¹è±¡ä¸åŒã€‚è¿™é‡Œæˆ‘ä»¬å°±æ¥åˆ†æžä»¥ä¸‹è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨ã€‚ public boolean dispatchTouchEvent(MotionEvent event) { // ... boolean result = false; // .... if (onFilterTouchEventForSecurity(event)) { if ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) { result = true; } // è¿™é‡Œå›žè°ƒäº† setOnTouchListener() æ–¹æ³•ä¼ å…¥çš„ OnTouchListener ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnTouchListener != null &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; li.mOnTouchListener.onTouch(this, event)) { result = true; } // å¦‚æžœ OnTouchListener æ²¡æœ‰è¢«å›žè°ƒè¿‡æˆ–è€…è¿”å›žäº† falseï¼Œå°±ä¼šè°ƒç”¨ onTouchEvent() è¿›è¡Œå¤„ç† if (!result &amp;&amp; onTouchEvent(event)) { result = true; } } // ... return result; } æ ¹æ®ä¸Šé¢çš„æºç åˆ†æžï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æžœå½“å‰çš„ View è®¾ç½®è¿‡ OnTouchListener, å¹¶ä¸”åœ¨ onTouch() å›žè°ƒæ–¹æ³•ä¸­è¿”å›žäº† trueï¼Œé‚£ä¹ˆ onTouchEvent(MotionEvent) å°†ä¸ä¼šå¾—åˆ°è°ƒç”¨ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ onTouchEvent() æ–¹æ³•ï¼š public boolean onTouchEvent(MotionEvent event) { // ... // åˆ¤æ–­å½“å‰æŽ§ä»¶æ˜¯å¦æ˜¯å¯ä»¥ç‚¹å‡»çš„ï¼šå®žçŽ°äº†ç‚¹å‡»ã€é•¿æŒ‰æˆ–è€…è®¾ç½®äº†å¯ç‚¹å‡»å±žæ€§ final boolean clickable = ((viewFlags &amp; CLICKABLE) == CLICKABLE || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE; // ... if (clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP) { switch (action) { case MotionEvent.ACTION_UP: // ... if (!focusTaken) { if (mPerformClick == null) { mPerformClick = new PerformClick(); } if (!post(mPerformClick)) { performClick(); } } // ... break; case MotionEvent.ACTION_DOWN: // ... if (!clickable) { checkForLongClick(0, x, y); break; } // ... break; // ... } return true; } return false; } è¿™é‡Œå…ˆåˆ¤æ–­æŒ‡å®šçš„æŽ§ä»¶æ˜¯å¦æ˜¯å¯ç‚¹å‡»çš„ï¼Œå³æ˜¯å¦è®¾ç½®è¿‡ç‚¹å‡»æˆ–è€…é•¿æŒ‰çš„äº‹ä»¶ã€‚ç„¶åŽä¼šåœ¨æ‰‹åŠ¿æŠ¬èµ·çš„æ—¶å€™è°ƒç”¨ performClick() æ–¹æ³•ï¼Œå¹¶ä¼šåœ¨è¿™ä¸ªæ–¹æ³•ä¸­å°è¯•ä»Ž ListenerInfo å– OnClickListener è¿›è¡Œå›žè°ƒï¼›ä¼šåœ¨é•¿æŒ‰çš„æ—¶å€™è¿›è¡Œç›‘å¬ä»¥è°ƒç”¨ç›¸åº”é•¿æŒ‰äº‹ä»¶ï¼›å…¶ä»–çš„äº‹ä»¶ä¸Žä¹‹ç±»ä¼¼ï¼Œå¯ä»¥è‡ªè¡Œåˆ†æžã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼šå½“ä¸ºæŽ§ä»¶çš„è§¦æ‘¸äº‹ä»¶è¿›è¡Œäº†èµ‹å€¼å¹¶ä¸”åœ¨å…¶ä¸­è¿”å›žäº† true å°±ä»£è¡¨è¯¥äº‹ä»¶è¢«æ¶ˆè´¹äº†ï¼Œå³ä½¿è®¾ç½®è¿‡å•å‡»å’Œé•¿æŒ‰äº‹ä»¶ä¹Ÿä¸ä¼šè¢«å›žè°ƒï¼Œè§¦æ‘¸äº‹ä»¶çš„ä¼˜å…ˆçº§æ¯”åŽé¢ä¸¤è€…è¦é«˜ã€‚ ç»è¿‡ä¸Šè¿°åˆ†æžï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ View ä¸­çš„ dispatchTouchEvent(MotionEvent) æ–¹æ³•å°±æ˜¯ç”¨æ¥å¯¹æ‰‹åŠ¿è¿›è¡Œå¤„ç†çš„ï¼Œæ‰€ä»¥å›žåˆ° 4.3.2ï¼Œé‚£é‡Œçš„æ„æ€å°±æ˜¯ï¼šå¦‚æžœ ViewGroup æ‹¦æˆªäº†è§¦æ‘¸äº‹ä»¶ï¼Œé‚£ä¹ˆå®ƒå°±è‡ªå·±æ¥å¯¹äº‹ä»¶è¿›è¡Œå¤„ç†ï¼›å¦åˆ™å°±æŠŠè§¦æ‘¸äº‹ä»¶ä¼ é€’ç»™å­å…ƒç´ ï¼Œè®©å®ƒæ¥è¿›è¡Œå¤„ç†ã€‚ 4.4.4 æ€»ç»“ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬å¯¹ Android ä¸­äº‹ä»¶åˆ†å‘æœºåˆ¶çš„è¯¦è§£ï¼Œä½ å¯ä»¥é€šè¿‡å›¾ç‰‡å’Œä»£ç ç»“åˆæ¥æ›´é€å½»å¾—äº†è§£è¿™æ–¹é¢çš„å†…å®¹ã€‚è™½ç„¶è¿™éƒ¨åˆ†ä»£ç æ¯”è¾ƒå¤šã€æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯æ¯ä¸ªåœ°æ–¹çš„è®¾è®¡éƒ½æ˜¯åˆæƒ…åˆç†çš„ã€‚ æºä»£ç ä½ å¯ä»¥åœ¨GithubèŽ·å–ä»¥ä¸Šç¨‹åºçš„æºä»£ç ï¼š Android-referencesã€‚]]></content>
      <categories>
        <category>AndroidæŽ§ä»¶è¯¦è§£</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>æºç é˜…è¯»</tag>
        <tag>æŽ§ä»¶ä½“ç³»</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[View ä½“ç³»è¯¦è§£ï¼šView çš„å·¥ä½œæµç¨‹]]></title>
    <url>%2F2018%2F10%2F14%2FView%20%E4%BD%93%E7%B3%BB%E8%AF%A6%E8%A7%A3%EF%BC%9AView%20%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%2F</url>
    <content type="text"><![CDATA[1ã€View æ ‘çš„åŠ è½½æµç¨‹å½“æˆ‘ä»¬è°ƒç”¨ startActivity() æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ° ActivityThread ä¸­çš„ performLaunchActivity() èŽ·å–ä¸€ä¸ª Activity å®žä¾‹ï¼Œ å¹¶åœ¨ Instrumentation çš„ callActivityOnCreate() æ–¹æ³•ä¸­è°ƒç”¨ Activity çš„ onCreate() å®Œæˆ DecorView çš„åˆ›å»ºã€‚è¿™æ ·æˆ‘ä»¬å°±èŽ·å–äº†ä¸€ä¸ª Activity çš„å®žä¾‹ï¼Œç„¶åŽæˆ‘ä»¬è°ƒç”¨ handleResumeActivity() æ¥å›žè°ƒ Activity çš„ onResume()ï¼š private void handleLaunchActivity(ActivityClientRecord r, Intent customIntent, String reason) { // .... WindowManagerGlobal.initialize(); // åˆ›å»º Activity çš„å®žä¾‹ï¼Œåœ¨è¿™é‡Œå®Œæˆå¯¹ Activity çš„ onCreate() æ–¹æ³•çš„å›žè°ƒ Activity a = performLaunchActivity(r, customIntent); if (a != null) { // ... // åœ¨è¿™é‡Œå›žè°ƒ Activity çš„ onResume() æ–¹æ³• handleResumeActivity(r.token, false, r.isForward, !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason); if (!r.activity.mFinished &amp;&amp; r.startsNotResumed) { // åœ¨è¿™é‡Œå®Œæˆå¯¹ Activity çš„ onPause() æ–¹æ³•çš„å›žè°ƒ performPauseActivityIfNeeded(r, reason); // ... } } // ... } ç„¶åŽï¼Œåœ¨ handleResumeActivity() æ–¹æ³•ä¸­çš„ performResumeActivity() ä¼šå›žè°ƒ Activity çš„ onResume() æ–¹æ³•ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šä»Ž Window ä¸­èŽ·å–ä¹‹å‰æ·»åŠ è¿›åŽ»çš„ DecorViewï¼Œç„¶åŽå°†å…¶æ·»åŠ åˆ° WindowManager ä¸­ï¼š final void handleResumeActivity(IBinder token, boolean clearHide, boolean isForward, boolean reallyResume, int seq, String reason) { // åœ¨è¿™é‡Œä¼šå›žè°ƒ Activity çš„ onResume() r = performResumeActivity(token, clearHide, reason); if (r != null) { final Activity a = r.activity; // ... if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) { r.window = r.activity.getWindow(); // åœ¨è¿™é‡ŒèŽ·å– DecorView View decor = r.window.getDecorView(); decor.setVisibility(View.INVISIBLE); // èŽ·å– WindowManager å®žä¾‹ï¼Œå®žé™…æ˜¯ WindowManagerImpl ViewManager wm = a.getWindowManager(); WindowManager.LayoutParams l = r.window.getAttributes(); a.mDecor = decor; l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION; l.softInputMode |= forwardBit; if (r.mPreserveWindow) { a.mWindowAdded = true; r.mPreserveWindow = false; // Activity è¢«é‡å»ºï¼Œå¤ç”¨ DecorViewï¼Œé€šçŸ¥å­å…ƒç´  ViewRootImpl impl = decor.getViewRootImpl(); if (impl != null) { impl.notifyChildRebuilt(); } } if (a.mVisibleFromClient) { if (!a.mWindowAdded) { a.mWindowAdded = true; // å°† DecorView æ·»åŠ åˆ° WindowManager ä¸­ wm.addView(decor, l); } else { a.onWindowAttributesChanged(l); } } } } } è¿™é‡Œçš„ WindowManager æ˜¯ WindowManagerImpl çš„å®žä¾‹ï¼Œè€Œè°ƒç”¨å®ƒçš„ addView() æ–¹æ³•çš„æ—¶å€™ä¼šä½¿ç”¨ WindowManagerGlobal çš„ addView() æ–¹æ³•ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ä¼š new å‡ºæ¥ä¸€ä¸ª ViewRootImplï¼Œç„¶åŽè°ƒç”¨å®ƒçš„ setView() æŠŠä¼ è¿›æ¥çš„ DecorView æ·»åŠ åˆ° Window é‡Œã€‚åŒæ—¶ï¼Œä¼šè°ƒç”¨ requestLayout() æ–¹æ³•è¿›è¡Œå¸ƒå±€ï¼Œç„¶åŽï¼Œå¹¶æœ€ç»ˆè°ƒç”¨ performTraversals() å®Œæˆå¯¹æ•´ä¸ª View æ ‘è¿›è¡ŒéåŽ†ï¼š private void performTraversals() { // ... if (!mStopped || mReportNextDraw) { // ... performMeasure(childWidthMeasureSpec, childHeightMeasureSpec); } // ... final boolean didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw); boolean triggerGlobalLayoutListener = didLayout || mAttachInfo.mRecomputeGlobalAttributes; if (didLayout) { performLayout(lp, mWidth, mHeight); // ... } // ... if (!cancelDraw &amp;&amp; !newSurface) { // ... performDraw(); } } åœ¨è¯¥æ–¹æ³•ä¸­ä¼šè°ƒç”¨ performMeasure()ã€performLayout() å’Œ performDraw() ä¸‰ä¸ªæ–¹æ³•ï¼Œå®ƒä»¬åˆ†åˆ«ä¼šè°ƒç”¨ DecorView çš„ measure()ã€layout() å’Œ draw() å®Œæˆå¯¹æ•´ä¸ª View æ ‘çš„æµ‹é‡ã€å¸ƒå±€å’Œç»˜åˆ¶ï¼Œä¸€ä¸ªç•Œé¢ä¹Ÿå°±å‘ˆçŽ°ç»™ç”¨æˆ·äº†ã€‚å¦‚æžœæ‚¨åšè¿‡è‡ªå®šä¹‰ View çš„è¯ï¼Œé‚£ä¹ˆæ‚¨å¯¹ onMeasure()ã€onLayout() å’Œ onDraw()ä¸‰ä¸ªæ–¹æ³•ä¸€å®šä¸ä¼šé™Œç”Ÿï¼Œå‰é¢çš„ä¸‰ä¸ªæ–¹æ³•ä¸ŽåŽé¢çš„ä¸‰ä¸ªæ–¹æ³•ä¹‹é—´çš„å…³ç³»å°±æ˜¯ï¼šåŽé¢çš„ä¸‰ä¸ªæ–¹æ³•ä¼šè¢«å‰é¢çš„ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æä¾›ç»™ç”¨æˆ·ç”¨æ¥è‡ªå®šä¹‰çš„æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬å°±çœ‹ä¸‹è¿™ä¸‰ä¸ªæ–¹æ³•ç©¶ç«Ÿå„è‡ªåšäº†ä»€ä¹ˆæ“ä½œï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬å°½å¯èƒ½ä»Žè‡ªå®šä¹‰æŽ§ä»¶çš„è§’åº¦æ¥åˆ†æžï¼Œå› ä¸ºè¿™å¯¹ä¸€ä¸ªå¼€å‘è€…å¯èƒ½å¸®åŠ©æ›´å¤§ã€‚ 2ã€measure()View çš„å¤§å°ä¸ä»…ç”±è‡ªèº«æ‰€å†³å®šï¼ŒåŒæ—¶ä¹Ÿä¼šå—åˆ°çˆ¶æŽ§ä»¶çš„å½±å“ï¼Œä¸ºäº†æˆ‘ä»¬çš„æŽ§ä»¶èƒ½æ›´å¥½çš„é€‚åº”å„ç§æƒ…å†µï¼Œä¸€èˆ¬ä¼šè‡ªå·±è¿›è¡Œæµ‹é‡ã€‚åœ¨ä¸Šé¢æˆ‘ä»¬æåˆ°äº† measure() æ–¹æ³•ï¼Œå®ƒæ˜¯ç”¨æ¥æµ‹é‡ View çš„å¤§å°çš„ï¼Œä½†å®žé™…ä¸Šæµ‹é‡çš„ä¸»è¦å·¥ä½œæ˜¯äº¤ç»™ onMeasure() æ–¹æ³•çš„ã€‚åœ¨ View ä¸­ï¼ŒonMeasure() æ˜¯ä¸€ä¸ª protected çš„æ–¹æ³•ï¼Œæ˜¾ç„¶å®ƒè®¾è®¡çš„ç›®çš„å°±æ˜¯ï¼šæä¾›ç»™å­ View æŒ‰ç…§çˆ¶å®¹å™¨æä¾›çš„é™åˆ¶æ¡ä»¶ï¼ŒæŽ§åˆ¶è‡ªèº«çš„å¤§å°ï¼Œå®žçŽ°è‡ªå·±å¤§å°çš„æµ‹é‡é€»è¾‘ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªæŽ§ä»¶çš„æ—¶å€™ï¼Œåªä¼šåŽ»è¦†å†™ onMeasure() è€Œä¸åŽ»è¦†å†™ measure() æ–¹æ³•ã€‚ åœ¨ Android ä¸­ï¼Œæˆ‘ä»¬çš„æŽ§ä»¶åˆ†æˆ View å’Œ ViewGroup ä¸¤ç§ç±»åž‹ã€‚æ ¹æ®ä¸Šé¢çš„åˆ†æžï¼Œå¯¹ View çš„æµ‹é‡ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼šåœ¨ Android ä¸­ï¼ŒViewGroup ä¼šæ ¹æ®å…¶è‡ªèº«çš„å¸ƒå±€ç‰¹ç‚¹ï¼ŒæŠŠé™åˆ¶æ¡ä»¶å°è£…æˆ widthMeasureSpec å’Œ heightMeasureSpec ä¸¤ä¸ªå‚æ•°ä¼ é€’ç»™å­å…ƒç´ ï¼›ç„¶åŽï¼Œåœ¨å­å…ƒç´ ä¸­æ ¹æ®è¿™ä¸¤ä¸ªå‚æ•°æ¥è°ƒæ•´è‡ªèº«çš„å¤§å°ã€‚æ‰€ä»¥ï¼ŒViewGroup çš„ measure() æ–¹æ³•ä¼šæ ¹æ®å…¶å¸ƒå±€ç‰¹æ€§çš„ä¸åŒè€Œä¸åŒï¼›è€Œ View çš„ measure()ï¼Œä¸è®ºå…¶çˆ¶å®¹å™¨æ˜¯å“ªç§ç±»åž‹ï¼Œåªæ ¹æ® widthMeasureSpec å’Œ heightMeasureSpec å†³å®šã€‚ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ onMeasure() åœ¨ View å’Œ ViewGroup ä¸­çš„ä¸åŒè¡¨çŽ°å½¢å¼ã€‚ 2.1 View çš„ onMeasure()ä¸‹é¢æ˜¯ View ç±»ä¸­çš„ onMeasure() æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªé»˜è®¤çš„å®žçŽ°ï¼Œè°ƒç”¨äº† setMeasuredDimension() æ–¹æ³•æ¥å­˜å‚¨æµ‹é‡ä¹‹åŽçš„å®½åº¦å’Œé«˜åº¦ã€‚å½“æˆ‘ä»¬è‡ªå®šä¹‰ View çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦è°ƒç”¨ setMeasuredDimension() æ–¹æ³•æŠŠæœ€ç»ˆçš„æµ‹é‡ç»“æžœå­˜å‚¨èµ·æ¥ï¼š protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { setMeasuredDimension( getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec), getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec)); } æ˜¾ç„¶ï¼Œæˆ‘ä»¬çš„æµ‹é‡ä¾æ®å°±æ˜¯ widthMeasureSpec å’Œ heightMeasureSpec ä¸¤ä¸ªå‚æ•°ã€‚å®ƒä»¬æ˜¯æ•´åž‹çš„ã€32ä½å˜é‡ï¼ŒåŒ…å«äº†æµ‹é‡æ¨¡å¼å’Œæµ‹é‡æ•°å€¼çš„ä¿¡æ¯ï¼ˆæŒ‰ä½å­˜å‚¨åˆ°æ•´åž‹å˜é‡ä¸Šï¼ŒåŒ…è£…æˆæ•´åž‹çš„ç›®çš„æ˜¯ä¸ºäº†èŠ‚çº¦å­˜å‚¨ç©ºé—´ï¼‰ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¼šåƒä¸‹é¢è¿™æ ·æ¥åˆ†åˆ«èŽ·å–é«˜åº¦å’Œå®½åº¦çš„æµ‹é‡æ¨¡å¼å’Œæµ‹é‡æ•°å€¼ï¼ˆå®žé™…å°±æ˜¯æŒ‰ä½æˆªå–ï¼‰ï¼š int widthsize = MeasureSpec.getSize(widthMeasureSpec); // æµ‹é‡æ•°å€¼ int widthmode = MeasureSpec.getMode(widthMeasureSpec); // æµ‹é‡æ¨¡å¼ int heightsize = MeasureSpec.getSize(heightMeasureSpec); // æµ‹é‡æ•°å€¼ int heightmode = MeasureSpec.getMode(heightMeasureSpec); // æµ‹é‡æ¨¡å¼ æµ‹é‡æ¨¡å¼å…±æœ‰ MeasureSpec.UNSPECIFIEDã€MeasureSpec.AT_MOST å’Œ MeasureSpec.EXACTLY ä¸‰ç§ï¼Œåˆ†åˆ«å¯¹åº”äºŒè¿›åˆ¶æ•°å€¼ 00ã€01 å’Œ 10ï¼Œå®ƒä»¬å„è‡ªçš„å«ä¹‰å¦‚ä¸‹ï¼š UNSPECIFIEDï¼šé»˜è®¤å€¼ï¼Œçˆ¶æŽ§ä»¶æ²¡æœ‰ç»™å­ View ä»»ä½•é™åˆ¶ï¼Œå­ View å¯ä»¥è®¾ç½®ä¸ºä»»æ„å¤§å°ï¼› EXACTLYï¼šè¡¨ç¤ºçˆ¶æŽ§ä»¶å·²ç»ç¡®åˆ‡çš„æŒ‡å®šäº†å­ View çš„å¤§å°ï¼› AT_MOSTï¼šè¡¨ç¤ºå­ View å…·ä½“å¤§å°æ²¡æœ‰å°ºå¯¸é™åˆ¶ï¼Œä½†æ˜¯å­˜åœ¨ä¸Šé™ï¼Œä¸Šé™ä¸€èˆ¬ä¸ºçˆ¶ View å¤§å°ã€‚ è¿™é‡Œï¼Œæˆ‘ä¸æ‰“ç®—è¯¦ç»†ä»‹ç» View ä¸­é»˜è®¤æµ‹é‡é€»è¾‘çš„å…·ä½“å®žçŽ°ã€‚å®ƒçš„å¤§è‡´é€»è¾‘æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆæˆ‘ä»¬ä¼šç”¨ getDefaultSize() èŽ·å–é»˜è®¤çš„å®½åº¦æˆ–è€…é«˜åº¦ï¼Œè¿™ä¸ªæ–¹æ³•æŽ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯é»˜è®¤çš„å°ºå¯¸ï¼Œä¸€ä¸ªæµ‹é‡æ¨¡å¼ã€‚å¦‚æžœçˆ¶æŽ§ä»¶æ²¡æœ‰ç»™å®ƒä»»ä½•é™åˆ¶ï¼Œå®ƒå°±ä½¿ç”¨é»˜è®¤çš„å°ºå¯¸ï¼Œå¦åˆ™ä½¿ç”¨æµ‹é‡æ•°å€¼ã€‚è¿™é‡Œçš„é»˜è®¤çš„å°ºå¯¸é€šè¿‡ getSuggestedMinimumHeight()/getSuggestedMinimumWidth() æ–¹æ³•å¾—åˆ°ï¼Œå®ƒä¼šæ ¹æ®èƒŒæ™¯å›¾ç‰‡é«˜åº¦/å®½åº¦å’Œ mMinHeight/mMinWidth çš„å€¼ï¼Œå–ä¸€ä¸ªæœ€å¤§çš„å€¼ä½œä¸ºæŽ§ä»¶çš„é«˜åº¦/å®½åº¦ã€‚ æ‰€ä»¥ï¼ŒView çš„é»˜è®¤çš„æµ‹é‡é€»è¾‘çš„å®žé™…æ•ˆæžœæ˜¯ï¼šé¦–å…ˆ View çš„å¤§å°å—çˆ¶å®¹å™¨çš„å½±å“ï¼Œå¦‚æžœçˆ¶å®¹å™¨æ²¡æœ‰ç»™å®ƒé™åˆ¶çš„è¯ï¼Œå®ƒä¼šå–èƒŒæ™¯å›¾ç‰‡å’Œæœ€å°çš„é«˜åº¦æˆ–è€…å®½åº¦ä¸­å–ä¸€ä¸ªæœ€å¤§çš„å€¼ä½œä¸ºè‡ªå·±çš„å¤§å°ã€‚ 2.2 ViewGroup çš„ onMeasure()2.2.1 ViewGroup ä¸­çš„æ–¹æ³•ç”±äºŽ ViewGroup æœ¬èº«æ²¡æœ‰å¸ƒå±€çš„ç‰¹ç‚¹ï¼Œæ‰€ä»¥å®ƒæ²¡æœ‰è¦†å†™ onMeasure()ã€‚æœ‰è‡ªèº«å¸ƒå±€ç‰¹ç‚¹çš„ï¼Œæ¯”å¦‚ LinearLayout å’Œ RelativeLayout ç­‰éƒ½è¦†å†™å¹¶å®žçŽ°äº†è¿™ä¸ªæ–¹æ³•ã€‚å°½ç®¡å¦‚æ­¤ï¼ŒViewGroup æä¾›äº†ä¸€äº›æ–¹æ³•å¸®åŠ©æˆ‘ä»¬è¿›è¡Œæµ‹é‡ï¼Œé¦–å…ˆæ˜¯ measureChildren() æ–¹æ³•ï¼š protected void measureChildren(int widthMeasureSpec, int heightMeasureSpec) { final int size = mChildrenCount; final View[] children = mChildren; for (int i = 0; i &lt; size; ++i) { final View child = children[i]; if ((child.mViewFlags &amp; VISIBILITY_MASK) != GONE) { measureChild(child, widthMeasureSpec, heightMeasureSpec); } } } è¿™é‡Œçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å¯¹å­å…ƒç´ è¿›è¡ŒéåŽ†å¹¶åˆ¤æ–­å¦‚æžœæŒ‡å®šçš„ View æ˜¯å¦ä½ GONE çš„çŠ¶æ€ï¼Œå¦‚æžœä¸æ˜¯å°±è°ƒç”¨ measureChild() æ–¹æ³•ï¼š protected void measureChild(View child, int parentWidthMeasureSpec, int parentHeightMeasureSpec) { final LayoutParams lp = child.getLayoutParams(); final int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec, mPaddingLeft + mPaddingRight, lp.width); final int childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec, mPaddingTop + mPaddingBottom, lp.height); child.measure(childWidthMeasureSpec, childHeightMeasureSpec); } è¯¥æ–¹æ³•ä¹Ÿæ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œå°±æ˜¯å°†å­å…ƒç´ çš„å¸ƒå±€å‚æ•° LayoutParams å–å‡ºï¼ŒèŽ·å–å®ƒçš„å®½åº¦å’Œé«˜åº¦ä¹‹åŽï¼Œå°†æ‰€æœ‰ä¿¡æ¯ä¼ é€’ç»™ getChildMeasureSpec()ã€‚è¿™æ ·å°±å¾—åˆ°äº†ç”¨äºŽå­å…ƒç´ å¸ƒå±€çš„ childWidthMeasureSpec å’Œ childHeightMeasureSpec å‚æ•°ã€‚ç„¶åŽï¼Œå†è°ƒç”¨å­å…ƒç´ çš„ measure() æ–¹æ³•ï¼Œä»Žè€Œä¾æ¬¡å®Œæˆå¯¹æ•´ä¸ª View æ ‘çš„éåŽ†ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹ getChildMeasureSpec() æ–¹æ³•åšäº†ä»€ä¹ˆæ“ä½œï¼š public static int getChildMeasureSpec(int spec, int padding, int childDimension) { // é¦–å…ˆä»Ž spec ä¸­å–å‡ºçˆ¶æŽ§ä»¶çš„æµ‹é‡æ¨¡å¼å’Œæµ‹é‡æ•°å€¼ int specMode = MeasureSpec.getMode(spec); int specSize = MeasureSpec.getSize(spec); // è¿™é‡Œéœ€è¦ä¿è¯ size ä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œä¹Ÿå°±æ˜¯é¢„ç•™ç»™å­å…ƒç´ çš„æœ€å¤§ç©ºé—´ï¼Œç”±çˆ¶å…ƒç´ çš„æµ‹é‡æ•°å€¼å‡åŽ»å¡«å……å¾—åˆ° int size = Math.max(0, specSize - padding); // ç”¨äºŽè¿”å›žçš„å€¼ int resultSize = 0; int resultMode = 0; // æ ¹æ®çˆ¶ç©ºé—´çš„æµ‹é‡æ¨¡å¼ switch (specMode) { // çˆ¶æŽ§ä»¶çš„å¤§å°æ˜¯å›ºå®šçš„ case MeasureSpec.EXACTLY: if (childDimension &gt;= 0) { // å­ View æŒ‡å®šäº†å¤§å° resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // å­å…ƒç´ å¸Œæœ›å¤§å°ä¸Žçˆ¶æŽ§ä»¶ç›¸åŒï¼ˆå¡«æ»¡æ•´ä¸ªçˆ¶æŽ§ä»¶ï¼‰ resultSize = size; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // å­å…ƒç´ å¸Œæœ›æœ‰è‡ªå·±å†³å®šå¤§å°ï¼Œä½†æ˜¯ä¸èƒ½æ¯”çˆ¶æŽ§ä»¶å¤§ resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // çˆ¶æŽ§ä»¶çš„å…·ä½“å¤§å°æ²¡æœ‰å°ºå¯¸é™åˆ¶ï¼Œä½†æ˜¯å­˜åœ¨ä¸Šé™ case MeasureSpec.AT_MOST: if (childDimension &gt;= 0) { // å­ View æŒ‡å®šäº†å¤§å° resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // å­æŽ§ä»¶å¸Œæœ›ä¸Žçˆ¶æŽ§ä»¶å¤§å°ä¸€è‡´ï¼Œä½†æ˜¯çˆ¶æŽ§ä»¶çš„å¤§å°ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ï¼Œæ•…è®©å­æŽ§ä»¶ä¸è¦æ¯”çˆ¶æŽ§ä»¶å¤§ resultSize = size; resultMode = MeasureSpec.AT_MOST; } else if (childDimension == LayoutParams.WRAP_CONTENT) { // å­æŽ§ä»¶å¸Œæœ›è‡ªå·±å†³å®šå¤§å°ï¼Œé™åˆ¶å…¶ä¸è¦æ¯”çˆ¶æŽ§ä»¶å¤§ resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // çˆ¶æŽ§ä»¶æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå¯ä»¥è®¾ç½®ä¸ºä»»æ„å¤§å° case MeasureSpec.UNSPECIFIED: if (childDimension &gt;= 0) { // å­å…ƒç´ è®¾ç½®äº†å¤§å° resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // å­æŽ§ä»¶å¸Œæœ›å’Œçˆ¶æŽ§ä»¶ä¸€æ ·å¤§ï¼Œä½†æ˜¯çˆ¶æŽ§ä»¶å¤šå¤§éƒ½ä¸ç¡®å®šï¼›ç³»ç»Ÿ23ä»¥ä¸‹è¿”å›žtrueï¼Œä»¥ä¸Šè¿”å›žsize resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size; resultMode = MeasureSpec.UNSPECIFIED; } else if (childDimension == LayoutParams.WRAP_CONTENT) { resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size; resultMode = MeasureSpec.UNSPECIFIED; } break; } // è¿”å›žä¸€ä¸ªå°è£…å¥½çš„æµ‹é‡ç»“æžœï¼Œå°±æ˜¯æŠŠæµ‹é‡æ•°å€¼å’Œæµ‹é‡æ¨¡å¼å°è£…æˆä¸€ä¸ª32ä½çš„æ•´æ•° return MeasureSpec.makeMeasureSpec(resultSize, resultMode); } ä¸Šé¢æˆ‘ä»¬å·²ç»ä¸ºè¿™æ®µä»£ç ä½œäº†éžå¸¸è¯¦ç»†çš„æ³¨é‡Šã€‚åªéœ€è¦æ³¨æ„ï¼Œè¿™é‡Œåœ¨èŽ·å–å­å…ƒç´ çš„æµ‹é‡ç»“æžœçš„æ—¶å€™æ˜¯åŸºäºŽçˆ¶æŽ§ä»¶çš„æµ‹é‡ç»“æžœæ¥çš„ï¼Œéœ€è¦æ ¹æ®çˆ¶å…ƒç´ çš„æµ‹é‡æ¨¡å¼å’Œæµ‹é‡æ•°å€¼ç»“åˆè‡ªèº«çš„å¸ƒå±€ç‰¹ç‚¹åˆ†æˆä¸Šé¢ä¹ç§æƒ…å†µã€‚æˆ–è€…å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„å†™æ³•å°†å…¶åˆ’åˆ†æˆä¸‹é¢å‡ ç§æƒ…å†µï¼š public static int getChildMeasureSpec(int spec, int padding, int childDimension) { int specMode = MeasureSpec.getMode(spec), specSize = MeasureSpec.getSize(spec); int size = Math.max(0, specSize - padding); int resultSize = 0, resultMode = 0; if (childDimension &gt;= 0) { // å­å…ƒç´ æŒ‡å®šäº†å…·ä½“çš„å¤§å°ï¼Œå°±ç”¨å­å…ƒç´ çš„å¤§å° resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == ViewGroup.LayoutParams.MATCH_PARENT) { // å­å…ƒç´ å¸Œæœ›å’Œçˆ¶æŽ§ä»¶ä¸€æ ·å¤§ï¼Œéœ€è¦è®¾ç½®å…¶ä¸Šé™ï¼Œç„¶åŽæµ‹é‡æ¨¡å¼ä¸Žçˆ¶æŽ§ä»¶ä¸€è‡´å³å¯ if (specMode == MeasureSpec.EXACTLY || specMode == MeasureSpec.AT_MOST) { resultSize = size; resultMode = specMode; } else if (specMode == MeasureSpec.UNSPECIFIED) { // API23ä¸€ä¸‹å°±æ˜¯0ï¼Œçˆ¶æŽ§ä»¶æ²¡æœ‰æŒ‡å®šå¤§å°çš„æ—¶å€™ï¼Œå­æŽ§ä»¶åªèƒ½æ˜¯0ï¼›ä»¥ä¸Šæ˜¯size resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size; resultMode = MeasureSpec.UNSPECIFIED; } } else if (childDimension == ViewGroup.LayoutParams.WRAP_CONTENT) { // å­å…ƒç´ å¸Œæœ›è‡ªå·±å†³å®šå¤§å°ï¼Œè®¾ç½®å…¶å¤§å°çš„ä¸Šé™æ˜¯çˆ¶æŽ§ä»¶çš„å¤§å°å³å¯ if (specMode == MeasureSpec.EXACTLY || specMode == MeasureSpec.AT_MOST) { resultSize = size; resultMode = MeasureSpec.AT_MOST; } else if (specMode == MeasureSpec.UNSPECIFIED) { // API23ä¸€ä¸‹å°±æ˜¯0ï¼Œçˆ¶æŽ§ä»¶æ²¡æœ‰æŒ‡å®šå¤§å°çš„æ—¶å€™ï¼Œå­æŽ§ä»¶åªèƒ½æ˜¯0ï¼›ä»¥ä¸Šæ˜¯size resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size; resultMode = MeasureSpec.UNSPECIFIED; } } return MeasureSpec.makeMeasureSpec(resultSize, resultMode); } è¿™ä¸¤ç§æ–¹å¼åªæ˜¯åˆ’åˆ†çš„è§’åº¦ä¸ä¸€æ ·ï¼ŒåŽé¢çš„è¿™ç§æ–¹æ³•æ˜¯ä»Žå­å…ƒç´ çš„å¸ƒå±€å‚æ•°ä¸Šé¢æ¥è€ƒè™‘çš„ã€‚å¦å¤–ï¼Œè¿™é‡Œæœ‰ä¸ª sUseZeroUnspecifiedMeasureSpec å¸ƒå°”å‚æ•°éœ€è¦æåŠä¸€ä¸‹ï¼Œä¼šæ ¹æ®ç³»ç»Ÿçš„ç‰ˆæœ¬æ¥è¿›è¡Œèµ‹å€¼ï¼š sUseZeroUnspecifiedMeasureSpec = targetSdkVersion &lt; Build.VERSION_CODES.M; ä¹Ÿå°±æ˜¯å½“ç³»ç»Ÿæ˜¯ API23 ä»¥ä¸‹çš„æ—¶å€™çš„ä¸º true. åŠ å…¥è¿™ä¸ªå‚æ•°çš„åŽŸå› æ˜¯ï¼ŒAPI23 ä¹‹åŽï¼Œå½“çˆ¶æŽ§ä»¶çš„æµ‹é‡æ¨¡å¼æ˜¯ UNSPECIFIED çš„æ—¶å€™ï¼Œå­å…ƒç´ å¯ä»¥ç»™çˆ¶æŽ§ä»¶æä¾›ä¸€ä¸ªå¯èƒ½çš„å¤§å°ã€‚ä¸‹é¢æ˜¯æ³¨é‡Šçš„åŽŸè¯ ;-) // In M and newer, our widgets can pass a &quot;hint&quot; value in the size // for UNSPECIFIED MeasureSpecs. This lets child views of scrolling containers // know what the expected parent size is going to be, so e.g. list items can size // themselves at 1/3 the size of their container. It breaks older apps though, // specifically apps that use some popular open source libraries. 2.2.2 LinearLayout çš„ onMeasure()ä¸Šé¢æˆ‘ä»¬åˆ†æžçš„æ˜¯ ViewGroup ä¸­æä¾›çš„ä¸€äº›æ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬ä»¥ LinearLayout ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹ä¸€ä¸ªæ ‡å‡†çš„å®¹å™¨ç±»åž‹çš„æŽ§ä»¶æ˜¯å¦‚ä½•å®žçŽ°å…¶æµ‹é‡çš„é€»è¾‘çš„ã€‚ ä¸‹é¢æ˜¯å…¶ onMeasure() æ–¹æ³•ï¼Œæ˜¾ç„¶åœ¨è¿›è¡Œæµ‹é‡çš„æ—¶å€™ä¼šæ ¹æ®å…¶å¸ƒå±€çš„æ–¹å‘åˆ†åˆ«å®žçŽ°æµ‹é‡çš„é€»è¾‘ï¼š protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { if (mOrientation == VERTICAL) { measureVertical(widthMeasureSpec, heightMeasureSpec); } else { measureHorizontal(widthMeasureSpec, heightMeasureSpec); } } ç„¶åŽï¼Œæˆ‘ä»¬ä»¥ measureVertical() ä¸ºä¾‹ï¼Œæ¥çœ‹ä¸€ä¸‹ LinearLayout åœ¨åž‚ç›´æ–¹å‘ä¸Šé¢æ˜¯å¦‚ä½•è¿›è¡Œæµ‹é‡çš„ã€‚è¿™æ®µä»£ç æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬åªæˆªå–å…¶ä¸­çš„ä¸€éƒ¨åˆ†æ¥è¿›è¡Œåˆ†æžï¼š void measureVertical(int widthMeasureSpec, int heightMeasureSpec) { // ... // èŽ·å–LinearLayoutçš„æµ‹é‡æ¨¡å¼ final int widthMode = MeasureSpec.getMode(widthMeasureSpec); final int heightMode = MeasureSpec.getMode(heightMeasureSpec); // ... mTotalLength += mPaddingTop + mPaddingBottom; int heightSize = mTotalLength; heightSize = Math.max(heightSize, getSuggestedMinimumHeight()); // ... for (int i = 0; i &lt; count; ++i) { final View child = getVirtualChildAt(i); if (child == null || child.getVisibility() == View.GONE) { continue; } final LayoutParams lp = (LayoutParams) child.getLayoutParams(); final float childWeight = lp.weight; if (childWeight &gt; 0) { // ... // èŽ·å–ä¸€ä¸ªæµ‹é‡çš„æ•°å€¼å’Œæµ‹é‡æ¨¡å¼ final int childHeightMeasureSpec = MeasureSpec.makeMeasureSpec( Math.max(0, childHeight), MeasureSpec.EXACTLY); final int childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec, mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin, lp.width); // è°ƒç”¨å­å…ƒç´ è¿›è¡Œæµ‹é‡ child.measure(childWidthMeasureSpec, childHeightMeasureSpec); childState = combineMeasuredStates(childState, child.getMeasuredState() &amp; (MEASURED_STATE_MASK&gt;&gt;MEASURED_HEIGHT_STATE_SHIFT)); } final int margin = lp.leftMargin + lp.rightMargin; final int measuredWidth = child.getMeasuredWidth() + margin; maxWidth = Math.max(maxWidth, measuredWidth); boolean matchWidthLocally = widthMode != MeasureSpec.EXACTLY &amp;&amp; lp.width == LayoutParams.MATCH_PARENT; alternativeMaxWidth = Math.max(alternativeMaxWidth, matchWidthLocally ? margin : measuredWidth); allFillParent = allFillParent &amp;&amp; lp.width == LayoutParams.MATCH_PARENT; final int totalLength = mTotalLength; // å°†å®½åº¦å¢žåŠ åˆ° mTotalLength ä¸Š mTotalLength = Math.max(totalLength, totalLength + child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin + getNextLocationOffset(child)); } mTotalLength += mPaddingTop + mPaddingBottom; // ... maxWidth += mPaddingLeft + mPaddingRight; maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth()); // æœ€ç»ˆç¡®å®šæµ‹é‡çš„å¤§å° setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState), heightSizeAndState); // ... } ä¸Šé¢æ˜¯ LinearLayout åœ¨åž‚ç›´æ–¹å‘ä¸Šé¢çš„æµ‹é‡çš„è¿‡ç¨‹ï¼Œåœ¨æµ‹é‡çš„æ—¶å€™ä¼šæ ¹æ®å­å…ƒç´ çš„å¸ƒå±€å°†å­å…ƒç´ çš„æµ‹é‡é«˜åº¦æ·»åŠ åˆ° mTotalLength ä¸Šï¼Œç„¶åŽå†åŠ ä¸Šå¡«å……çš„å¤§å°ï¼Œä½œä¸ºæœ€ç»ˆçš„æµ‹é‡ç»“æžœã€‚ 3ã€layout() layout() ç”¨äºŽç¡®å®šæŽ§ä»¶çš„ä½ç½®ï¼Œå®ƒæä¾›äº† onLayout() æ¥äº¤ç»™å­—ç±»å®žçŽ°ï¼ŒåŒæ ·æˆ‘ä»¬åœ¨è‡ªå®šä¹‰æŽ§ä»¶çš„æ—¶å€™åªè¦å®žçŽ° onLayout() æ–¹æ³•å³å¯ã€‚åœ¨æˆ‘ä»¬è‡ªå®šä¹‰ View çš„æ—¶å€™ï¼Œå¦‚æžœå®šä¹‰çš„æ˜¯éž ViewGroup ç±»åž‹çš„æŽ§ä»¶ï¼Œä¸€èˆ¬æ˜¯ä¸éœ€è¦è¦†å†™ onLayout() æ–¹æ³•çš„ã€‚ ä¸‹é¢æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ layout() æ–¹æ³•åœ¨ View ä¸­çš„å®žçŽ°ï¼š public void layout(int l, int t, int r, int b) { if ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != 0) { onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec); mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT; } int oldL = mLeft; int oldT = mTop; int oldB = mBottom; int oldR = mRight; boolean changed = isLayoutModeOptical(mParent) ? setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b); if (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) { onLayout(changed, l, t, r, b); // ... } // ... } è¿™é‡Œä¼šè°ƒç”¨ setFrame() æ–¹æ³•ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯æ ¹æ®æ–°çš„å¸ƒå±€å‚æ•°å’Œè€çš„å¸ƒå±€å‚æ•°åšä¸€ä¸ªå¯¹æ¯”ï¼Œä»¥åˆ¤æ–­æŽ§ä»¶çš„å¤§å°æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æžœå˜åŒ–äº†çš„è¯å°±è°ƒç”¨ invalidate() æ–¹æ³•å¹¶ä¼ å…¥å‚æ•° trueï¼Œä»¥è¡¨æ˜Žç»˜å›¾çš„ç¼“å­˜ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚è¿™é‡Œå°±ä¸ç»™å‡ºè¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®žçŽ°äº†ã€‚ç„¶åŽæ³¨æ„åˆ°ï¼Œåœ¨ layout() æ–¹æ³•ä¸­ä¼šå›žè°ƒ onLayout() æ–¹æ³•æ¥å®Œæˆå„ä¸ªæŽ§ä»¶çš„ä½ç½®çš„ç¡®å®šã€‚ å¯¹äºŽ ViewGroupï¼Œå®ƒé‡å†™äº† layout() å¹¶åœ¨å…¶ä¸­è°ƒç”¨äº† View ä¸­çš„ layout() æ–¹æ³•ï¼Œä¸è¿‡æ•´ä½“å¹¶æ²¡æœ‰åšå¤ªå¤šçš„é€»è¾‘ã€‚ä¸Žæµ‹é‡è¿‡ç¨‹ç±»ä¼¼ï¼ŒViewGroup å¹¶æ²¡æœ‰å®žçŽ° onLayout æ–¹æ³•ã€‚åŒæ ·ï¼Œå¯¹äºŽ ViewGroup ç±»åž‹çš„æŽ§ä»¶ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»¥ LinearLayout ä¸ºä¾‹è¯´æ˜Žä¸€ä¸‹ onLayout() çš„å®žçŽ°é€»è¾‘ï¼š ä¸Žæµ‹é‡è¿‡ç¨‹ç±»ä¼¼ï¼ŒLinearLayout åœ¨ layout çš„æ—¶å€™ä¹Ÿæ ¹æ®å¸ƒå±€çš„æ–¹å‘åˆ†æˆä¸¤ç§æƒ…å½¢ï¼š protected void onLayout(boolean changed, int l, int t, int r, int b) { if (mOrientation == VERTICAL) { layoutVertical(l, t, r, b); } else { layoutHorizontal(l, t, r, b); } } è¿™é‡Œæˆ‘ä»¬ä»ä»¥åž‚ç›´æ–¹å‘çš„æ–¹æ³•ä¸ºä¾‹ã€‚ä¸Žæµ‹é‡çš„è¿‡ç¨‹ç›¸æ¯”ï¼Œlayout çš„è¿‡ç¨‹çš„æ˜¾å¾—ç®€å•ã€æ¸…æ™°å¾—å¤šï¼š void layoutVertical(int left, int top, int right, int bottom) { // ... // æ ¹æ®æŽ§ä»¶çš„ gravity ç‰¹ç‚¹å¾—åˆ°é¡¶éƒ¨çš„ä½ç½® switch (majorGravity) { case Gravity.BOTTOM: childTop = mPaddingTop + bottom - top - mTotalLength; break; case Gravity.CENTER_VERTICAL: childTop = mPaddingTop + (bottom - top - mTotalLength) / 2; break; case Gravity.TOP: default: childTop = mPaddingTop; break; } // éåŽ†å­æŽ§ä»¶ for (int i = 0; i &lt; count; i++) { final View child = getVirtualChildAt(i); if (child == null) { childTop += measureNullChild(i); } else if (child.getVisibility() != GONE) { final int childWidth = child.getMeasuredWidth(); final int childHeight = child.getMeasuredHeight(); final LinearLayout.LayoutParams lp = (LinearLayout.LayoutParams) child.getLayoutParams(); int gravity = lp.gravity; if (gravity &lt; 0) { gravity = minorGravity; } final int layoutDirection = getLayoutDirection(); final int absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection); // å¾—åˆ°å­æŽ§ä»¶çš„å·¦è¾¹çš„ä½ç½® switch (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) { case Gravity.CENTER_HORIZONTAL: childLeft = paddingLeft + ((childSpace - childWidth) / 2) + lp.leftMargin - lp.rightMargin; break; case Gravity.RIGHT: childLeft = childRight - childWidth - lp.rightMargin; break; case Gravity.LEFT: default: childLeft = paddingLeft + lp.leftMargin; break; } if (hasDividerBeforeChildAt(i)) { childTop += mDividerHeight; } childTop += lp.topMargin; // æœ¬è´¨ä¸Šè°ƒç”¨å­æŽ§ä»¶çš„ layout() æ–¹æ³• setChildFrame(child, childLeft, childTop + getLocationOffset(child), childWidth, childHeight); childTop += childHeight + lp.bottomMargin + getNextLocationOffset(child); i += getChildrenSkipCount(child, i); } } } å› ä¸ºå¸ƒå±€æ–¹å‘æ˜¯åž‚ç›´æ–¹å‘çš„ï¼Œæ‰€ä»¥åœ¨å¯¹å­å…ƒç´ è¿›è¡ŒéåŽ†ä¹‹å‰ï¼Œå…ˆå¯¹è‡ªèº«çš„é¡¶éƒ¨çš„ä½ç½®è¿›è¡Œè®¡ç®—ï¼Œç„¶åŽå†ä¾æ¬¡éåŽ†å­å…ƒç´ ï¼Œå¹¶å¯¹é¡¶éƒ¨çš„é«˜åº¦ä¸æ–­å åŠ ï¼Œæœ€åŽè°ƒç”¨ setChildFrame() æ–¹æ³•: private void setChildFrame(View child, int left, int top, int width, int height) { child.layout(left, top, left + width, top + height); } è¿™æ ·å°±å®Œæˆäº†å¯¹æ•´ä¸ª View æ ‘çš„ layout() æ–¹æ³•çš„è°ƒç”¨ã€‚ 4ã€draw()View çš„ draw() æ–¹æ³•å®žçŽ°çš„é€»è¾‘ä¹Ÿå¾ˆæ¸…æ™°ã€‚åœ¨ç»˜åˆ¶çš„è¿‡ç¨‹ä¼šæŒ‰ç…§å¦‚ä¸‹çš„æ­¥éª¤è¿›è¡Œï¼š ç»˜åˆ¶èƒŒæ™¯ ä¿å­˜ canvas ç»˜åˆ¶è‡ªèº«çš„å†…å®¹ ç»˜åˆ¶å­æŽ§ä»¶ ç»˜åˆ¶ View çš„è¤ªè‰²è¾¹ç¼˜ï¼Œæ¯”å¦‚é˜´å½±æ•ˆæžœä¹‹ç±»çš„ ç»˜åˆ¶è£…é¥°ï¼Œæ¯”å¦‚æ»šåŠ¨æ¡ä¹‹ç±»çš„ View ä¸­æä¾›äº† onDraw() æ–¹æ³•ç”¨æ¥å®Œæˆå¯¹è‡ªèº«çš„å†…å®¹çš„ç»˜åˆ¶ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ View çš„æ—¶å€™åªè¦é‡å†™è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥äº†ã€‚å½“æˆ‘ä»¬è¦è‡ªå®šä¹‰ä¸€ä¸ª ViewGroup ç±»åž‹çš„æŽ§ä»¶çš„æ—¶å€™ï¼Œä¸€èˆ¬æ˜¯ä¸éœ€è¦é‡å†™ onDraw() æ–¹æ³•çš„ï¼Œå› ä¸ºå®ƒåªéœ€è¦éåŽ†å­æŽ§ä»¶å¹¶ä¾æ¬¡è°ƒç”¨å®ƒä»¬çš„ draw() æ–¹æ³•å°±å¯ä»¥äº†ã€‚ï¼ˆå½“ç„¶ï¼Œå¦‚æžœéžè¦å®žçŽ°çš„è¯ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ï¼‰ ä¸‹é¢æ˜¯è¿™éƒ¨åˆ†ä»£ç ï¼Œä»£ç çš„æ³¨é‡Šä¸­ä¹Ÿè¯¦ç»†æ³¨é‡Šäº†æ¯ä¸ªæ­¥éª¤çš„é€»è¾‘ï¼š public void draw(Canvas canvas) { final int privateFlags = mPrivateFlags; final boolean dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp; (mAttachInfo == null || !mAttachInfo.mIgnoreDirtyState); mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN; // Step 1, draw the background, if needed int saveCount; if (!dirtyOpaque) { drawBackground(canvas); } // skip step 2 &amp; 5 if possible (common case) final int viewFlags = mViewFlags; boolean horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != 0; boolean verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != 0; if (!verticalEdges &amp;&amp; !horizontalEdges) { // Step 3, draw the content if (!dirtyOpaque) onDraw(canvas); // Step 4, draw the children dispatchDraw(canvas); drawAutofilledHighlight(canvas); // Overlay is part of the content and draws beneath Foreground if (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) { mOverlay.getOverlayView().dispatchDraw(canvas); } // Step 6, draw decorations (foreground, scrollbars) onDrawForeground(canvas); // Step 7, draw the default focus highlight drawDefaultFocusHighlight(canvas); if (debugDraw()) { debugDrawFocus(canvas); } // we&apos;re done... return; } // ... } æ³¨æ„åˆ°åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­ä¼šè°ƒç”¨ dispatchDraw(canvas) æ–¹æ³•æ¥åˆ†å‘ç»˜åˆ¶äº‹ä»¶ç»™å­æŽ§ä»¶æ¥å®Œæˆæ•´ä¸ª View æ ‘çš„ç»˜åˆ¶ã€‚åœ¨ View ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªç©ºçš„æ–¹æ³•ï¼ŒViewGroup è¦†å†™äº†è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶åœ¨å…¶ä¸­è°ƒç”¨ drawChild() æ¥å®Œæˆå¯¹æŒ‡å®šçš„ View çš„ draw() æ–¹æ³•çš„è°ƒç”¨ï¼š protected boolean drawChild(Canvas canvas, View child, long drawingTime) { return child.draw(canvas, this, drawingTime); } è€Œå¯¹äºŽ LinearLayout è¿™æ ·æœ¬èº«æ²¡æœ‰ç»˜åˆ¶éœ€æ±‚çš„æŽ§ä»¶ï¼Œæ²¡æœ‰è¦†å†™ onDraw() å’Œ dispatchDraw(canvas) ç­‰æ–¹æ³•ï¼Œå› ä¸º View å’Œ ViewGroup ä¸­æä¾›çš„åŠŸèƒ½å·²ç»è¶³å¤Ÿä½¿ç”¨ã€‚ æ€»ç»“ï¼šä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†åœ¨ Android ç³»ç»Ÿä¸­æ•´ä¸ª View æ ‘çš„å·¥ä½œçš„æµç¨‹ï¼Œä»Ž DecorView è¢«åŠ è½½åˆ°çª—å£ä¸­ï¼Œåˆ°æµ‹é‡ã€å¸ƒå±€å’Œç»˜åˆ¶ä¸‰ä¸ªæ–¹æ³•çš„å®žçŽ°ã€‚æœ¬è´¨ä¸Šæ•´ä¸ªå·¥ä½œçš„æµç¨‹å°±æ˜¯å¯¹ View æ ‘çš„ä¸€ä¸ªæ·±åº¦ä¼˜å…ˆçš„éåŽ†è¿‡ç¨‹ã€‚]]></content>
      <categories>
        <category>AndroidæŽ§ä»¶è¯¦è§£</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>æºç é˜…è¯»</tag>
        <tag>æŽ§ä»¶ä½“ç³»</tag>
      </tags>
  </entry>
</search>
